/*
 License: Web Enabled Audio and Sound Enhancement Library (aka the Weasel audio library) Copyright 2011 - 2013 Warren Willmey. It is covered by the GNU General Public License version 3 as published by the Free Software Foundation, you should have received a copy of the GNU General Public License along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
var weasel=weasel||{};weasel.LibraryVersionMajor=1;weasel.LibraryVersionMinor=9;weasel.LibraryVersionMaintenance=1;weasel.LibraryVersionNumber=weasel.LibraryVersionMajor+"."+weasel.LibraryVersionMinor+"."+weasel.LibraryVersionMaintenance;
weasel.FormatUltimateSoundTracker121={Title:0,MaxTitleLength:20,SampleHeaders:20,SongLength:470,SongSpeed:471,PatternSequenceTable:472,PatternData:600,SampleHeader:{SampleName:0,MaxNameLength:22,LengthInWords:22,Volume:24,RepeatOffsetInBytes:26,RepeatLengthInWords:28,HeaderSize:30},Channel:{Note:0,InstrumentNumber:2,Effect:2,EffectParameters:3,EffectMask:15,InstrumentNumberMask:240,InstrumentNumberShiftBitsRight:4},Effects:{None:0,Arpeggio:1,Pitchbend:2},MinimumHeaderSize:1624,MaxSampleSize:9999,
SequenceTableLength:128,MaxUniquePatterns:64,PatternSize:1024,NumberOfRowsPerPattern:64,NumberOfChannels:4,NumberOfInstruments:15,ModuleHeaderSize:600,BytesPerRowCell:4,TicksPerRow:6,Octaves:3,NotesPerOctave:12,TotalNotes:36,ClockConstantNTSC:3579545,ClockConstantPAL:3546895,WaitForDMAToStop:0.768,NoteTable:{856:"C-1",808:"C#1",762:"D-1",720:"D#1",678:"E-1",640:"F-1",604:"F#1",570:"G-1",538:"G#1",508:"A-1",480:"A#1",453:"B-1",428:"C-2",404:"C#2",381:"D-2",360:"D#2",339:"E-2",320:"F-2",302:"F#2",285:"G-2",
269:"G#2",254:"A-2",240:"A#2",226:"B-2",214:"C-3",202:"C#3",190:"D-3",180:"D#3",170:"E-3",160:"F-3",151:"F#3",143:"G-3",135:"G#3",127:"A-3",120:"A#3",113:"B-3"},PeriodTable:[856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113,0,25389,12576,25379,12576,25645,12576,25635,12576,25901,12576,26157,12576,26147,12576]};void 0==window.weasel&&(window.weasel={});
weasel.FormatDOCSoundTracker9={Effects:{Arpeggio:0,PitchbendUp:1,PitchbendDown:2,Volume:12,Filter:14,TickSpeed:15},MaxNotePeriod:113,MinNotePeriod:856,MaxSampleSize:32768};void 0==window.weasel&&(window.weasel={});weasel.FormatDOCSoundTracker22={Effects:{SequencePositionJump:11,PatternBreak:13}};void 0==window.weasel&&(window.weasel={});
weasel.FormatTJCSoundTracker2={Effects:{Arpeggio:0,PitchbendUp:1,PitchbendDown:2,ModulateVolume:3,ModulatePeriod:4,ModulateVolumePeriod:5,ModulateVolumePitchbendUp:6,ModulatePeriodPitchbendUp:7,ModulateVolumePeriodPitchbendUp:8,ModulateVolumePitchbendDown:9,ModulatePeriodPitchbendDown:10,ModulateVolumePeriodPitchbendDown:11,Volume:12,SlideVolume:13,AutoSlide:14},MaxNotePeriod:113,MinNotePeriod:856,MaxSampleSize:32768};void 0==window.weasel&&(window.weasel={});weasel.FormatDefJamSoundTracker3={Effects:{TickSpeed:15}};
void 0==window.weasel&&(window.weasel={});weasel.FormatSpreadpointSoundTracker23={Effects:{VolumeSlide:10},MKFingerPrint:1080,SongLength:950,SongSpeed:951,PatternSequenceTable:952,PatternData:1084,MinimumHeaderSize:2108,NumberOfInstruments:31,ModuleHeaderSize:1084,MaxSampleSize:32768};void 0==window.weasel&&(window.weasel={});
weasel.FormatNoiseTracker11={Effects:{TonePortamento:3,Vibrato:4},SongRestartPosition:951,VibratoTable:[0,24,49,74,97,120,141,161,180,197,212,224,235,244,250,253,255,253,250,244,235,224,212,197,180,161,141,120,97,74,49,24],WaitForDMAToStop:0.625};void 0==window.weasel&&(window.weasel={});weasel.FormatSpreadpointSoundTracker25={MaxSampleSize:65536};void 0==window.weasel&&(window.weasel={});weasel.FormatNoiseTracker20={Effects:{TonePortamentoAndVolumeSlide:5,VibratoAndVolumeSlide:6}};
void 0==window.weasel&&(window.weasel={});
weasel.FormatProTrackerMK={Effects:{Tremolo:7,SetSampleOffset:9,ExtendedCommands:14,Filter:0,FineSlideUp:16,FineSlideDown:32,GlissandoControl:48,SetVibratoWaveform:64,SetFineTune:80,PatternLoop:96,SetTremoloWaveform:112,RetriggerNote:144,FineVolumeSlideUp:160,FineVolumeSlideDown:176,NoteCut:192,NoteDelay:208,PatternDelay:224,InvertLoop:240},ProtrackerMarker:951,MaxSampleSize:131070,FineTunePeriodTables:[856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,
214,202,190,180,170,160,151,143,135,127,120,113,0,850,802,757,715,674,637,601,567,535,505,477,450,425,401,379,357,337,318,300,284,268,253,239,225,213,201,189,179,169,159,150,142,134,126,119,113,0,844,796,752,709,670,632,597,563,532,502,474,447,422,398,376,355,335,316,298,282,266,251,237,224,211,199,188,177,167,158,149,141,133,125,118,112,0,838,791,746,704,665,628,592,559,528,498,470,444,419,395,373,352,332,314,296,280,264,249,235,222,209,198,187,176,166,157,148,140,132,125,118,111,0,832,785,741,699,
660,623,588,555,524,495,467,441,416,392,370,350,330,312,294,278,262,247,233,220,208,196,185,175,165,156,147,139,131,124,117,110,0,826,779,736,694,655,619,584,551,520,491,463,437,413,390,368,347,328,309,292,276,260,245,232,219,206,195,184,174,164,155,146,138,130,123,116,109,0,820,774,730,689,651,614,580,547,516,487,460,434,410,387,365,345,325,307,290,274,258,244,230,217,205,193,183,172,163,154,145,137,129,122,115,109,0,814,768,725,684,646,610,575,543,513,484,457,431,407,384,363,342,323,305,288,272,
256,242,228,216,204,192,181,171,161,152,144,136,128,121,114,108,0,907,856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,0,900,850,802,757,715,675,636,601,567,535,505,477,450,425,401,379,357,337,318,300,284,268,253,238,225,212,200,189,179,169,159,150,142,134,126,119,0,894,844,796,752,709,670,632,597,563,532,502,474,447,422,398,376,355,335,316,298,282,266,251,237,223,211,199,188,177,167,158,149,141,133,125,118,
0,887,838,791,746,704,665,628,592,559,528,498,470,444,419,395,373,352,332,314,296,280,264,249,235,222,209,198,187,176,166,157,148,140,132,125,118,0,881,832,785,741,699,660,623,588,555,524,494,467,441,416,392,370,350,330,312,294,278,262,247,233,220,208,196,185,175,165,156,147,139,131,123,117,0,875,826,779,736,694,655,619,584,551,520,491,463,437,413,390,368,347,328,309,292,276,260,245,232,219,206,195,184,174,164,155,146,138,130,123,116,0,868,820,774,730,689,651,614,580,547,516,487,460,434,410,387,365,
345,325,307,290,274,258,244,230,217,205,193,183,172,163,154,145,137,129,122,115,0,862,814,768,725,684,646,610,575,543,513,484,457,431,407,384,363,342,323,305,288,272,256,242,228,216,203,192,181,171,161,152,144,136,128,121,114,0,774,1800,2314,3087,4113,4627,5400,6426,6940,7713,8739,9253,24625,12851],InvertSampleLoop:[0,5,6,7,8,10,11,13,16,19,22,26,32,43,64,128]};void 0==window.weasel&&(window.weasel={});
weasel.FormatFSTModule={Effects:{Panning:8,ExtendedCommands:14,CoarsePanning:128},MinimumHeaderSize:1596,FSTPeriodTable:[6848,6464,6096,5760,5424,5120,4832,4560,4304,4064,3840,3624,3424,3232,3048,2880,2712,2560,2416,2280,2152,2032,1920,1812,1712,1616,1524,1440,1356,1280,1208,1140,1076,1016,960,906,856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113,107,101,95,90,85,80,75,71,67,63,60,56,53,50,47,45,42,40,37,
35,33,31,30,28],NoteTable:{6848:"C-0",6464:"C#0",6096:"D-0",5760:"D#0",5424:"E-0",5120:"F-0",4832:"F#0",4560:"G-0",4304:"G#0",4064:"A-0",3840:"A#0",3624:"B-0",3424:"C-1",3232:"C#1",3048:"D-1",2880:"D#1",2712:"E-1",2560:"F-1",2416:"F#1",2280:"G-1",2152:"G#1",2032:"A-1",1920:"A#1",1812:"B-1",1712:"C-2",1616:"C#2",1524:"D-2",1440:"D#2",1356:"E-2",1280:"F-2",1208:"F#2",1140:"G-2",1076:"G#2",1016:"A-2",960:"A#2",907:"B-2",856:"C-3",808:"C#3",762:"D-3",720:"D#3",678:"E-3",640:"F-3",604:"F#3",570:"G-3",
538:"G#3",508:"A-3",480:"A#3",453:"B-3",428:"C-4",404:"C#4",381:"D-4",360:"D#4",339:"E-4",320:"F-4",302:"F#4",285:"G-4",269:"G#4",254:"A-4",240:"A#4",226:"B-4",214:"C-5",202:"C#5",190:"D-5",180:"D#5",170:"E-5",160:"F-5",151:"F#5",143:"G-5",135:"G#5",127:"A-5",120:"A#5",113:"B-5",107:"C-6",101:"C#6",95:"D-6",90:"D#6",85:"E-6",80:"F-6",75:"F#6",71:"G-6",67:"G#6",63:"A-6",60:"A#6",56:"B-6",53:"C-7",50:"C#7",47:"D-7",45:"D#7",42:"E-7",40:"F-7",37:"F#7",35:"G-7",33:"G#7",31:"A-7",30:"A#7",28:"B-7"}};
void 0==window.weasel&&(window.weasel={});weasel.Helper={};weasel.Helper.getByte=function(a,b){if(!(a instanceof Array||a instanceof Uint8Array))throw"Wrong data type";if(b<0||b>=a.length)throw"Index out of range: Data Size = "+a.length+", Index = "+b;return a[b]&255};weasel.Helper.getWord=function(a,b){return weasel.Helper.getByte(a,b)<<8|weasel.Helper.getByte(a,b+1)};weasel.Helper.getLong=function(a,b){return weasel.Helper.getWord(a,b)<<16|weasel.Helper.getWord(a,b+2)};
weasel.Helper.convertStringToArray=function(a){if("string"!==typeof a)throw"Wrong data type";for(var b=weasel.Helper.getUnsignedByteArray(a.length),c=a.length,d=0;--c>=0;)b[d]=a.charCodeAt(d++)&255;return b};weasel.Helper.twosComplement=function(a){return a>=128?a-256:a};weasel.Helper.getNullTerminatedString=function(a,b,c){var d="";try{for(c=b+c;b<c;b++){var e=weasel.Helper.getByte(a,b);if(0==e)break;else d=e>=32&&e<127?d+String.fromCharCode(e):d+" "}}catch(f){}return d};
weasel.Helper._detectFloat32Array=function(){return window.Float32Array?true:false};weasel.Helper._bFloat32ArrayAvailable=weasel.Helper._detectFloat32Array();weasel.Helper.getFloat32Array=function(a){return weasel.Helper._bFloat32ArrayAvailable?new window.Float32Array(a):Array(a)};weasel.Helper._detectUint8Array=function(){return window.Uint8Array?true:false};weasel.Helper._bUint8ArrayAvailable=weasel.Helper._detectUint8Array();
weasel.Helper.getUnsignedByteArray=function(a){return weasel.Helper._bUint8ArrayAvailable?new window.Uint8Array(a):Array(a)};
weasel.Helper.easyPlay=function(a){if(void 0==a)return"** Error, parameter xModuleData data is missing.";var b=null;a instanceof Array||window.Uint8Array&&a instanceof window.Uint8Array?b=a:a instanceof Element&&typeof a=="object"&&a.innerHTML?b=weasel.Helper.base64Decode(a.innerHTML):typeof a=="string"&&(b=weasel.Helper.base64Decode(a));(a=weasel.Helper._detectJXGLibrary())&&(b=weasel.Helper.checkForCompression(b));if(null==b)return"Unable to extract Module data which needs to be in one of the following formats: a) Module in an Array (already in binary format). b) A DOM Element containing the Base64 encoded Module within its innerHTML. c) Module as a Base64 encoded string."+
(a?" The JXG decompression library has been found.":" The JXG decompression library has not been found.");a=new weasel.ModuleSniffer;a.sniff(b,false);if("ok"==a.getReason()){this.iEasyPlayIntervalMsRate=200;if(!this.oEasyPlayBrowserAudio){this.oEasyPlayBrowserAudio=new weasel.BrowserAudio(44100,this.iEasyPlayIntervalMsRate);this.oEasyPlayBrowserAudio.init();weasel.BrowserAudio.prototype.AudioType.HTML5Audio==this.oEasyPlayBrowserAudio.getAudioType()&&this.oEasyPlayBrowserAudio.changeReplayFrequency(16E3)}b=
a.createModule(b,this.oEasyPlayBrowserAudio.getPlaybackFrequency(),weasel.Sample.prototype.SampleScannerMode.Remove_IFF_Headers);this.oEasyPlayBrowserAudio.setModule(b);this.oEasyPlayBrowserAudio.setPreBufferingInMS(300);return this.oEasyPlayBrowserAudio}return a.getReason()};weasel.Helper._easyPlayFeed=function(){weasel.Helper.oEasyPlayBrowserAudio&&weasel.Helper.oEasyPlayBrowserAudio.feedAudio()};
weasel.Helper.easyStart=function(){if((void 0==this.iEasyPlayIntervalID||null==this.iEasyPlayIntervalID)&&this.iEasyPlayIntervalMsRate){this.iEasyPlayIntervalID=setInterval(weasel.Helper._easyPlayFeed,this.iEasyPlayIntervalMsRate);this.oEasyPlayBrowserAudio.start()}};weasel.Helper.easyStop=function(){if(this.iEasyPlayIntervalID&&this.iEasyPlayIntervalID!=null){clearInterval(this.iEasyPlayIntervalID);this.iEasyPlayIntervalID=null;this.oEasyPlayBrowserAudio.stop()}};
weasel.Helper._decodeChar=function(a){return a>=97?a-71:61==a?64:47==a?63:43==a?62:a<=57?4+a:a-65};
weasel.Helper.base64Decode=function(a){if(void 0==a||"string"!==typeof a)return[];var a=a.replace(/[^a-zA-Z0-9\+\/\=]/g,""),b=(a.length>>>2)*3;61==a.charCodeAt(a.length-2)?b=b-2:61==a.charCodeAt(a.length-1)&&b--;for(var b=weasel.Helper.getUnsignedByteArray(b),c=0,d=0,e=weasel.Helper._decodeChar,f=(a.length>>>2<<2)-4;d<f;){var g=e(a.charCodeAt(d++))<<18|e(a.charCodeAt(d++))<<12|e(a.charCodeAt(d++))<<6|e(a.charCodeAt(d++));b[c++]=g>>>16;b[c++]=g>>>8&255;b[c++]=g&255}var g=e(a.charCodeAt(d++)),h=e(a.charCodeAt(d++)),
f=e(a.charCodeAt(d++)),a=e(a.charCodeAt(d++)),g=g<<18|h<<12|f<<6|a;b[c++]=g>>>16;if(64!=f){b[c++]=g>>>8&255;64!=a&&(b[c++]=g&255)}return b};weasel.Helper._detectHighResolutionTimer=function(){return window.performance?window.performance.now?true:false:false};weasel.Helper._bHighResolutionTimerAvaiable=weasel.Helper._detectHighResolutionTimer();weasel.Helper.getHighRezTimer=function(){return weasel.Helper._bHighResolutionTimerAvaiable?window.performance.now():Date.now()};
weasel.Helper.searchArrayForString=function(a,b,c,d){var d=weasel.Helper.convertStringToArray(d),e=d.length;b<0&&(b=0);if(a.length<c)c=a.length;for(var f=d[0];b<c;b++)if(f==weasel.Helper.getByte(a,b)){for(var g=1,h=b+1;h<c&&g<e;h++,g++)if(d[g]!=weasel.Helper.getByte(a,h))break;if(g==e)return b}return-1};weasel.Helper._detectJXGLibrary=function(){return void 0!=window.JXG&&void 0!=window.JXG.Util&&void 0!=window.JXG.Util.Unzip?true:false};
weasel.Helper.checkForCompression=function(a){if(weasel.Helper._detectJXGLibrary())try{if(0==weasel.Helper.searchArrayForString(a,0,2,"\u001f\u008b")||0==weasel.Helper.searchArrayForString(a,0,4,"PK\u0003\u0004"))var b=new JXG.Util.Unzip(a),a=weasel.Helper.convertStringToArray(b.unzip()[0][0])}catch(c){}return a};void 0==window.weasel&&(window.weasel={});void 0==weasel.Helper&&(weasel.Helper={});weasel.Helper._MenuChangeInterpolation=function(a,b){a!=void 0&&b!=void 0&&a.setInterpolation(b)};
weasel.Helper._MenuUpdateInterpolation=function(a,b){if(a!=void 0&&b!=void 0){var c=a.getModule();if(c)b.selectedIndex=c.getChannel(0).getChannelInterpolation()}};weasel.Helper._MenuChangeMixer=function(a,b){a!=void 0&&b!=void 0&&a.getAudioBuffer().setMixerType(b)};weasel.Helper._MenuUpdateMixer=function(a,b){if(a!=void 0&&b!=void 0)b.selectedIndex=a.getAudioBuffer().getMixerType()};weasel.Helper._MenuChangeReplayFrequency=function(a,b){a!=void 0&&b!=void 0&&a.changeReplayFrequency(b)};
weasel.Helper._MenuUpdateReplayFrequency=function(a,b){if(a!=void 0&&b!=void 0)for(var c=a.getPlaybackFrequency(),d=b.children.length;--d>=0;)if(b.children[d].value==c){b.selectedIndex=b.children[d].index;break}};weasel.Helper._MenuChangeVolume=function(a,b,c){if(a!=void 0&&b!=void 0&&c!=void 0)if(a=a.getModule()){a.setMasterVolume(c);b.textContent=(a.getMasterVolume()*100|0)+"%"}};
weasel.Helper._MenuUpdateMasterVolume=function(a,b,c){if(a!=void 0&&b!=void 0&&c!=void 0)if(a=a.getModule()){a=a.getMasterVolume();b.textContent=(a*100|0)+"%";c.scrollLeft=a*500|0}};weasel.Helper._MenuChangePreBuffer=function(a,b,c){if(a!=void 0&&b!=void 0&&c!=void 0){c<a.getIntervalRate()&&(c=a.getIntervalRate());a.setPreBufferingInMS(c);b.textContent=(a.getPreBufferingInMS()|0)+"ms"}};
weasel.Helper._MenuUpdatePreBuffer=function(a,b,c,d){if(a!=void 0&&c!=void 0&&b!=void 0&&d!=void 0){var e=a.getPreBufferingInMS()|0;c.textContent=(a.getIntervalRate()|0)+"ms";b.textContent=e+"ms";d.scrollLeft=e}};weasel.Helper._MenuChangeLatency=function(a,b){a!=void 0&&b!=void 0&&a.tradeLowerLatencyForSpeed(b)};weasel.Helper._MenuChangeHTML5Fidelity=function(a,b){a!=void 0&&b!=void 0&&a.setHTML5LowFidelityMode(b)};
weasel.Helper._addEasyMenuCSSToPage=function(a){if(!a||!a.appendChild||!(a instanceof Element))return false;var b=document.createElement("style");b.type="text/css";b.id="weaselMenuCSS";b.innerHTML="ul.weaselMenu {\r\n\tpadding: 0px;\r\n\tmargin: 0px;\r\n}\r\nul.weaselMenu li {\r\n\tlist-style: none;\r\n\tborder: 2px solid;\r\n\tposition: absolute;\r\n\ttext-align:center;\r\n\tcolor: black;\r\n\tbackground: #adf;\r\n\tborder: 2px solid #3bd;\r\n\tpadding: 10px;\r\n\tborder-radius: 15px 15px; -moz-border-radius: 15px; -webkit-border-radius: 15px;\r\n\tbox-shadow: 15px 15px 15px rgba(0, 0, 0, 0.2); -webkit-box-shadow: 15px 15px rgba(0, 0, 0, 0.2); -moz-box-shadow: 15px 15px rgba(0, 0, 0, 0.2);\r\n\tfont-family: Calibri, Tahoma, Geneva, sans-serif;\r\n\tfont-size: small;\r\n\tposition: relative;\r\n\tz-index: 999;\r\n}\r\nul.weaselMenu ul {\r\n\tdisplay: none;\r\n\tpadding: 0px;\r\n\tposition: absolute;\r\n\tleft: 100%;\r\n\ttop: -2px;\r\n}\r\nul.weaselMenu ul ul {\r\n\tpadding: 0px;\r\n\tposition: absolute;\r\n\tleft: 100%;\r\n\ttop: -2px;\r\n}\r\nul.weaselMenu ul li {\r\n\tlist-style: none;\r\n\tposition: relative;\r\n}\r\nul.weaselMenu li:hover > ul {\r\n\tdisplay: block;\r\n}\r\nul.weaselMenu li:hover {\r\n\tbackground: #bef;\r\n\tcolor:red;\r\n}\r\ndiv.weaselScrollBar{\r\n\tfont-family: monospace;\r\n\tfont-size: 20px;\r\n\twidth:200px;\r\n\theight:1px;\r\n\tpadding-top:20px;\r\n\toverflow-y: hidden;\r\n\toverflow-x:scroll ;\r\n}\r\nspan.weaselInline {\r\n\tdisplay: inline-block;\r\n}";
a.appendChild(b);return true};
weasel.Helper._subMenuInterpolation=function(a,b){var c=document.createElement("li"),d=document.createElement("ul"),e=document.createElement("li"),f=document.createElement("select");f.id="weaselMenuInterpolation";f.onclick=function(){weasel.Helper._MenuChangeInterpolation(b,parseInt(this.value))};c.onmouseover=function(){weasel.Helper._MenuUpdateInterpolation(b,f)};var g=weasel.Channel.prototype.getSupportedInterpolationTypes(),h=0,i;for(i in g)if(g.hasOwnProperty(i)){var j=i.replace(/_/gi," ").replace(/\$/gi,
"-"),k=document.createElement("option");k.text=j;k.value=g[i];f.appendChild(k);h++}f.size=h;e.appendChild(f);d.appendChild(e);c.textContent="Interpolation";c.appendChild(d);a.appendChild(c)};
weasel.Helper._subMenuMasterVolume=function(a,b){var c=document.createElement("li"),d=document.createElement("ul"),e=document.createElement("li"),f=document.createElement("div");f.id="weaselMasterVolume";f.textContent="100%";var g=document.createElement("div");g.className="weaselScrollBar";g.id="weaselMenuVolumeScrollBar";g.title="Master volume.";g.innerHTML=Array(11).join("0123456789");g.onscroll=function(){weasel.Helper._MenuChangeVolume(b,f,parseInt(this.scrollLeft)/500)};e.appendChild(f);e.appendChild(g);
d.appendChild(e);c.onmouseover=function(){weasel.Helper._MenuUpdateMasterVolume(b,f,g)};c.textContent="Master Volume";c.appendChild(d);a.appendChild(c)};
weasel.Helper._subMenuMixer=function(a,b){var c=document.createElement("li"),d=document.createElement("ul"),e=document.createElement("li"),f=document.createElement("select");f.id="weaselMenuMixer";f.onclick=function(){weasel.Helper._MenuChangeMixer(b,parseInt(this.value))};c.onmouseover=function(){weasel.Helper._MenuUpdateMixer(b,f)};var g=weasel.AudioBuffer.prototype.getSupportedMixerTypes(),h=0,i;for(i in g)if(g.hasOwnProperty(i)){var j=i.replace(/_/gi," ").replace(/\$/gi,"-"),k=document.createElement("option");
k.text=j;k.value=g[i];f.appendChild(k);h++}f.size=h;e.appendChild(f);d.appendChild(e);c.textContent="Mixer";c.appendChild(d);a.appendChild(c)};
weasel.Helper._subMenuReplayFrequency=function(a,b){var c=document.createElement("li"),d=document.createElement("ul"),e=document.createElement("li"),f=document.createElement("select");f.size=9;f.id="weaselMenuReplayFrequency";f.onclick=function(){weasel.Helper._MenuChangeReplayFrequency(b,parseInt(this.value))};c.onmouseover=function(){weasel.Helper._MenuUpdateReplayFrequency(b,f)};var g={11025:"11Khz",16E3:"16Khz",22050:"22Khz",24E3:"24Khz",32E3:"32Khz",44100:"44.1Khz (CD quality)",48E3:"48Khz (DAT - Digital Audio Tape)",
96E3:"96Khz",192E3:"192Khz"},h;for(h in g)if(g.hasOwnProperty(h)){var i=document.createElement("option");i.value=parseInt(h);i.text=g[h];f.appendChild(i)}e.appendChild(f);if(weasel.BrowserAudio.prototype.AudioType.Mozilla==b.getAudioType()){g=document.createElement("input");g.type="checkbox";g.checked=!b.getTradeLowerLatencyForSpeed();g.id="weaselMenuTradeLatencyForSpeed";g.title="On some audio subsystems (Firefox) use a audio buffer the size of a single interval in order to reduce the number of write calls to the browser audio api. This has the disadvantage of poor latency response (because the audio buffer always has to be full before passing to the browser, when we might actually need slightly more or slightly less), but is quicker.";
g.onclick=function(){weasel.Helper._MenuChangeLatency(b,!this.checked)};h=document.createElement("label");h.htmlFor="weaselMenuTradeLatencyForSpeed";h.textContent=":Trade latency for speed.";e.appendChild(g);e.appendChild(h)}if(weasel.BrowserAudio.prototype.AudioType.HTML5Audio==b.getAudioType()){g=document.createElement("input");g.type="checkbox";g.checked=b.getHTML5LowFidelityMode();g.id="weaselMenuHTML5LowFidelityMode";g.title="HTML5 Audio does not support the playback of audio created by JavaScript, so it is dummied by create a new DataURI every 2 seconds. Unfortunately this is extremely slow and causes the browser to slightly pause. Low fidelity mode generates 4 times less data, causing less or no pause by using mono 8-bit audio instead of 16-bit stereo.";
g.onclick=function(){weasel.Helper._MenuChangeHTML5Fidelity(b,this.checked)};h=document.createElement("label");h.htmlFor="weaselMenuHTML5LowFidelityMode";h.textContent=":HTML5 low fidelity mode.";e.appendChild(g);e.appendChild(h)}d.appendChild(e);c.innerHTML="Replay&nbsp;Frequency";c.appendChild(d);a.appendChild(c)};
weasel.Helper._subMenuPreBuffering=function(a,b){var c=document.createElement("li"),d=document.createElement("ul"),e=document.createElement("li"),f=document.createElement("div");f.textContent="Set Interval Rate: ";f.title="The interval rate at which audio is approximately updated in milliseconds.";var g=document.createElement("span");g.id="weaselIntervalRate";g.className="weaselInline";g.textContent="0ms";f.appendChild(g);var h=document.createElement("div");h.textContent="Audio Buffer size: ";h.title=
"The wanted amount of audio pre-buffering in milliseconds, a higher value reduces the chances of audio pops and glitches but increases the latency before you hear the audio.";var i=document.createElement("span");i.id="weaselPreBuffering";i.textContent="0ms";h.appendChild(i);var j=document.createElement("div");j.className="weaselScrollBar";j.id="weaselMenuLatencyScrollBar";j.title="The wanted amount of audio pre-buffering in milliseconds, a higher value reduces the chances of audio pops and glitches but increases the latency before you hear the audio.";
j.innerHTML=Array(11).join("0123456789");j.onscroll=function(){weasel.Helper._MenuChangePreBuffer(b,i,parseInt(this.scrollLeft))};e.appendChild(f);e.appendChild(h);e.appendChild(j);d.appendChild(e);c.onmouseover=function(){weasel.Helper._MenuUpdatePreBuffer(b,i,g,j)};c.textContent="Pre-Buffering";c.appendChild(d);a.appendChild(c)};
weasel.Helper._subMenuAbout=function(a){var b=document.createElement("li"),c=document.createElement("ul"),d=document.createElement("li"),e=document.createElement("div");e.id="weaselMenuAbout";e.innerHTML="W.e.a.s.e.l.&nbsp;audio&nbsp;library.<br />Version&nbsp;"+weasel.LibraryVersionNumber+"<br />by<br />Warren&nbsp;Willmey. <br /><br />WeaselAudioLib.SourceForge.Net<br />License&nbsp;type: GPL&nbsp;Version&nbsp;3.";d.appendChild(e);c.appendChild(d);b.textContent="About";b.appendChild(c);a.appendChild(b)};
weasel.Helper.addEasyMenu=function(a,b){if(!(void 0==b||void 0==a||!(b instanceof Element)||!(a instanceof weasel.BrowserAudio))){null==document.getElementById("weaselMenuCSS")&&weasel.Helper._addEasyMenuCSSToPage(document.getElementsByTagName("head")[0]);if(null==document.getElementById("weaselMenu")){var c=document.createDocumentFragment(),d=document.createElement("ul"),e=document.createElement("li");e.textContent="Audio Settings";var f=document.createElement("ul");weasel.Helper._subMenuInterpolation(f,
a);weasel.Helper._subMenuMasterVolume(f,a);weasel.Helper._subMenuMixer(f,a);weasel.Helper._subMenuReplayFrequency(f,a);weasel.Helper._subMenuPreBuffering(f,a);weasel.Helper._subMenuAbout(f);e.appendChild(f);d.className="weaselMenu";d.id="weaselMenu";d.appendChild(e);c.appendChild(d);b.appendChild(c)}}};void 0==window.weasel&&(window.weasel={});
weasel.Base64Stream=function(){this.sBase64Stream="";this.iBytesIn=this.iBitStream=this.iBitCount=0;this.sBase64StreamSaved="";this.iBytesInSaved=this.iBitStreamSaved=this.iBitCountSaved=0};weasel.Base64Stream.prototype.aBase64Tokens="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("");
weasel.Base64Stream.prototype.__convertBitStream=function(){for(;this.iBitCount>=6;){this.sBase64Stream=this.sBase64Stream+this.aBase64Tokens[this.iBitStream>>>this.iBitCount-6&63];this.iBitCount=this.iBitCount-6;this.iBitStream=this.iBitStream&2147483647>>>31-this.iBitCount}};weasel.Base64Stream.prototype.appendByte=function(a){this.iBitCount=this.iBitCount+8;this.iBitStream=this.iBitStream<<8|a;this.iBytesIn++;this.__convertBitStream()};
weasel.Base64Stream.prototype.appendWord=function(a){this.iBitCount=this.iBitCount+16;this.iBitStream=this.iBitStream<<16|a;this.iBytesIn=this.iBytesIn+2;this.__convertBitStream()};weasel.Base64Stream.prototype.appendTriple=function(a){this.iBitCount=this.iBitCount+24;this.iBitStream=this.iBitStream<<24|a;this.iBytesIn=this.iBytesIn+3;this.__convertBitStream()};
weasel.Base64Stream.prototype.flush=function(){this.__convertBitStream();if(0!=this.iBitCount){var a=6-this.iBitCount;this.iBitCount=this.iBitCount+a;this.iBitStream=this.iBitStream<<a;this.__convertBitStream()}if(1==this.iBytesIn%3)this.sBase64Stream=this.sBase64Stream+"==";else if(2==this.iBytesIn%3)this.sBase64Stream=this.sBase64Stream+"="};weasel.Base64Stream.prototype.getBase64EncodedString=function(){return this.sBase64Stream};
weasel.Base64Stream.prototype.prepend=function(a){this.sBase64Stream=a.concat(this.sBase64Stream)};weasel.Base64Stream.prototype.save=function(){this.sBase64StreamSaved=this.sBase64Stream;this.iBitCountSaved=this.iBitCount;this.iBitStreamSaved=this.iBitStream;this.iBytesInSaved=this.iBytesIn};weasel.Base64Stream.prototype.load=function(){this.sBase64Stream=this.sBase64StreamSaved;this.iBitCount=this.iBitCountSaved;this.iBitStream=this.iBitStreamSaved;this.iBytesIn=this.iBytesInSaved};
void 0==window.weasel&&(window.weasel={});
weasel.AudioBuffer=function(a,b,c){this.iPlaybackFrequency=a;this.iSoundChannels=b;this.aBuffer=weasel.Helper.getFloat32Array(c*b);this.aCircularAudioBuffer=weasel.Helper.getFloat32Array(a*b);this.iBufferSizeInSamples=this.aBuffer.length/b|0;this.iBufferNotFullOffset=this.lWrittenSamples=0;this.bIgnoreCircularBuffer=true;this.clearAudioBuffers();this.iCircularBufferPosition=0;this.iMixerType=1;this.fPanningLawDB=-4.5;this.fPeakRight=this.fPeakLeft=0;this.fAutoGain=0.3;this.bPreviousFilterState=false;
this.aFilterBufferLeft=weasel.Helper.getFloat32Array(128);this.aFilterBufferRight=weasel.Helper.getFloat32Array(128);this.iFilterBufferPosition=0;a=this.aFilterBufferLeft.length;b=this.aFilterBufferLeft;for(c=this.aFilterBufferRight;--a>=0;){b[a]=0;c[a]=0}};weasel.AudioBuffer.prototype.SupportedMixerTypes={Linear:0,RLM$D_Fat:1};weasel.AudioBuffer.prototype.getSupportedMixerTypes=function(){return weasel.AudioBuffer.prototype.SupportedMixerTypes};weasel.AudioBuffer.prototype.getWrittenSamples=function(){return this.lWrittenSamples};
weasel.AudioBuffer.prototype.getSoundChannels=function(){return this.iSoundChannels};weasel.AudioBuffer.prototype.getMixerType=function(){return this.iMixerType};weasel.AudioBuffer.prototype.setMixerType=function(a){a!=1&&(a=0);this.iMixerType=a};weasel.AudioBuffer.prototype.setIgnoreCircularBuffer=function(a){this.bIgnoreCircularBuffer=a==true?true:false};weasel.AudioBuffer.prototype.getIgnoreCircularBuffer=function(){return this.bIgnoreCircularBuffer};
weasel.AudioBuffer.prototype.clearAudioBuffers=function(){for(var a=this.aBuffer.length,b=this.aBuffer;--a>=0;)b[a]=0;a=this.aCircularAudioBuffer.length;for(b=this.aCircularAudioBuffer;--a>=0;)b[a]=0};
weasel.AudioBuffer.prototype.removeSamples=function(a){if(0!=a){var b=0,c=this.getBufferLengthInSamples();a>c&&(a=c);if(!this.bIgnoreCircularBuffer){for(var d=this.iCircularBufferPosition,e=this.aBuffer,f=this.aCircularAudioBuffer,g=a*this.iSoundChannels,h=0,i=f.length;g>0;){for(var j=d+g>i?i-d:g,g=g-j,k=j&3;--k>=0;)f[d++]=e[h++];for(k=j>>>2;--k>=0;){f[d++]=e[h++];f[d++]=e[h++];f[d++]=e[h++];f[d++]=e[h++]}d=d%i}this.iCircularBufferPosition=d}g=(c-a-this.samplesToFill())*this.iSoundChannels;h=a*this.iSoundChannels;
for(c=this.aBuffer;g>0;){for(k=g&3;--k>=0;)c[b++]=c[h++];for(k=g>>>2;--k>=0;){c[b++]=c[h++];c[b++]=c[h++];c[b++]=c[h++];c[b++]=c[h++]}g=g-g}this.iBufferNotFullOffset=b;this.lWrittenSamples=this.lWrittenSamples+a}};weasel.AudioBuffer.prototype.getBufferLengthInSamples=function(){return this.iBufferSizeInSamples};weasel.AudioBuffer.prototype.getBuffer=function(){return this.aBuffer};weasel.AudioBuffer.prototype.getBufferPosition=function(){return this.iBufferNotFullOffset};
weasel.AudioBuffer.prototype.samplesToFill=function(){return this.getBufferLengthInSamples()-(this.iBufferNotFullOffset/this.iSoundChannels|0)};weasel.AudioBuffer.prototype.appendSampleToBuffer=function(a){if(this.iBufferNotFullOffset<this.aBuffer.length)this.aBuffer[this.iBufferNotFullOffset++]=a;else throw"Audio Buffer is already full, sample is ignored.( Buffer Length: "+this.aBuffer.length+", Buffer offset: "+this.iBufferNotFullOffset+").";};
weasel.AudioBuffer.prototype.getCircularAudioBuffer=function(){return this.aCircularAudioBuffer};weasel.AudioBuffer.prototype.getCircularBufferPosition=function(){return this.iCircularBufferPosition};
weasel.AudioBuffer.prototype._companderRLMDFat=function(a,b,c,d,e,f){for(var g=this.iBufferNotFullOffset,h=b.length,i=this.getBuffer();a>0;){for(var j=f+a>h?h-f:a,a=a-j;--j>=0;){var k=(b[f]+e[f])*0.5,l=(c[f]+d[f++])*0.5;i[g++]=k<0?-1+(1+k)*(1+k):1-(1-k)*(1-k);i[g++]=l<0?-1+(1+l)*(1+l):1-(1-l)*(1-l)}f=f%h}this.iBufferNotFullOffset=g};
weasel.AudioBuffer.prototype._mixLinear=function(a,b,c,d,e,f){for(var g=this.iBufferNotFullOffset,h=b.length,i=this.getBuffer();a>0;){for(var j=f+a>h?h-f:a,a=a-j;--j>=0;){var k=(b[f]+e[f])*0.5,l=(c[f]+d[f++])*0.5;i[g++]=k<-1?-1:k>1?1:k;i[g++]=l<-1?-1:l>1?1:l}f=f%h}this.iBufferNotFullOffset=g};
weasel.AudioBuffer.prototype._mixLinearFiltered=function(a,b,c,d,e,f){var g=this.iBufferNotFullOffset,h=this.iFilterBufferPosition,i=Math.ceil(this.iPlaybackFrequency/7E3);i<2&&(i=2);if(!this.bPreviousFilterState){this.bPreviousFilterState=true;this._updateFilterHistory(i)}for(var j=1/i,k=0,l=0,m=1;m<=i;m++)var n=h-m&127,k=k+this.aFilterBufferLeft[n],l=l+this.aFilterBufferRight[n];for(var m=b.length,n=this.getBuffer(),o=this.aFilterBufferLeft,q=this.aFilterBufferRight;a>0;){for(var u=f+a>m?m-f:a,
a=a-u;--u>=0;){var p=(b[f]+e[f])*0.5,r=(c[f]+d[f++])*0.5;o[h]=p;q[h]=r;k=k+(p-o[h-i&127]);l=l+(r-q[h-i&127]);h=++h&127;p=k*j;r=l*j;n[g++]=p<-1?-1:p>1?1:p;n[g++]=r<-1?-1:r>1?1:r}f=f%m}this.iBufferNotFullOffset=g;this.iFilterBufferPosition=h};
weasel.AudioBuffer.prototype._companderRLMDFatFiltered=function(a,b,c,d,e,f){var g=this.iBufferNotFullOffset,h=this.iFilterBufferPosition,i=Math.ceil(this.iPlaybackFrequency/7E3);i<2&&(i=2);if(!this.bPreviousFilterState){this.bPreviousFilterState=true;this._updateFilterHistory(i)}for(var j=1/i,k=0,l=0,m=1;m<=i;m++)var n=h-m&127,k=k+this.aFilterBufferLeft[n],l=l+this.aFilterBufferRight[n];for(var m=b.length,n=this.getBuffer(),o=this.aFilterBufferLeft,q=this.aFilterBufferRight;a>0;){for(var u=f+a>m?
m-f:a,a=a-u;--u>=0;){var p=(b[f]+e[f])*0.5,r=(c[f]+d[f++])*0.5;o[h]=p;q[h]=r;k=k+(p-o[h-i&127]);l=l+(r-q[h-i&127]);h=++h&127;p=k*j;r=l*j;n[g++]=p<0?-1+(1+p)*(1+p):1-(1-p)*(1-p);n[g++]=r<0?-1+(1+r)*(1+r):1-(1-r)*(1-r)}f=f%m}this.iBufferNotFullOffset=g;this.iFilterBufferPosition=h};
weasel.AudioBuffer.prototype._updateFilterHistory=function(a){for(var b=this.getBuffer(),c=(this.iBufferNotFullOffset-a*this.iSoundChannels+b.length)%b.length,d=this.iFilterBufferPosition-a&127,e=1;e<=a;e++){this.aFilterBufferLeft[d]=b[c++];this.aFilterBufferRight[d++]=b[c++];d=d&127;c=c%b.length}};
weasel.AudioBuffer.prototype.mix=function(a,b,c,d,e,f,g){if(0==this.getMixerType())if(g)this._mixLinearFiltered(a,b,c,d,e,f);else{this._mixLinear(a,b,c,d,e,f);this.bPreviousFilterState=false}else if(g)this._companderRLMDFatFiltered(a,b,c,d,e,f);else{this._companderRLMDFat(a,b,c,d,e,f);this.bPreviousFilterState=false}};weasel.AudioBuffer.prototype._decibelToLinear=function(a){return Math.pow(10,a/20)};
weasel.AudioBuffer.prototype.panningLawLeft=function(a){if(a>=1)return 0;if(a<=-1)return 1;var b=a,c=1;if(a>0){b=0;c=c-a}return this._decibelToLinear(this.fPanningLawDB*(1+b))*c};weasel.AudioBuffer.prototype.panningLawRight=function(a){if(a<=-1)return 0;if(a>=1)return 1;var b=a,c=1;if(a<0){b=0;c=c+a}return this._decibelToLinear(this.fPanningLawDB*(1-b))*c};weasel.AudioBuffer.prototype.panningFT2Left=function(a){return a>=1?0:a<=-1?1:1+Math.log((1.1-a*0.9)*0.5)/Math.LN10};
weasel.AudioBuffer.prototype.panningFT2Right=function(a){return a<=-1?0:a>=1?1:1+Math.log((a*0.9+1.1)*0.5)/Math.LN10};weasel.AudioBuffer.prototype.mixIn=function(a,b,c,d){for(var e=(d-128)/128,d=this.panningFT2Left(e)*this.fAutoGain,e=this.panningFT2Right(e)*this.fAutoGain,f=b.length,g=this.getBuffer(),h=this.iBufferNotFullOffset;a>0;){for(var i=c+a>f?f-c:a,a=a-i;--i>=0;){var j=b[c++];g[h++]+=j*d;g[h++]+=j*e}c=c%f}};
weasel.AudioBuffer.prototype.clear=function(a){for(var b=this.iBufferNotFullOffset,c=this.getBuffer();a>0;a--){c[b++]=0;c[b++]=0}};weasel.AudioBuffer.prototype.clip=function(a){for(var b=this.iBufferNotFullOffset,c=0,d=0,e=this.getBuffer();a>0;a--){var f=e[b],g=Math.abs(f);g>c&&(c=g);e[b++]=f<-1?-1:f>1?1:f;f=e[b];g=Math.abs(f);g>d&&(d=g);e[b++]=f<-1?-1:f>1?1:f}this.iBufferNotFullOffset=b;this.fPeakLeft=c;this.fPeakRight=d};
weasel.AudioBuffer.prototype.clipRLMDFat=function(a){for(var b=this.iBufferNotFullOffset,c=0,d=0,e=this.getBuffer();a>0;a--){var f=e[b],g=Math.abs(f);g>c&&(c=g);f=f<-1?-1:f>1?1:f;e[b++]=f<0?-1+(1+f)*(1+f):1-(1-f)*(1-f);f=e[b];g=Math.abs(f);g>d&&(d=g);f=f<-1?-1:f>1?1:f;e[b++]=f<0?-1+(1+f)*(1+f):1-(1-f)*(1-f)}this.iBufferNotFullOffset=b;this.fPeakLeft=c;this.fPeakRight=d};void 0==window.weasel&&(window.weasel={});
weasel.PatternCell=function(a){this.iEffectParameterValue=this.iEffectNumber=this.iInstrumentNumber=this.iNotePeriod=0;this.setCell(a)};weasel.PatternCell.prototype.setCell=function(a){this.iNotePeriod=a>>>16&65535;this.iInstrumentNumber=a>>>12&15;this.iEffectNumber=a>>>8&15;this.iEffectParameterValue=a&255};weasel.PatternCell.prototype.getNotePeriod=function(){return this.iNotePeriod};weasel.PatternCell.prototype.getInstrumentNumber=function(){return this.iInstrumentNumber};
weasel.PatternCell.prototype.getEffectNumber=function(){return this.iEffectNumber};weasel.PatternCell.prototype.getEffectParameter=function(){return this.iEffectParameterValue};void 0==window.weasel&&(window.weasel={});weasel.MKPatternCell=function(a){this.parent=weasel.PatternCell;void 0!==a&&this.parent(a)};weasel.MKPatternCell.prototype=new weasel.PatternCell;
weasel.MKPatternCell.prototype.setCell=function(a){this.iNotePeriod=a>>>16&4095;this.iInstrumentNumber=a>>>12&15|a>>>24&16;this.iEffectNumber=a>>>8&15;this.iEffectParameterValue=a&255};void 0==window.weasel&&(window.weasel={});
weasel.PatternColumn=function(a){this.aPatternRow=Array(weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern);if(true===a)for(a=weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern;--a>=0;)this.aPatternRow[a]=new weasel.PatternCell(0);else for(a=weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern;--a>=0;)this.aPatternRow[a]=new weasel.MKPatternCell(0)};
weasel.PatternColumn.prototype.getCell=function(a){return a<0||a>=weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern?null:this.aPatternRow[a]};void 0==window.weasel&&(window.weasel={});
weasel.Pattern=function(a,b){this.aPatternColumns=Array(void 0==a?weasel.FormatUltimateSoundTracker121.NumberOfChannels:a.getNumberOfChannels());for(var c=this.aPatternColumns.length,d=void 0!=a&&a.FormatInstrumentTotal()==15;--c>=0;)this.aPatternColumns[c]=new weasel.PatternColumn(d);null!=a&&a.getModuleData().length>=a.FormatModuleHeaderSize()+a.getPatternSizeInBytes()*(b+1)&&this.__extractPatternDataFromModule(a,b)};
weasel.Pattern.prototype.__extractPatternDataFromModule=function(a,b){for(var c=a.getModuleData(),d=a.FormatModuleHeaderSize()+a.getPatternSizeInBytes()*b,e=0,f=weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern;e<f;e++)for(var g=0,h=this.aPatternColumns.length;g<h;g++){var i=weasel.Helper.getLong(c,d),d=d+weasel.FormatUltimateSoundTracker121.BytesPerRowCell;this.aPatternColumns[g].getCell(e).setCell(i)}};
weasel.Pattern.prototype.getColumn=function(a){return a<0||a>=this.aPatternColumns.length?null:this.aPatternColumns[a]};void 0==window.weasel&&(window.weasel={});weasel.Sample=function(a,b,c,d){this.iLength=0;this.bLooped=false;this.iLoopLength=this.iLoopStart=0;this.bIFFHeaderCleaned=false;this.aSampleData=[0];this.iFineTuning=this.iBarrelLoopSize=0;this.bSampleLoopedYet=this.bNoisetrackerLoopQuirkMode=false;this.__extractSampleFromMod(a,b,c,d)};
weasel.Sample.prototype.SampleScannerMode={Do_Not_Scan:1,Clear_IFF_Headers:2,Remove_IFF_Headers:3};weasel.Sample.prototype.BarrelLoopSize=1024;weasel.Sample.prototype.getSampleScannerModes=function(){return weasel.Sample.prototype.SampleScannerMode};
weasel.Sample.prototype.__extractSampleFromMod=function(a,b,c,d){if(0!=c){this.iLength=a.getLengthInWords()*2;this.bLooped=a.getLoopLengthInWords()>1;this.iLoopStart=a.getLoopOffsetInBytes();this.iLoopLength=a.getLoopLengthInWords()*2;this.iFineTuning=a.getFineTuning();for(var e=b.getModuleData(),f=b.FormatModuleHeaderSize()+b.numberOfUniquePatternsInSong()*b.getPatternSizeInBytes(),g=1;g<c;g++)f=f+b.getInstrument(g).getLengthInWords()*2;b=window.Uint8Array&&e instanceof Uint8Array?e.subarray(f,f+
this.getLength()):e.slice(f,f+this.getLength());(weasel.Sample.prototype.SampleScannerMode.Clear_IFF_Headers==d||weasel.Sample.prototype.SampleScannerMode.Remove_IFF_Headers==d)&&this.__scanForIFFHeaders(b,d);d=this.getLength()+4;if(this.bLooped){this.iBarrelLoopSize=weasel.Sample.prototype.BarrelLoopSize;d=d+this.iBarrelLoopSize;if(a.isNoisetrackerInstrument()&&a.useNoisetrackerLoopQuirk()&&this.iLoopStart==0&&this.iLoopLength<this.iLength){this.bNoisetrackerLoopQuirkMode=true;d=d+this.iLoopLength}}this.aSampleData=
weasel.Helper.getFloat32Array(d);try{for(var h=this.getLength(),i=this.aSampleData,a=0;--h>=0;a++){var j=weasel.Helper.twosComplement(weasel.Helper.getByte(b,a))/128;i[a]=j}}catch(k){}if(this.bLooped&&this.bNoisetrackerLoopQuirkMode){i=this.aSampleData;h=this.iLength;j=this.iLoopStart;for(a=this.iLoopLength;--a>=0;)i[h++]=i[j++];this.iLoopStart=this.iLength;this.iLength=this.iLength+this.iLoopLength}h=this.getLength();j=h-1;if(j<0){j=0;h=1;this.aSampleData[0]=0}if(this.isLooped()){j=this.getLoopStart();
h=j+this.getLoopLength()}i=this.aSampleData;for(a=i.length;h<a;)i[h++]=i[j++]}};
weasel.Sample.prototype.__scanForIFFHeaders=function(a,b){for(var c=a.length,d=true,e=0;d;){var f=weasel.Helper.searchArrayForString(a,e,c,"8SVXVHDR");if(-1==f)d=false;else{for(var e=f+4,g=-1,h=4,i=false;e<f+200;){try{e=e+4;h=h+4;g=weasel.Helper.getLong(a,e);e=e+(g+4);h=h+(g+4)}catch(j){h=h+4;break}if(weasel.Helper.searchArrayForString(a,e,e+4,"BODY")>=0){i=true;break}}i&&(h=h+8);try{if(weasel.Helper.getLong(a,f-4)<=65535){f=f-4;h=h+4;if(0==weasel.Helper.searchArrayForString(a,f-4,f,"FORM")){f=f-
4;h=h+4}}}catch(k){}weasel.Sample.prototype.SampleScannerMode.Remove_IFF_Headers==b?this.__removeIFFHeader(a,f,h):this.__clearIFFHeader(a,f,h);this.bIFFHeaderCleaned=true;e=f}}};weasel.Sample.prototype.__removeIFFHeader=function(a,b,c){for(var d=b+c,c=a.length;d<c;)a[b++]=a[d++];d=b==0?a[b]:a[b-1];for(c=a.length;b<c;)a[b++]=d};weasel.Sample.prototype.__clearIFFHeader=function(a,b,c){for(var d=a.length;--c>=0&&b<d;)a[b++]=0};weasel.Sample.prototype.getLength=function(){return this.iLength};
weasel.Sample.prototype.getLoopStart=function(){return this.iLoopStart};weasel.Sample.prototype.getLoopLength=function(){return this.iLoopLength};weasel.Sample.prototype.isLooped=function(){return this.bLooped};weasel.Sample.prototype.getSample=function(a){return this.aSampleData[a]};weasel.Sample.prototype.getSampleArray=function(){return this.aSampleData};weasel.Sample.prototype.corruptionCleaned=function(){return this.bIFFHeaderCleaned};weasel.Sample.prototype.getBarrelLoopSize=function(){return this.iBarrelLoopSize};
weasel.Sample.prototype.getFineTuning=function(){return this.iFineTuning};weasel.Sample.prototype.getNoisetrackerLoopQuirkMode=function(){return this.bNoisetrackerLoopQuirkMode};
weasel.Sample.prototype.invertSample=function(a){if(!(a<0||a>=this.aSampleData.length))if(!this.bLooped||!(a>=this.iLength||this.bNoisetrackerLoopQuirkMode&&a>=this.iLoopStart)){this.aSampleData[a]=-this.aSampleData[a];if(this.bLooped&&this.iBarrelLoopSize!=0&&(!this.bNoisetrackerLoopQuirkMode&&a>=this.iLoopStart&&a<this.iLoopStart+this.iLoopLength||this.bNoisetrackerLoopQuirkMode&&a<this.iLoopLength))for(var b=this.aSampleData[a],c=0,c=this.bNoisetrackerLoopQuirkMode?a+this.iLoopStart:this.iLength+
(a-this.iLoopStart),a=this.iLoopLength,d=this.aSampleData.length;c<d;c=c+a)this.aSampleData[c]=b}};weasel.Sample.prototype.setLoopedYet=function(a){this.bSampleLoopedYet=a};weasel.Sample.prototype.getLoopedYet=function(){return this.bSampleLoopedYet};void 0==window.weasel&&(window.weasel={});
weasel.Instrument=function(a,b,c,d,e,f){this.sName="";this.iFineTuning=this.iLoopLengthInWords=this.iLoopOffsetInBytes=this.iLengthInWords=this.iVolume=0;this.bNoisetrackerInstrument=d;this.bNoiseTrackerLoopQuirk=e;this.bProtrackerFineTuning=f;this.oSample=null;this.__extractInstrumentFromMod(a,b);if(d)this.iLoopOffsetInBytes=this.iLoopOffsetInBytes*2;try{this.oSample=new weasel.Sample(this,a,b,c)}catch(g){}};
weasel.Instrument.prototype.__extractInstrumentFromMod=function(a,b){var c=a.getModuleData();if(!(c.length<a.FormatModuleHeaderSize())&&!(b==0||b>a.FormatInstrumentTotal())){b--;try{var d=weasel.FormatUltimateSoundTracker121.SampleHeaders+b*weasel.FormatUltimateSoundTracker121.SampleHeader.HeaderSize;this.sName=weasel.Helper.getNullTerminatedString(c,d+weasel.FormatUltimateSoundTracker121.SampleHeader.SampleName,weasel.FormatUltimateSoundTracker121.SampleHeader.MaxNameLength);this.iLengthInWords=
weasel.Helper.getWord(c,d+weasel.FormatUltimateSoundTracker121.SampleHeader.LengthInWords);this.iVolume=weasel.Helper.getWord(c,d+weasel.FormatUltimateSoundTracker121.SampleHeader.Volume)&255;this.iLoopOffsetInBytes=weasel.Helper.getWord(c,d+weasel.FormatUltimateSoundTracker121.SampleHeader.RepeatOffsetInBytes);this.iLoopLengthInWords=weasel.Helper.getWord(c,d+weasel.FormatUltimateSoundTracker121.SampleHeader.RepeatLengthInWords);if(this.bProtrackerFineTuning)this.iFineTuning=weasel.Helper.getWord(c,
d+weasel.FormatUltimateSoundTracker121.SampleHeader.Volume)>>8&15}catch(e){}}};weasel.Instrument.prototype.getName=function(){return this.sName};weasel.Instrument.prototype.getVolume=function(){return this.iVolume};weasel.Instrument.prototype.getLengthInWords=function(){return this.iLengthInWords};weasel.Instrument.prototype.getLoopOffsetInBytes=function(){return this.iLoopOffsetInBytes};weasel.Instrument.prototype.getLoopLengthInWords=function(){return this.iLoopLengthInWords};
weasel.Instrument.prototype.getSample=function(){return this.oSample};weasel.Instrument.prototype.isNoisetrackerInstrument=function(){return this.bNoisetrackerInstrument};weasel.Instrument.prototype.useNoisetrackerLoopQuirk=function(){return this.bNoiseTrackerLoopQuirk};weasel.Instrument.prototype.getFineTuning=function(){return this.iFineTuning};void 0==window.weasel&&(window.weasel={});
weasel.Channel=function(a,b,c){this.iShadowVolume=this.iCurrentVolume=this.iCurrentEffectParameter=this.iCurrentEffect=this.iCurrentInstrument=this.iCurrentNotePeriod=0;this.fMasterVolume=1;this.setMasterVolume(c);this.iPendingInstrument=this.fCurrentSamplePosition=this.iShadowNotePeriod=this.iLastSavedNotePeriod=0;this.oPendingInstrument=null;this.iPatternRowLoopCounter=this.iPatternRowLoopStart=this.iFineTune=this.iSampleStartOffset=this.iLastSampleOffsetParameter=this.iDelayedNotePeriod=0;this.iPlaybackFrequency=
b;this.fCurrentFrequencyStep=0;this.bDelaySampleStart=true;this.iDelayInSamples=0;this.bNoNoteDelayQuirk=false;this.bUsePALClockConstant=true;this.oModule=a;this.aCircularAudioBuffer=weasel.Helper.getFloat32Array(b);a=this.aCircularAudioBuffer.length;for(b=this.aCircularAudioBuffer;--a>=0;)b[a]=0;this.fSampleAccumulator4=this.fSampleAccumulator3=this.fSampleAccumulator2=this.fSampleAccumulator1=this.fSampleAccumulator=this.iCircularBufferPosition=0;this.oSample=null;this.iChannelInterpolation=0;this.bAutoSlide=
this.bMute=false;this.iLastVibratoParameter=this.iVibratoTablePosition=this.iNotePoramentoSpeed=this.iNotePortamentoTargetPeriod=this.iAutoSlideValue=0;this.bVibratoContinueWaveform=false;this.iVibratoWaveformType=weasel.Channel.prototype.ProtrackerVibratoWaveform.SineWave;this.iTremoloTablePosition=this.iLastTremoloParameter=0;this.bTremoloContinueWaveform=false;this.iTremoloWaveformType=weasel.Channel.prototype.ProtrackerTremoloWaveform.SineWave;this.iInvertLoopSampleLoopStart=this.iInvertLoopSampleOffset=
this.iInvertLoopTimeDelay=this.iInvertLoopSpeed=0;this.bGlissandoMode=false;this.iPanningPosition=128;this.oPatternCell=null};weasel.Channel.prototype.SupportedInterpolationTypes={None:0,RLM$D_Alias_Reduction:1,Linear_Interpolation:2,Cubic_Spline_4_Point_Interpolation:3,Catmull$Rom_Spline_Interpolation:4,Spline_6_Point_Interpolation:5};weasel.Channel.prototype.ArpeggioMode={UltimateSoundtracker:0,Noisetracker:1,Protracker:2,FSTModule:3};
weasel.Channel.prototype.ProtrackerVibratoWaveform={SineWave:0,RampDownSawTooth:1,Square:2,Random:3};weasel.Channel.prototype.ProtrackerTremoloWaveform={SineWave:0,RampDownSawTooth:1,Square:2,Random:3};weasel.Channel.prototype.changePlaybackFrequency=function(a){for(var b=weasel.Helper.getFloat32Array(a),c=b.length;--c>=0;)b[c]=0;this.iPlaybackFrequency=a;this.setNotePeriod(this.getNotePeriod());this.aCircularAudioBuffer=b;this.setCircularBufferPosition(0)};
weasel.Channel.prototype.setSample=function(a){this.oSample=a};weasel.Channel.prototype.getSample=function(){return this.oSample};weasel.Channel.prototype.delaySampleStart=function(a,b){this.bDelaySampleStart=a==true?true:false;this.iDelayInSamples=b<=0?0:this.iPlaybackFrequency/(1E3/b)|0};weasel.Channel.prototype.getDelaySampleStart=function(){return this.bDelaySampleStart};weasel.Channel.prototype.getSupportedInterpolationTypes=function(){return weasel.Channel.prototype.SupportedInterpolationTypes};
weasel.Channel.prototype.getNotePeriod=function(){return this.iCurrentNotePeriod};weasel.Channel.prototype.getClockConstant=function(){return this.bUsePALClockConstant==true?weasel.FormatUltimateSoundTracker121.ClockConstantPAL:weasel.FormatUltimateSoundTracker121.ClockConstantNTSC};weasel.Channel.prototype.getClockConstantType=function(){return this.bUsePALClockConstant==true?"PAL":"NTSC"};weasel.Channel.prototype.setClockConstant=function(a){this.bUsePALClockConstant=a==true?true:false;this.setNotePeriod(this.getNotePeriod())};
weasel.Channel.prototype.setNotePeriod=function(a){this.iCurrentNotePeriod=a;this.fCurrentFrequencyStep=a<=0||this.iPlaybackFrequency<=0?0:this.getClockConstant()/a/this.iPlaybackFrequency};weasel.Channel.prototype.getFrequencyStepRate=function(){return this.fCurrentFrequencyStep};weasel.Channel.prototype.getLastSavedNotePeriod=function(){return this.iLastSavedNotePeriod};weasel.Channel.prototype.setLastSavedNotePeriod=function(a){this.iLastSavedNotePeriod=a};
weasel.Channel.prototype.getShadowNotePeriod=function(){return this.iShadowNotePeriod};weasel.Channel.prototype.setShadowNotePeriod=function(a){this.iShadowNotePeriod=a};weasel.Channel.prototype.getInstrumentNumber=function(){return this.iCurrentInstrument};weasel.Channel.prototype.setInstrumentNumber=function(a){this.iCurrentInstrument=a};weasel.Channel.prototype.getPendingInstrumentNumber=function(){return this.iPendingInstrument};
weasel.Channel.prototype.setPendingInstrumentNumber=function(a,b){this.iPendingInstrument=a;this.oPendingInstrument=b};weasel.Channel.prototype.getDelayedNotePeriod=function(){return this.iDelayedNotePeriod};weasel.Channel.prototype.setDelayedNotePeriod=function(a){this.iDelayedNotePeriod=a};weasel.Channel.prototype.getEffectNumber=function(){return this.iCurrentEffect};weasel.Channel.prototype.setEffectNumber=function(a){this.iCurrentEffect=a};weasel.Channel.prototype.getEffectParameter=function(){return this.iCurrentEffectParameter};
weasel.Channel.prototype.setEffectParameter=function(a){this.iCurrentEffectParameter=a};weasel.Channel.prototype.setMasterVolume=function(a){void 0==a&&(a=1);a<0&&(a=0);a>2&&(a=2);this.fMasterVolume=a};weasel.Channel.prototype.getMasterVolume=function(){return this.fMasterVolume};weasel.Channel.prototype.getVolume=function(){return this.bMute==true?0:this.iCurrentVolume};weasel.Channel.prototype.getShadowVolume=function(){return this.iShadowVolume};
weasel.Channel.prototype.setMute=function(a){this.bMute=a==true?true:false};weasel.Channel.prototype.setVolume=function(a){this.iShadowVolume=this.iCurrentVolume=a};weasel.Channel.prototype.getSamplePosition=function(){return this.fCurrentSamplePosition};weasel.Channel.prototype.setSamplePosition=function(a){this.fCurrentSamplePosition=a};
weasel.Channel.prototype.arpeggio=function(a,b){var c=0,c=b==this.ArpeggioMode.UltimateSoundtracker?this.getLastSavedNotePeriod():this.getShadowNotePeriod();if(0==c)this.setNotePeriod(0);else{b!=this.ArpeggioMode.UltimateSoundtracker&&(a=a%3);if(0==a||3==a)this.setNotePeriod(c);else{var d=this.getEffectParameter()&15;if(1==a||4==a)d=this.getEffectParameter()>>>4&15;var e=weasel.FormatUltimateSoundTracker121.PeriodTable,f=e.length,g=0,h=0;b!=this.ArpeggioMode.UltimateSoundtracker&&(f=36);if(b==this.ArpeggioMode.Protracker){e=
weasel.FormatProTrackerMK.FineTunePeriodTables;h=this.getFineTune()*37}if(b==this.ArpeggioMode.FSTModule){e=weasel.FormatFSTModule.FSTPeriodTable;f=e.length;h=this.getFineTune()}if(b==this.ArpeggioMode.UltimateSoundtracker)for(;g<f;g++){if(c==e[g])break}else if(b==this.ArpeggioMode.FSTModule)for(;g<f;g++){if(c>=e[g])break}else for(;g<f;g++)if(c>=e[g+h])break;g=g+d;if(g>=f){if(b==this.ArpeggioMode.Noisetracker){this.setNotePeriod(0);return}if(b!=this.ArpeggioMode.Protracker){if(b==this.ArpeggioMode.FSTModule){c=
this.oModule.calcFineTune(this,e[f-1]);this.setNotePeriod(c);return}g=f-1}}if(b==this.ArpeggioMode.FSTModule){c=this.oModule.calcFineTune(this,e[g]);this.setNotePeriod(c)}else this.setNotePeriod(e[g+h])}}};weasel.Channel.prototype.pitchBend=function(a,b,c){var d=this.getShadowNotePeriod();if(0!=a){if(0!=b){d=d+b;d>65535&&(d=65535)}else if(0!=c){d=d-c;d<0&&(d=0)}this.setShadowNotePeriod(d);this.setNotePeriod(d)}};
weasel.Channel.prototype.volumeSlide=function(a){if(0!=a){a=this.getEffectParameter();a=this.getShadowVolume()+(0==a>>>4&15?0-(a&15):a>>>4&15);a>64?a=64:a<0&&(a=0);this.setVolume(a)}};
weasel.Channel.prototype.notePortamento=function(a){if(0!=a){var b=this.iNotePortamentoTargetPeriod;if(0!=b){a=this.getShadowNotePeriod();if(a<b){a=a+this.iNotePoramentoSpeed;if(a>b){a=b;this.iNotePortamentoTargetPeriod=0}}else if(a>b){a=a-this.iNotePoramentoSpeed;if(a<b){a=b;this.iNotePortamentoTargetPeriod=0}}this.setShadowNotePeriod(a);if(this.bGlissandoMode){for(var b=weasel.FormatProTrackerMK.FineTunePeriodTables,c=this.getFineTune()*37,d=weasel.FormatUltimateSoundTracker121.PeriodTable.length,
e=0;e<d;e++)if(a>=b[e+c])break;a=b[e+c]}this.setNotePeriod(a)}}};
weasel.Channel.prototype.vibrato=function(a,b,c){if(0!=a){if(0!=this.getEffectParameter()&&b)this.iLastVibratoParameter=this.getEffectParameter();a=(this.iLastVibratoParameter&240)>>>4;c=weasel.FormatNoiseTracker11.VibratoTable[this.iVibratoTablePosition>>>2&31]*(this.iLastVibratoParameter&15)>>>(c?7:6);b=this.getShadowNotePeriod();b=0==(this.iVibratoTablePosition&128)?b+c:b-c;this.iVibratoTablePosition=this.iVibratoTablePosition+(a<<2)&255;this.setNotePeriod(b)}};
weasel.Channel.prototype.protrackerVibrato=function(a,b,c){if(0!=a){if(0!=this.getEffectParameter()&&b){a=this.getEffectParameter()&240;if(a!=0)this.iLastVibratoParameter=this.iLastVibratoParameter&15|a;a=this.getEffectParameter()&15;if(a!=0)this.iLastVibratoParameter=this.iLastVibratoParameter&240|a}a=this.iVibratoTablePosition>>>2&31;b=255;if(this.iVibratoWaveformType==weasel.Channel.prototype.ProtrackerVibratoWaveform.SineWave)b=weasel.FormatNoiseTracker11.VibratoTable[a];else if(this.iVibratoWaveformType==
weasel.Channel.prototype.ProtrackerVibratoWaveform.RampDownSawTooth){b=a<<3;0!=(this.iVibratoTablePosition&128)&&(b=255-b)}a=(this.iLastVibratoParameter&240)>>>4;c=b*(this.iLastVibratoParameter&15)>>>(c?7:6);b=this.getShadowNotePeriod();b=0==(this.iVibratoTablePosition&128)?b+c:b-c;this.iVibratoTablePosition=this.iVibratoTablePosition+(a<<2)&255;this.setNotePeriod(b)}};
weasel.Channel.prototype.tremolo=function(a,b){if(0!=a){if(0!=this.getEffectParameter()){var c=this.getEffectParameter()&240;if(c!=0)this.iLastTremoloParameter=this.iLastTremoloParameter&15|c;c=this.getEffectParameter()&15;if(c!=0)this.iLastTremoloParameter=this.iLastTremoloParameter&240|c}var c=this.iTremoloTablePosition>>>2&31,d=255;if(this.iTremoloWaveformType==weasel.Channel.prototype.ProtrackerTremoloWaveform.SineWave)d=weasel.FormatNoiseTracker11.VibratoTable[c];else if(this.iTremoloWaveformType==
weasel.Channel.prototype.ProtrackerTremoloWaveform.RampDownSawTooth){d=c<<3;if(0!=((true==b?this.iVibratoTablePosition:this.iTremoloTablePosition)&128))d=255-d}var c=(this.iLastTremoloParameter&240)>>>4,d=d*(this.iLastTremoloParameter&15)>>>6,e=this.getShadowVolume(),e=0==(this.iTremoloTablePosition&128)?e+d:e-d;e>64?e=64:e<0&&(e=0);this.iTremoloTablePosition=this.iTremoloTablePosition+(c<<2)&255;this.iCurrentVolume=e}};
weasel.Channel.prototype.retriggerNote=function(a,b,c){b=b&15;if(0!=b&&0==a%b){this.delaySampleStart(true,c);this.setSamplePosition(this.playFromOffset());return true}return false};weasel.Channel.prototype.getCircularAudioBuffer=function(){return this.aCircularAudioBuffer};weasel.Channel.prototype.getCircularBufferPosition=function(){return this.iCircularBufferPosition};weasel.Channel.prototype.setCircularBufferPosition=function(a){this.iCircularBufferPosition=a};
weasel.Channel.prototype.getChannelInterpolation=function(){return this.iChannelInterpolation};weasel.Channel.prototype.setChannelInterpolation=function(a){var b=false,c;for(c in this.SupportedInterpolationTypes)if(this.SupportedInterpolationTypes.hasOwnProperty(c)&&a===this.SupportedInterpolationTypes[c]){b=true;break}if(b)this.iChannelInterpolation=a};
weasel.Channel.prototype.setSampleAccumulator=function(){this.fSampleAccumulator1=this.fSampleAccumulator2=this.fSampleAccumulator3=this.fSampleAccumulator4=this.fSampleAccumulator=0;var a=this.getSample();if(null!=a&&0!=a.getLength()){var a=a.getSampleArray(),b=this.getSamplePosition()|0;if(null!=a&&!(b>=a.length))this.fSampleAccumulator=this.fSampleAccumulator1=this.fSampleAccumulator2=this.fSampleAccumulator3=this.fSampleAccumulator4=a[b]*this.getVolume()/64*this.getMasterVolume()}};
weasel.Channel.prototype.makeSilence=function(a){if(!(a<=0)){for(var b=this.getCircularAudioBuffer(),c=this.getCircularBufferPosition(),d=b.length,e=b[(c-1+d)%d];a>0;){for(var f=d-c,f=f>=a?a:f,a=a-f,g=f&3;--g>=0;)b[c++]=e;for(f=f>>>2;--f>=0;){b[c++]=e;b[c++]=e;b[c++]=e;b[c++]=e}c=c%d}this.setCircularBufferPosition(c)}};
weasel.Channel.prototype.makeNoise=function(a,b){var c=this.getChannelInterpolation(),d=this.getFrequencyStepRate();0==c?this.makeNoiseAmigaStyle(a,b):5==c?1>d?this.make6PointCubicSplineInterpolation(a,b):this.makeNoiseAmigaStyle(a,b):4==c?1>d?this.makeNoiseCatmullRomSplineInterpolation(a,b):this.makeNoiseAmigaStyle(a,b):3==c?1>d?this.makeNoiseCubicSplineInterpolation(a,b):this.makeNoiseAmigaStyle(a,b):2==c?1>d?this.makeNoiseLinearInterpolation(a,b):this.makeNoiseAmigaStyle(a,b):1==c&&this.makeNoiseRLMDAliasReduction(a,
b)};weasel.Channel.prototype.makeNoiseAmigaStyle=function(a,b){for(var c=this.getSamplePosition(),d=this.getCircularAudioBuffer(),e=this.getCircularBufferPosition(),f=d.length,g=this.getVolume()/64*this.getMasterVolume(),h=c|0,i=a[h]*g,j=b,k=this.getFrequencyStepRate(),l=c-h;j>0;){c=e+j>f?f-e:j;for(j=j-c;--c>=0;){d[e++]=i;if(1<=(l=l+k))var m=l|0,h=h+m,i=a[h]*g,l=l-m}e=e%f;c=h+l}this.setSamplePosition(c);this.setCircularBufferPosition(e)};
weasel.Channel.prototype.makeNoiseRLMDAliasReduction=function(a,b){for(var c=this.getSamplePosition(),d=this.getCircularAudioBuffer(),e=this.getCircularBufferPosition(),f=d.length,g=this.fSampleAccumulator,h=this.getVolume()/64*this.getMasterVolume(),i=c|0,j=a[i],k=b,l=this.getFrequencyStepRate(),m=c-i;k>0;){c=e+k>f?f-e:k;for(k=k-c;--c>=0;){d[e++]=(g=(g+j)*0.5)*h;if(1<=(m=m+l))var n=m|0,i=i+n,j=a[i],m=m-n}e=e%f;c=i+m}this.fSampleAccumulator=g;this.setSamplePosition(c);this.setCircularBufferPosition(e)};
weasel.Channel.prototype.makeNoiseLinearInterpolation=function(a,b){for(var c=this.getSamplePosition(),d=this.getCircularAudioBuffer(),e=this.getCircularBufferPosition(),f=d.length,g=this.fSampleAccumulator,h=this.getVolume()/64*this.getMasterVolume(),i=c|0,j=a[i]*h,k=b,l=this.getFrequencyStepRate(),m=c-i,n=(j-g)*l,o=g+(j-g)*m-n;k>0;){c=e+k>f?f-e:k;for(k=k-c;--c>=0;){d[e++]=o=o+n;if(1<=(m=m+l)){m=m-1;g=j;j=a[++i]*h;n=(j-g)*l;o=g+(j-g)*m-n}}e=e%f;c=i+m}this.fSampleAccumulator=g;this.setSamplePosition(c);
this.setCircularBufferPosition(e)};
weasel.Channel.prototype.makeNoiseCatmullRomSplineInterpolation=function(a,b){for(var c=this.getSamplePosition(),d=this.getCircularAudioBuffer(),e=this.getCircularBufferPosition(),f=d.length,g=this.fSampleAccumulator,h=this.fSampleAccumulator1,i=this.fSampleAccumulator2,j=this.getVolume()/64*this.getMasterVolume(),k=c|0,l=a[k]*j,m=-0.5*i+1.5*h-1.5*g+0.5*l,n=i-2.5*h+2*g-0.5*l,o=-0.5*i+0.5*g,q=b,u=this.getFrequencyStepRate(),p=c-k;q>0;){c=e+q>f?f-e:q;for(q=q-c;--c>=0;){var r=p*p;d[e++]=m*p*r+n*r+o*
p+h;if(1<=(p=p+u)){p=p-1;i=h;h=g;g=l;l=a[++k]*j;m=-0.5*i+1.5*h-1.5*g+0.5*l;n=i-2.5*h+2*g-0.5*l;o=-0.5*i+0.5*g}}e=e%f;c=k+p}this.fSampleAccumulator=g;this.fSampleAccumulator1=h;this.fSampleAccumulator2=i;this.setSamplePosition(c);this.setCircularBufferPosition(e)};
weasel.Channel.prototype.makeNoiseCubicSplineInterpolation=function(a,b){for(var c=this.getSamplePosition(),d=this.getCircularAudioBuffer(),e=this.getCircularBufferPosition(),f=d.length,g=this.fSampleAccumulator,h=this.fSampleAccumulator1,i=this.fSampleAccumulator2,j=this.getVolume()/64*this.getMasterVolume(),k=c|0,l=a[k]*j,m=l-g-i+h,n=i-h-m,o=g-i,q=b,u=this.getFrequencyStepRate(),p=c-k;q>0;){c=e+q>f?f-e:q;for(q=q-c;--c>=0;){var r=p*p;d[e++]=m*p*r+n*r+o*p+h;if(1<=(p=p+u)){p=p-1;i=h;h=g;g=l;l=a[++k]*
j;m=l-g-i+h;n=i-h-m;o=g-i}}e=e%f;c=k+p}this.fSampleAccumulator=g;this.fSampleAccumulator1=h;this.fSampleAccumulator2=i;this.setSamplePosition(c);this.setCircularBufferPosition(e)};
weasel.Channel.prototype.make6PointCubicSplineInterpolation=function(a,b){for(var c=this.getSamplePosition(),d=this.getCircularAudioBuffer(),e=this.getCircularBufferPosition(),f=d.length,g=this.fSampleAccumulator,h=this.fSampleAccumulator1,i=this.fSampleAccumulator2,j=this.fSampleAccumulator3,k=this.fSampleAccumulator4,l=this.getVolume()/64*this.getMasterVolume(),m=c|0,n=a[m]*l,o=(h-j)*16+(k-g)*2,q=(h+j)*16-k-i*30-g,u=h*66-i*70-g*33+j*39+n*7-k*9,p=i*126-h*124+g*61-j*64-n*12+k*13,r=(h-i)*50+(j-g)*
25+(n-k)*5,v=b,w=this.getFrequencyStepRate(),s=c-m;v>0;){c=e+v>f?f-e:v;for(v=v-c;--c>=0;){d[e++]=i+0.04166666666*s*(o+s*(q+s*(u+s*(p+s*r))));if(1<=(s=s+w)){s=s-1;k=j;j=i;i=h;h=g;g=n;n=a[++m]*l;o=(h-j)*16+(k-g)*2;q=(h+j)*16-k-i*30-g;u=h*66-i*70-g*33+j*39+n*7-k*9;p=i*126-h*124+g*61-j*64-n*12+k*13;r=(h-i)*50+(j-g)*25+(n-k)*5}}e=e%f;c=m+s}this.fSampleAccumulator=g;this.fSampleAccumulator1=h;this.fSampleAccumulator2=i;this.fSampleAccumulator3=j;this.fSampleAccumulator4=k;this.setSamplePosition(c);this.setCircularBufferPosition(e)};
weasel.Channel.prototype.make=function(a){if(!(a<=0)){var b=this.getSample();if(null==b)this.makeSilence(a);else{if(this.bDelaySampleStart){var c=this.iDelayInSamples>a?a:this.iDelayInSamples;this.makeSilence(c);a=a-c;this.iDelayInSamples=this.iDelayInSamples-c;if(this.iDelayInSamples<=0)this.bDelaySampleStart=false;if(a<=0)return}var d=this.getSamplePosition(),c=b.getLength(),e=this.getFrequencyStepRate();if(b.isLooped()){c=b.getLoopStart()+b.getLoopLength();true==this.oModule.getNoiseTrackerLoopQuirkEnabled()&&
(true==b.getNoisetrackerLoopQuirkMode()&&false==b.getLoopedYet())&&(c=b.getLength())}else if(0==c||d>=c){if(true==this.oModule.getNoiseTrackerLoopQuirkEnabled()&&this.iPendingInstrument!=this.iCurrentInstrument&&this.oPendingInstrument!=null&&this.oPendingInstrument.getSample().isLooped()){b=this.oPendingInstrument.getSample();b.setLoopedYet(true);this.setSample(b);this.setInstrumentNumber(this.iPendingInstrument);this.setSamplePosition(b.getLoopStart()+(d-c));this.make(a);return}this.makeSilence(a);
return}if(e*a+d<c+e)this.makeNoise(b.getSampleArray(),a);else{b.setLoopedYet(true);d=this.getSamplePosition();if(b.isLooped())if(true==this.oModule.getNoiseTrackerLoopQuirkEnabled()&&this.iPendingInstrument!=this.iCurrentInstrument&&this.oPendingInstrument!=null){d=Math.ceil((c-d)/e);this.makeNoise(b.getSampleArray(),d);a=a-d;b=this.oPendingInstrument.getSample();b.setLoopedYet(true);this.setSample(b);this.setInstrumentNumber(this.iPendingInstrument);b.isLooped()?this.setSamplePosition(b.getLoopStart()+
(this.getSamplePosition()-c)):this.setSamplePosition(b.getLength());this.make(a)}else for(var c=c+b.getBarrelLoopSize(),f=b.getLoopStart(),g=b.getLoopLength(),h=f+g;a>0;){d=this.getSamplePosition();d=Math.ceil((c-d)/e);d=d>=a?a:d;this.makeNoise(b.getSampleArray(),d);a=a-d;d=this.getSamplePosition();d>h&&this.setSamplePosition(f+(d-h)%g)}else{d=Math.ceil((c-d)/e);this.makeNoise(b.getSampleArray(),d);this.make(a-d)}}}}};
weasel.Channel.prototype.makeNoiseLinearInterpolationNew=function(a,b){var c=this.getSamplePosition(),d=this.getCircularAudioBuffer(),e=this.getCircularBufferPosition(),f=d.length,g=this.getVolume()/64,h,i=a[c|0],j=a.length,c=(c+1)%j;h=c|0;for(var k=a[h],l=b,m=this.getFrequencyStepRate();--l>=0;){var n=c-h,n=i*(1-n)+k*n;d[e++]=n*g;e=e%f;c=c+m;if((c|0)-h>=1){i=k;h=c|0;k=a[h]}}this.setSamplePosition((c+j-1)%j);this.setCircularBufferPosition(e)};weasel.Channel.prototype.getAutoSlide=function(){return this.bAutoSlide};
weasel.Channel.prototype.setAutoSlide=function(a){this.bAutoSlide=a};weasel.Channel.prototype.getAutoSlideValue=function(){return this.iAutoSlideValue};weasel.Channel.prototype.setAutoSlideValue=function(a){this.iAutoSlideValue=a};weasel.Channel.prototype.setNotePortamentoTarget=function(a){this.iNotePortamentoTargetPeriod=a};weasel.Channel.prototype.setNotePortamentoSpeed=function(a){if(a>0)this.iNotePoramentoSpeed=a};
weasel.Channel.prototype.setVibratoTablePosition=function(a){this.iVibratoTablePosition=a&255};weasel.Channel.prototype.setTremoloTablePosition=function(a){this.iTremoloTablePosition=a&255};weasel.Channel.prototype.setLastSampleOffsetParameter=function(a){this.iLastSampleOffsetParameter=a};weasel.Channel.prototype.getLastSampleOffsetParameter=function(){return this.iLastSampleOffsetParameter};weasel.Channel.prototype.setPlayFromOffset=function(a){this.iSampleStartOffset=a};
weasel.Channel.prototype.playFromOffset=function(){return this.iSampleStartOffset};weasel.Channel.prototype.setFineTune=function(a){this.iFineTune=a};weasel.Channel.prototype.getFineTune=function(){return this.iFineTune};weasel.Channel.prototype.getPatternRowLoopStart=function(){return this.iPatternRowLoopStart};weasel.Channel.prototype.setPatternRowLoopStart=function(a){this.iPatternRowLoopStart=a};weasel.Channel.prototype.getPatternRowLoopCounter=function(){return this.iPatternRowLoopCounter};
weasel.Channel.prototype.setPatternRowLoopCounter=function(a){this.iPatternRowLoopCounter=a};weasel.Channel.prototype.decPatternRowLoopCounter=function(){if(--this.iPatternRowLoopCounter<0)this.iPatternRowLoopCounter=0};weasel.Channel.prototype.getProtrackerContinueVibratoWaveform=function(){return this.bVibratoContinueWaveform};weasel.Channel.prototype.setProtrackerContinueVibratoWaveform=function(a){this.bVibratoContinueWaveform=a};weasel.Channel.prototype.getProtrackerVibratoWaveformType=function(){return this.iVibratoWaveformType};
weasel.Channel.prototype.setProtrackerVibratoWaveformType=function(a){this.iVibratoWaveformType=a};weasel.Channel.prototype.setProtrackerTremoloWaveformType=function(a){this.iTremoloWaveformType=a};weasel.Channel.prototype.getProtrackerTremoloWaveformType=function(){return this.iTremoloWaveformType};weasel.Channel.prototype.getProtrackerContinueTremoloWaveform=function(){return this.bTremoloContinueWaveform};
weasel.Channel.prototype.setProtrackerContinueTremoloWaveform=function(a){this.bTremoloContinueWaveform=a};weasel.Channel.prototype.getCurrentPatternCell=function(){return this.oPatternCell};weasel.Channel.prototype.setCurrentPatternCell=function(a){this.oPatternCell=a};weasel.Channel.prototype.setProtrackerInvertLoopSpeed=function(a){a<0?a=0:a>15&&(a=15);this.iInvertLoopSpeed=a};weasel.Channel.prototype.setGlissando=function(a){this.bGlissandoMode=a};
weasel.Channel.prototype.getProtrackerInvertLoopSpeed=function(){return this.iInvertLoopSpeed};weasel.Channel.prototype.setProtrackerInvertLoopOffset=function(a){var b=a.getLoopOffsetInBytes(),a=a.getLengthInWords()*2;b>a&&(b=a);this.iInvertLoopSampleOffset=this.iInvertLoopSampleLoopStart=b};
weasel.Channel.prototype.updateProtrackerInvertLoop=function(){var a=this.iInvertLoopSpeed;if(0!=a){var b=this.iInvertLoopTimeDelay,b=b+weasel.FormatProTrackerMK.InvertSampleLoop[a];if(b<128)this.iInvertLoopTimeDelay=b;else{this.iInvertLoopTimeDelay=0;if(a=this.getSample()){var b=this.iInvertLoopSampleLoopStart+a.getLoopLength(),c=++this.iInvertLoopSampleOffset;if(c>=b)this.iInvertLoopSampleOffset=c=this.iInvertLoopSampleLoopStart;a.invertSample(c)}}}};
weasel.Channel.prototype.getNoNoteDelayQuirk=function(){return this.bNoNoteDelayQuirk};weasel.Channel.prototype.setNoNoteDelayQuirk=function(a){this.bNoNoteDelayQuirk=a};weasel.Channel.prototype.getPanningPosition=function(){return this.iPanningPosition};weasel.Channel.prototype.setPanningPosition=function(a){a<0?a=0:a>255&&(a=255);this.iPanningPosition=a};
weasel.Channel.prototype.clearChannel=function(){this.setSample(null);this.setNotePeriod(0);this.setLastSavedNotePeriod(0);this.setShadowNotePeriod(0);this.setInstrumentNumber(0);this.setPendingInstrumentNumber(0,null);this.setVolume(0);this.setEffectNumber(0);this.setEffectParameter(0);this.setAutoSlide(false);this.setAutoSlideValue(0);this.setNotePortamentoTarget(0);this.iPatternRowLoopCounter=this.iPatternRowLoopStart=this.iFineTune=this.iSampleStartOffset=this.iLastSampleOffsetParameter=this.iLastVibratoParameter=
this.iVibratoTablePosition=this.iNotePoramentoSpeed=0;this.bVibratoContinueWaveform=false;this.iVibratoWaveformType=weasel.Channel.prototype.ProtrackerVibratoWaveform.SineWave;this.oPatternCell=null;this.iTremoloTablePosition=this.iLastTremoloParameter=0;this.bTremoloContinueWaveform=false;this.iTremoloWaveformType=weasel.Channel.prototype.ProtrackerTremoloWaveform.SineWave;this.iInvertLoopSampleLoopStart=this.iInvertLoopSampleOffset=this.iInvertLoopTimeDelay=this.iInvertLoopSpeed=0;this.bNoNoteDelayQuirk=
this.bGlissandoMode=false;this.iPanningPosition=128};void 0==window.weasel&&(window.weasel={});weasel.ModuleSniffer=function(){this.sModuleType="Unknown";this.sReason="Data not examined";this.oSniffReasons={};this.iUniquePatterns=-1;this.bTJCSlideCommandsLookValid=this.bTJCSpecificCommandFound=false;this.iMaxPanningPosition=0;this.aPanningPositions=[];this.iPanningEffectTotal=this.fPanningStandardDeviation=this.fPanningVariance=this.fPanningMean=0;this.bCoarsePanningUsed=false;this.__reset()};
weasel.ModuleSniffer.prototype.SupportedModules={UltimateSoundTracker121:"Ultimate Soundtracker 1.21",UltimateSoundTracker18:"Ultimate Soundtracker 1.8",DOCSoundTracker9:"DOC Soundtracker 9",DOCSoundTracker22:"DOC Soundtracker 2.2",TJCSoundTracker2:"TJC Soundtracker 2",DefJamSoundTracker3:"Def Jam Soundtracker 3",SpreadpointSoundTracker23:"Spreadpoint Soundtracker 2.3",NoiseTracker11:"Noisetracker 1.1",NoiseTracker20:"Noisetracker 2.0",ProTrackerMK:"Protracker M.K.",SpreadpointSoundTracker25:"Spreadpoint Soundtracker 2.5",
FSTModule:"Taketracker/Fasttracker"};weasel.ModuleSniffer.prototype.__reset=function(){this.iUniquePatterns=-1;this.sModuleType="Unknown";this.sReason="Data not examined";this.oSniffReasons={};this.bTJCSlideCommandsLookValid=this.bTJCSpecificCommandFound=false;this.iMaxPanningPosition=0;this.bCoarsePanningUsed=false};
weasel.ModuleSniffer.prototype.__UltimateSoundtrackerLengthOfSong=function(a){if(a.length<weasel.FormatUltimateSoundTracker121.MinimumHeaderSize){this.sReason="Data size is too small for Module, need at least "+weasel.FormatUltimateSoundTracker121.MinimumHeaderSize+" bytes for a header and at least one song pattern (not including instruments).";return true}if(weasel.Helper.getByte(a,weasel.FormatUltimateSoundTracker121.SongLength)<1){this.sReason="Song length too short (minimum length of 1 pattern).";
return true}if(weasel.Helper.getByte(a,weasel.FormatUltimateSoundTracker121.SongLength)>weasel.FormatUltimateSoundTracker121.SequenceTableLength){this.sReason="Song length too long (maximum 128 patterns).";return true}return false};
weasel.ModuleSniffer.prototype.__MichaelKlepsSoundtrackerLengthOfSong=function(a){if(a.length<weasel.FormatSpreadpointSoundTracker23.MinimumHeaderSize){this.sReason="Data size is too small for Module, need at least "+weasel.FormatSpreadpointSoundTracker23.MinimumHeaderSize+" bytes for a header and at least one song pattern (not including instruments).";return true}return this.__SoundtrackerLengthOfSong(a)};
weasel.ModuleSniffer.prototype.__SoundtrackerLengthOfSong=function(a){if(weasel.Helper.getByte(a,weasel.FormatSpreadpointSoundTracker23.SongLength)<1){this.sReason="Song length too short (minimum length of 1 pattern).";return true}if(weasel.Helper.getByte(a,weasel.FormatSpreadpointSoundTracker23.SongLength)>weasel.FormatUltimateSoundTracker121.SequenceTableLength){this.sReason="Song length too long (maximum 128 patterns).";return true}return false};
weasel.ModuleSniffer.prototype.__FSTLengthOfSong=function(a){if(a.length<weasel.FormatFSTModule.MinimumHeaderSize){this.sReason="Data size is too small for Module, need at least "+weasel.FormatFSTModule.MinimumHeaderSize+" bytes for a header and at least one song pattern (not including instruments).";return true}return this.__SoundtrackerLengthOfSong(a)};
weasel.ModuleSniffer.prototype.__uniqueNumberOfPatterns=function(a){return this.__uniquePatterns(a,weasel.FormatUltimateSoundTracker121.PatternSequenceTable,weasel.FormatUltimateSoundTracker121.SequenceTableLength)};weasel.ModuleSniffer.prototype.__MKUniqueNumberOfPatterns=function(a){return this.__uniquePatterns(a,weasel.FormatSpreadpointSoundTracker23.PatternSequenceTable,weasel.FormatUltimateSoundTracker121.SequenceTableLength)};
weasel.ModuleSniffer.prototype.__uniquePatterns=function(a,b,c){if(this.iUniquePatterns>-1)return this.iUniquePatterns;for(var d=0,e=0;e<c;e++){var f=weasel.Helper.getByte(a,b+e);f>d&&(d=f)}return this.iUniquePatterns=d+1};
weasel.ModuleSniffer.prototype.__MKSoundtrackerCheckNumberOfPatterns=function(a){var b=this.__MKUniqueNumberOfPatterns(a);if(b>weasel.FormatUltimateSoundTracker121.MaxUniquePatterns){this.sReason="Pattern sequence number to big (expected 0-63).";return true}var c=b*weasel.FormatUltimateSoundTracker121.PatternSize+weasel.FormatSpreadpointSoundTracker23.PatternData;if(c>a.length){this.sReason="Soundtracker Module data too small to contain all patterns in pattern sequence. There are "+b+" pattern(s), which would need at least "+
c+" bytes (not including samples).";return true}return false};weasel.ModuleSniffer.prototype.__FSTGetNumberOfChannels=function(a){var b=weasel.Helper.getByte(a,weasel.FormatSpreadpointSoundTracker23.MKFingerPrint)-48,a=weasel.Helper.getByte(a,weasel.FormatSpreadpointSoundTracker23.MKFingerPrint+1)-48;b<0&&(b=0);a<0&&(a=0);return a>9?b:b*10+a};
weasel.ModuleSniffer.prototype.__FSTCheckNumberOfPatterns=function(a){var b=this.__MKUniqueNumberOfPatterns(a),c=this.__FSTGetNumberOfChannels(a);if(c<2||c>32){this.sReason="Taketracker/Fasttracker Module has out of range number of expected channels [2-32], this module has: "+c+".";return true}var d=c*b*weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern*weasel.FormatUltimateSoundTracker121.BytesPerRowCell+weasel.FormatSpreadpointSoundTracker23.PatternData;if(d>a.length){this.sReason="Taketracker/Fasttracker Module data too small to contain all patterns in pattern sequence. There are "+
c+" channels and "+b+" pattern(s), which would need at least "+d+" bytes (not including samples).";return true}return false};
weasel.ModuleSniffer.prototype.__SoundtrackerCheckNumberOfPatterns=function(a){var b=this.__uniqueNumberOfPatterns(a);if(b>weasel.FormatUltimateSoundTracker121.MaxUniquePatterns){this.sReason="Pattern sequence number to big (expected 0-63).";return true}var c=b*weasel.FormatUltimateSoundTracker121.PatternSize+weasel.FormatUltimateSoundTracker121.PatternData;if(c>a.length){this.sReason="Soundtracker Module data too small to contain all patterns in pattern sequence. There are "+b+" pattern(s), which would need at least "+
c+" bytes (not including samples).";return true}return false};
weasel.ModuleSniffer.prototype.__UltimateSoundtrackerCheckInstruments=function(a,b,c,d){for(var e=this.__uniqueNumberOfPatterns(a),f=e*weasel.FormatUltimateSoundTracker121.PatternSize+weasel.FormatUltimateSoundTracker121.ModuleHeaderSize,g=weasel.FormatUltimateSoundTracker121.SampleHeaders,h=true,i=0,j=0;j<weasel.FormatUltimateSoundTracker121.NumberOfInstruments;j++){var k=weasel.Helper.getWord(a,g+weasel.FormatUltimateSoundTracker121.SampleHeader.LengthInWords)*2,l=weasel.Helper.getWord(a,g+weasel.FormatUltimateSoundTracker121.SampleHeader.Volume),
m=weasel.Helper.getWord(a,g+weasel.FormatUltimateSoundTracker121.SampleHeader.RepeatOffsetInBytes),n=weasel.Helper.getWord(a,g+weasel.FormatUltimateSoundTracker121.SampleHeader.RepeatLengthInWords)*2,g=g+weasel.FormatUltimateSoundTracker121.SampleHeader.HeaderSize,i=i+k;if(k>c){this.sReason="Instrument #"+(j+1)+" sample length too long for "+b+", which is limited to "+c+" bytes in length.";return true}l>0&&(h=false);if(l>64){this.sReason="Instrument #"+(j+1)+" volume to large, 0-64 range only.";return true}if(n>=
4&&f+m+n>a.length&&k>0){this.sReason="Instrument Sample #"+(j+1)+" loop point (File offset byte "+(f+m)+") and loop length ("+n+" bytes) do not fit within the modules file size: "+a.length+" bytes.";return true}f=f+k}if(0==i){this.sReason="All instrument samples have zero length.";return true}if(h&&b!=weasel.ModuleSniffer.prototype.SupportedModules.DOCSoundTracker9){this.sReason="All instrument samples have zero volume.";return true}if(weasel.FormatUltimateSoundTracker121.MinimumHeaderSize+i>a.length){this.sReason=
"Total Instrument Sample lengths are too big to fit in module (computed length is: "+(weasel.FormatUltimateSoundTracker121.MinimumHeaderSize+i)+" bytes but only have "+a.length+" bytes).";return true}b=weasel.FormatUltimateSoundTracker121.PatternData+i+e*weasel.FormatUltimateSoundTracker121.PatternSize;d=d?a.length-16:a.length;if(b>a.length||b<d){this.sReason="Computed module file size mismatch, computed size (header + patterns + samples) is: "+b+" bytes, but file is "+a.length+" bytes.";return true}return false};
weasel.ModuleSniffer.prototype.__Spreadpoint23SoundtrackerCheckInstruments=function(a,b,c,d,e,f,g){for(var h=this.__MKUniqueNumberOfPatterns(a),i=h*g+weasel.FormatSpreadpointSoundTracker23.ModuleHeaderSize,j=weasel.FormatUltimateSoundTracker121.SampleHeaders,k=0,l=0;l<weasel.FormatSpreadpointSoundTracker23.NumberOfInstruments;l++){var m=weasel.Helper.getWord(a,j+weasel.FormatUltimateSoundTracker121.SampleHeader.LengthInWords)*2,n=weasel.Helper.getWord(a,j+weasel.FormatUltimateSoundTracker121.SampleHeader.Volume)&
(e?255:65535),o=weasel.Helper.getWord(a,j+weasel.FormatUltimateSoundTracker121.SampleHeader.RepeatOffsetInBytes),q=weasel.Helper.getWord(a,j+weasel.FormatUltimateSoundTracker121.SampleHeader.RepeatLengthInWords)*2;weasel.Helper.getByte(a,j+weasel.FormatUltimateSoundTracker121.SampleHeader.Volume);j=j+weasel.FormatUltimateSoundTracker121.SampleHeader.HeaderSize;k=k+m;d&&(o=o*2);if(m>c){this.sReason="Instrument #"+(l+1)+" sample length too long for "+b+", which is limited to "+c+" bytes in length.";
return true}f&&(n=n&255);if(n>64){this.sReason="Instrument #"+(l+1)+" volume to large, 0-64 range only.";return true}if(q>=4&&i+o+q>a.length&&m>0){this.sReason="Instrument Sample #"+(l+1)+" loop point (File offset byte "+(i+o)+") and loop length ("+q+" bytes) do not fit within the modules file size: "+a.length+" bytes.";return true}i=i+m}if(0==k){this.sReason="All instrument samples have zero length.";return true}if(weasel.FormatSpreadpointSoundTracker23.ModuleHeaderSize+g+k>a.length){this.sReason=
"Total Instrument Sample lengths are too big to fit in module (computed length is: "+(weasel.FormatSpreadpointSoundTracker23.ModuleHeaderSize+g+k)+" bytes but only have "+a.length+" bytes).";return true}b=weasel.FormatSpreadpointSoundTracker23.PatternData+k+h*g;e=e?a.length-16:a.length;if(b>a.length||b<e){this.sReason="Computed module file size mismatch, computed size (header + patterns + samples) is: "+b+" bytes, but file is "+a.length+" bytes.";return true}return false};
weasel.ModuleSniffer.prototype.__ultimateSoundtracker121EffectCheck=function(a,b){return a==weasel.FormatUltimateSoundTracker121.Effects.Arpeggio&&!(b==1||b==2)||a==weasel.FormatUltimateSoundTracker121.Effects.Pitchbend&&!((b>>4&15)!=0&&(b&15)!=0)||a==weasel.FormatUltimateSoundTracker121.Effects.None&&b==0};
weasel.ModuleSniffer.prototype.__DOCSoundtracker9EffectCheck=function(a,b){return a==weasel.FormatDOCSoundTracker9.Effects.Arpeggio||a==weasel.FormatDOCSoundTracker9.Effects.PitchbendUp||a==weasel.FormatDOCSoundTracker9.Effects.PitchbendDown||a==weasel.FormatDOCSoundTracker9.Effects.Volume||a==weasel.FormatDOCSoundTracker9.Effects.Filter&&(b==0||b==1)||a==weasel.FormatDOCSoundTracker9.Effects.TickSpeed&&b>=2&&b<=15};
weasel.ModuleSniffer.prototype.__DOCSoundtracker22EffectCheck=function(a,b){return a==weasel.FormatDOCSoundTracker9.Effects.Arpeggio||a==weasel.FormatDOCSoundTracker9.Effects.PitchbendUp||a==weasel.FormatDOCSoundTracker9.Effects.PitchbendDown||a==weasel.FormatDOCSoundTracker22.Effects.SequencePositionJump&&b>=0&&b<=127||a==weasel.FormatDOCSoundTracker9.Effects.Volume||a==weasel.FormatDOCSoundTracker22.Effects.PatternBreak&&b==0||a==weasel.FormatDOCSoundTracker9.Effects.Filter&&(b==0||b==1)||a==weasel.FormatDOCSoundTracker9.Effects.TickSpeed&&
b>=0&&b<=15};
weasel.ModuleSniffer.prototype.__TJCSoundtracker2EffectCheck=function(a,b){if(a>=weasel.FormatTJCSoundTracker2.Effects.ModulateVolume&&a<=weasel.FormatTJCSoundTracker2.Effects.ModulatePeriodPitchbendDown&&b!=0)this.bTJCSpecificCommandFound=true;if(a==weasel.FormatTJCSoundTracker2.Effects.SlideVolume&&b>0||a==weasel.FormatTJCSoundTracker2.Effects.AutoSlide&&b>1)this.bTJCSlideCommandsLookValid=true;return a>=weasel.FormatTJCSoundTracker2.Effects.Arpeggio&&a<=weasel.FormatTJCSoundTracker2.Effects.AutoSlide||a==
weasel.FormatDefJamSoundTracker3.Effects.TickSpeed&&b==6};
weasel.ModuleSniffer.prototype.__SpreadpointSoundtracker23EffectCheck=function(a,b){return a==weasel.FormatDOCSoundTracker9.Effects.Arpeggio||a==weasel.FormatDOCSoundTracker9.Effects.PitchbendUp||a==weasel.FormatDOCSoundTracker9.Effects.PitchbendDown||a==weasel.FormatSpreadpointSoundTracker23.Effects.VolumeSlide||a==weasel.FormatDOCSoundTracker22.Effects.SequencePositionJump&&b>=0&&b<=127||a==weasel.FormatDOCSoundTracker9.Effects.Volume||a==weasel.FormatDOCSoundTracker22.Effects.PatternBreak&&b==
0||a==weasel.FormatDOCSoundTracker9.Effects.Filter&&(b==0||b==1)||a==weasel.FormatDOCSoundTracker9.Effects.TickSpeed&&b>=0&&b<=15};
weasel.ModuleSniffer.prototype.__Noisetracker11EffectCheck=function(a,b){return a==weasel.FormatDOCSoundTracker9.Effects.Arpeggio||a==weasel.FormatDOCSoundTracker9.Effects.PitchbendUp||a==weasel.FormatDOCSoundTracker9.Effects.PitchbendDown||a==weasel.FormatNoiseTracker11.Effects.TonePortamento||a==weasel.FormatNoiseTracker11.Effects.Vibrato||a==weasel.FormatSpreadpointSoundTracker23.Effects.VolumeSlide||a==weasel.FormatDOCSoundTracker22.Effects.SequencePositionJump&&b>=0&&b<=127||a==weasel.FormatDOCSoundTracker9.Effects.Volume||
a==weasel.FormatDOCSoundTracker22.Effects.PatternBreak&&b==0||a==weasel.FormatDOCSoundTracker9.Effects.Filter&&(b==0||b==1)||a==weasel.FormatDOCSoundTracker9.Effects.TickSpeed};
weasel.ModuleSniffer.prototype.__Noisetracker20EffectCheck=function(a,b){return a==weasel.FormatDOCSoundTracker9.Effects.Arpeggio||a==weasel.FormatDOCSoundTracker9.Effects.PitchbendUp||a==weasel.FormatDOCSoundTracker9.Effects.PitchbendDown||a==weasel.FormatNoiseTracker11.Effects.TonePortamento||a==weasel.FormatNoiseTracker11.Effects.Vibrato||a==weasel.FormatNoiseTracker20.Effects.TonePortamentoAndVolumeSlide||a==weasel.FormatNoiseTracker20.Effects.VibratoAndVolumeSlide||a==weasel.FormatSpreadpointSoundTracker23.Effects.VolumeSlide||
a==weasel.FormatDOCSoundTracker22.Effects.SequencePositionJump&&b>=0&&b<=127||a==weasel.FormatDOCSoundTracker9.Effects.Volume||a==weasel.FormatDOCSoundTracker22.Effects.PatternBreak&&b==0||a==weasel.FormatDOCSoundTracker9.Effects.Filter&&(b==0||b==1)||a==weasel.FormatDOCSoundTracker9.Effects.TickSpeed};weasel.ModuleSniffer.prototype.__ProtrackerEffectCheck=function(a,b){return!(8==a||14==a&&8==b>>4)};
weasel.ModuleSniffer.prototype.__FSTEffectCheck=function(a,b){if(8==a||14==a&&8==b>>4){var c=0;if(8==a){c=b;this.fPanningMean=this.fPanningMean+c;this.iPanningEffectTotal++;this.aPanningPositions.push(c)}else this.bCoarsePanningUsed=true;if(c>this.iMaxPanningPosition)this.iMaxPanningPosition=c}return true};
weasel.ModuleSniffer.prototype.__DefJamSoundtracker3EffectCheck=function(a,b){if(a>=weasel.FormatTJCSoundTracker2.Effects.ModulateVolume&&a<=weasel.FormatTJCSoundTracker2.Effects.ModulatePeriodPitchbendDown&&b!=0)this.bTJCSpecificCommandFound=true;if(a==weasel.FormatTJCSoundTracker2.Effects.SlideVolume&&b>0||a==weasel.FormatTJCSoundTracker2.Effects.AutoSlide&&b>1)this.bTJCSlideCommandsLookValid=true;return a>=weasel.FormatTJCSoundTracker2.Effects.Arpeggio&&a<=weasel.FormatTJCSoundTracker2.Effects.AutoSlide||
a==weasel.FormatDefJamSoundTracker3.Effects.TickSpeed&&b>=0&&b<=15};weasel.ModuleSniffer.prototype.__compareNumbers=function(a,b){return a-b};
weasel.ModuleSniffer.prototype.__soundtrackerScanPatternEffects=function(a,b,c){if(c)return false;if("function"!==typeof b){this.sReason="Internal error, a bad (or missing) effect checker has been passed to the Pattern Effect scanner (part of the Module Sniffer) and is unable to scan the pattern effects.";return true}for(var d=weasel.Helper.getByte(a,weasel.FormatUltimateSoundTracker121.SongLength),e=[],f=0;f<d;f++){var g=weasel.Helper.getByte(a,weasel.FormatUltimateSoundTracker121.PatternSequenceTable+
f);e.push(g)}for(var e=e.sort(this.__compareNumbers),d=-1,f=e.length,h=0;h<f;h++){g=e[h];if(d!=g)for(var d=g,i=g*weasel.FormatUltimateSoundTracker121.PatternSize+weasel.FormatUltimateSoundTracker121.PatternSize+weasel.FormatUltimateSoundTracker121.PatternData,j=weasel.FormatUltimateSoundTracker121.PatternSize/weasel.FormatUltimateSoundTracker121.BytesPerRowCell;--j>=0;){var i=i-weasel.FormatUltimateSoundTracker121.BytesPerRowCell,k=weasel.Helper.getByte(a,i+weasel.FormatUltimateSoundTracker121.Channel.Effect)&
weasel.FormatUltimateSoundTracker121.Channel.EffectMask,l=weasel.Helper.getByte(a,i+weasel.FormatUltimateSoundTracker121.Channel.EffectParameters);if(!c&&!b.call(this,k,l)){this.sReason='Unsupported sound effects used "0x'+(k>>>4).toString(16)+(k&15).toString(16)+'" with effect data "0x'+(l>>>4).toString(16)+(l&15).toString(16)+'" in Pattern: '+g+", Row: "+(j/weasel.FormatUltimateSoundTracker121.NumberOfChannels|0)+", Channel: "+(j%weasel.FormatUltimateSoundTracker121.NumberOfChannels+1)+".";return true}}}return false};
weasel.ModuleSniffer.prototype.__checkBadNotePeriod=function(a){if(a>856)return true;for(var b=a>=453?12:a>=226?24:37,c=weasel.FormatUltimateSoundTracker121.PeriodTable;--b>=0;){var d=c[b];if(a==d)return false;if(a<d)break}return true};weasel.ModuleSniffer.prototype.__checkBadNotePeriodFST=function(a){return a>4064||a!=0&&a<28?true:false};
weasel.ModuleSniffer.prototype.__MKSoundtrackerScanPatternEffects=function(a,b,c,d,e){if(e)return false;if("function"!==typeof b){this.sReason="Internal error, a bad (or missing) effect checker has been passed to the Pattern Effect scanner (part of the Module Sniffer) and is unable to scan the pattern effects.";return true}if("function"!==typeof c){this.sReason="Internal error, a bad (or missing) note period checker has been passed to the Pattern Effect scanner (part of the Module Sniffer) and is unable to scan the pattern note period values.";
return true}for(var f=d/(weasel.FormatUltimateSoundTracker121.BytesPerRowCell*weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern)|0,g=weasel.Helper.getByte(a,weasel.FormatSpreadpointSoundTracker23.SongLength),h=[],i=0;i<g;i++){var j=weasel.Helper.getByte(a,weasel.FormatSpreadpointSoundTracker23.PatternSequenceTable+i);h.push(j)}for(var h=h.sort(this.__compareNumbers),g=-1,i=h.length,k=0;k<i;k++){j=h[k];if(g!=j)for(var g=j,l=j*d+d+weasel.FormatSpreadpointSoundTracker23.PatternData,m=d/weasel.FormatUltimateSoundTracker121.BytesPerRowCell|
0;--m>=0;){var l=l-weasel.FormatUltimateSoundTracker121.BytesPerRowCell,n=weasel.Helper.getByte(a,l+weasel.FormatUltimateSoundTracker121.Channel.InstrumentNumber)>>4&15|weasel.Helper.getByte(a,l+weasel.FormatUltimateSoundTracker121.Channel.Note)&240,o=weasel.Helper.getWord(a,l+weasel.FormatUltimateSoundTracker121.Channel.Note)&4095;if(0!=o&&c(o)){this.sReason='Nonstandard note period value used, maybe corrupt: "'+o+'" in Pattern: '+j+", Row: "+(m/f|0)+", Channel: "+(m%f+1)+".";return true}if(n>31){this.sReason=
'Too high Instrument Number found: "'+n+'" (maximum is 31) in Pattern: '+j+", Row: "+(m/f|0)+", Channel: "+(m%f+1)+".";return true}n=weasel.Helper.getByte(a,l+weasel.FormatUltimateSoundTracker121.Channel.Effect)&weasel.FormatUltimateSoundTracker121.Channel.EffectMask;o=weasel.Helper.getByte(a,l+weasel.FormatUltimateSoundTracker121.Channel.EffectParameters);if(!e&&!b.call(this,n,o)){this.sReason='Unsupported sound effects used "0x'+(n>>>4).toString(16)+(n&15).toString(16)+'" with effect data "0x'+
(o>>>4).toString(16)+(o&15).toString(16)+'" in Pattern: '+j+", Row: "+(m/f|0)+", Channel: "+(m%f+1)+".";return true}}}return false};
weasel.ModuleSniffer.prototype.__sniffForUltimateSoundtracker121=function(a,b){if(!this.__UltimateSoundtrackerLengthOfSong(a))if(120!=weasel.Helper.getByte(a,weasel.FormatUltimateSoundTracker121.SongSpeed)&&false==b)this.sReason="Song Speed is not 120 BPM.";else if(!this.__SoundtrackerCheckNumberOfPatterns(a)&&!this.__UltimateSoundtrackerCheckInstruments(a,weasel.ModuleSniffer.prototype.SupportedModules.UltimateSoundTracker121,b?131070:weasel.FormatUltimateSoundTracker121.MaxSampleSize,b)&&!this.__soundtrackerScanPatternEffects(a,
this.__ultimateSoundtracker121EffectCheck,b)){this.sModuleType=this.SupportedModules.UltimateSoundTracker121;this.sReason="ok"}};
weasel.ModuleSniffer.prototype.__sniffForUltimateSoundtracker18=function(a,b){if(!this.__UltimateSoundtrackerLengthOfSong(a)){var c=weasel.Helper.getByte(a,weasel.FormatUltimateSoundTracker121.SongSpeed);if(c<0||c>220)this.sReason="Song Speed is out of range (expected 0-220).";else if(!this.__SoundtrackerCheckNumberOfPatterns(a)&&!this.__UltimateSoundtrackerCheckInstruments(a,weasel.ModuleSniffer.prototype.SupportedModules.UltimateSoundTracker18,b?131070:weasel.FormatUltimateSoundTracker121.MaxSampleSize,
b)&&!this.__soundtrackerScanPatternEffects(a,this.__ultimateSoundtracker121EffectCheck,b)){this.sModuleType=this.SupportedModules.UltimateSoundTracker18;this.sReason="ok"}}};
weasel.ModuleSniffer.prototype.__sniffForDOCSoundtracker9=function(a,b){if(!this.__UltimateSoundtrackerLengthOfSong(a)){var c=weasel.Helper.getByte(a,weasel.FormatUltimateSoundTracker121.SongSpeed);if(c<0||c>220)this.sReason="Song Speed is out of range (expected 0-220).";else if(!this.__SoundtrackerCheckNumberOfPatterns(a)&&!this.__UltimateSoundtrackerCheckInstruments(a,weasel.ModuleSniffer.prototype.SupportedModules.DOCSoundTracker9,b?131070:weasel.FormatDOCSoundTracker9.MaxSampleSize,b)&&!this.__soundtrackerScanPatternEffects(a,
this.__DOCSoundtracker9EffectCheck,b)){this.sModuleType=this.SupportedModules.DOCSoundTracker9;this.sReason="ok"}}};
weasel.ModuleSniffer.prototype.__sniffForDOCSoundtracker22=function(a,b){if(!this.__UltimateSoundtrackerLengthOfSong(a))if(weasel.Helper.getByte(a,weasel.FormatUltimateSoundTracker121.SongSpeed)!=120&&false==b)this.sReason="Song Speed is out of range (expected 120).";else if(!this.__SoundtrackerCheckNumberOfPatterns(a)&&!this.__UltimateSoundtrackerCheckInstruments(a,weasel.ModuleSniffer.prototype.SupportedModules.DOCSoundTracker22,b?131070:weasel.FormatDOCSoundTracker9.MaxSampleSize,b)&&!this.__soundtrackerScanPatternEffects(a,
this.__DOCSoundtracker22EffectCheck,b)){this.sModuleType=this.SupportedModules.DOCSoundTracker22;this.sReason="ok"}};
weasel.ModuleSniffer.prototype.__sniffForTJCSoundtracker2=function(a,b){if(!this.__UltimateSoundtrackerLengthOfSong(a))if(weasel.Helper.getByte(a,weasel.FormatUltimateSoundTracker121.SongSpeed)!=120&&false==b)this.sReason="Song Speed is out of range (expected 120).";else if(!this.__SoundtrackerCheckNumberOfPatterns(a)&&!this.__UltimateSoundtrackerCheckInstruments(a,weasel.ModuleSniffer.prototype.SupportedModules.TJCSoundTracker2,b?131070:weasel.FormatTJCSoundTracker2.MaxSampleSize,b)&&!this.__soundtrackerScanPatternEffects(a,
this.__TJCSoundtracker2EffectCheck,b))if(false==b&&false==this.bTJCSlideCommandsLookValid&&false==this.bTJCSpecificCommandFound)this.sReason="The VolumeSlide or AutoSlide commands have parameters which look more like DOC Soundtracker 9/2.2 PatternBreak and Filter commands.";else{this.sModuleType=this.SupportedModules.TJCSoundTracker2;this.sReason="ok"}};
weasel.ModuleSniffer.prototype.__sniffForDefJamSoundtracker3=function(a,b){if(!this.__UltimateSoundtrackerLengthOfSong(a))if(weasel.Helper.getByte(a,weasel.FormatUltimateSoundTracker121.SongSpeed)!=120&&false==b)this.sReason="Song Speed is out of range (expected 120).";else if(!this.__SoundtrackerCheckNumberOfPatterns(a)&&!this.__UltimateSoundtrackerCheckInstruments(a,weasel.ModuleSniffer.prototype.SupportedModules.TJCSoundTracker2,b?131070:weasel.FormatTJCSoundTracker2.MaxSampleSize,b)&&!this.__soundtrackerScanPatternEffects(a,
this.__DefJamSoundtracker3EffectCheck,b))if(false==b&&false==this.bTJCSlideCommandsLookValid&&false==this.bTJCSpecificCommandFound)this.sReason="The VolumeSlide or AutoSlide commands have parameters which look more like DOC Soundtracker 9/2.2 PatternBreak and Filter commands.";else{this.sModuleType=this.SupportedModules.DefJamSoundTracker3;this.sReason="ok"}};
weasel.ModuleSniffer.prototype.__sniffForMichaelKlepsID=function(a){return void 0==a||a.length<weasel.FormatSpreadpointSoundTracker23.ModuleHeaderSize?false:-1!=weasel.Helper.searchArrayForString(a,weasel.FormatSpreadpointSoundTracker23.MKFingerPrint,weasel.FormatSpreadpointSoundTracker23.MKFingerPrint+4,"M.K.")?true:false};
weasel.ModuleSniffer.prototype.__sniffForMahoneyAndKaktusID=function(a){if(void 0==a||a.length<weasel.FormatSpreadpointSoundTracker23.ModuleHeaderSize)return false;for(var b=["FLT4","GLUE","X:-K","M&K!","M.K."],c=b.length;--c>=0;)if(-1!=weasel.Helper.searchArrayForString(a,weasel.FormatSpreadpointSoundTracker23.MKFingerPrint,weasel.FormatSpreadpointSoundTracker23.MKFingerPrint+4,b[c]))return true;return false};
weasel.ModuleSniffer.prototype.__sniffForFSTModuleID=function(a){if(void 0==a||a.length<weasel.FormatSpreadpointSoundTracker23.ModuleHeaderSize)return false;if(-1!=weasel.Helper.searchArrayForString(a,weasel.FormatSpreadpointSoundTracker23.MKFingerPrint+2,weasel.FormatSpreadpointSoundTracker23.MKFingerPrint+4,"CH")){var b=weasel.Helper.getByte(a,weasel.FormatSpreadpointSoundTracker23.MKFingerPrint)-48;if(b>=0&&b<=3){a=weasel.Helper.getByte(a,weasel.FormatSpreadpointSoundTracker23.MKFingerPrint+1)-
48;if(a>=0&&a<=9){b=b*10+a;if(b>=2&&b<=32)return true}}}else if(-1!=weasel.Helper.searchArrayForString(a,weasel.FormatSpreadpointSoundTracker23.MKFingerPrint+1,weasel.FormatSpreadpointSoundTracker23.MKFingerPrint+4,"CHN")){b=weasel.Helper.getByte(a,weasel.FormatSpreadpointSoundTracker23.MKFingerPrint)-48;if(b>=2&&b<=9)return true}return false};
weasel.ModuleSniffer.prototype.__sniffForSpreadpointSoundtracker23=function(a,b){if(!this.__MichaelKlepsSoundtrackerLengthOfSong(a))if(false==this.__sniffForMichaelKlepsID(a))this.sReason='No "M.K." ID mark found in module.';else{var c=weasel.Helper.getByte(a,weasel.FormatSpreadpointSoundTracker23.SongSpeed);if(120!=c&&false==b)this.sReason="Song Speed is not 120 BPM, its set to: "+c;else if(!this.__MKSoundtrackerCheckNumberOfPatterns(a)&&!this.__Spreadpoint23SoundtrackerCheckInstruments(a,weasel.ModuleSniffer.prototype.SupportedModules.SpreadpointSoundTracker23,
b?131070:weasel.FormatSpreadpointSoundTracker23.MaxSampleSize,false,b,false,weasel.FormatUltimateSoundTracker121.PatternSize)&&!this.__MKSoundtrackerScanPatternEffects(a,this.__SpreadpointSoundtracker23EffectCheck,this.__checkBadNotePeriod,weasel.FormatUltimateSoundTracker121.PatternSize,b)){this.sModuleType=this.SupportedModules.SpreadpointSoundTracker23;this.sReason="ok"}}};
weasel.ModuleSniffer.prototype.__sniffForSpreadpointSoundtracker25=function(a,b){if(!this.__MichaelKlepsSoundtrackerLengthOfSong(a))if(false==this.__sniffForMichaelKlepsID(a))this.sReason='No "M.K." ID mark found in module.';else{var c=weasel.Helper.getByte(a,weasel.FormatSpreadpointSoundTracker23.SongSpeed);if(120!=c&&false==b)this.sReason="Song Speed is not 120 BPM, its set to: "+c;else if(!this.__MKSoundtrackerCheckNumberOfPatterns(a)&&!this.__Spreadpoint23SoundtrackerCheckInstruments(a,weasel.ModuleSniffer.prototype.SupportedModules.SpreadpointSoundTracker25,
b?131070:weasel.FormatSpreadpointSoundTracker25.MaxSampleSize,true,b,false,weasel.FormatUltimateSoundTracker121.PatternSize)&&!this.__MKSoundtrackerScanPatternEffects(a,this.__Noisetracker11EffectCheck,this.__checkBadNotePeriod,weasel.FormatUltimateSoundTracker121.PatternSize,b)){this.sModuleType=this.SupportedModules.SpreadpointSoundTracker25;this.sReason="ok"}}};
weasel.ModuleSniffer.prototype.__sniffForNoisetracker11=function(a,b){if(!this.__MichaelKlepsSoundtrackerLengthOfSong(a))if(false==this.__sniffForMichaelKlepsID(a))this.sReason='No "M.K." ID mark found in module.';else{var c=weasel.Helper.getByte(a,weasel.FormatSpreadpointSoundTracker23.SongLength),d=weasel.Helper.getByte(a,weasel.FormatNoiseTracker11.SongRestartPosition);if(d>=c&&false==b)this.sReason="Song Restart Position ("+d+") is greater that Song Length ("+c+")";else if(!this.__MKSoundtrackerCheckNumberOfPatterns(a)&&
!this.__Spreadpoint23SoundtrackerCheckInstruments(a,weasel.ModuleSniffer.prototype.SupportedModules.NoiseTracker11,b?131070:weasel.FormatSpreadpointSoundTracker23.MaxSampleSize,true,b,false,weasel.FormatUltimateSoundTracker121.PatternSize)&&!this.__MKSoundtrackerScanPatternEffects(a,this.__Noisetracker11EffectCheck,this.__checkBadNotePeriod,weasel.FormatUltimateSoundTracker121.PatternSize,b)){this.sModuleType=this.SupportedModules.NoiseTracker11;this.sReason="ok"}}};
weasel.ModuleSniffer.prototype.__sniffForNoisetracker20=function(a,b){if(!this.__MichaelKlepsSoundtrackerLengthOfSong(a))if(false==this.__sniffForMahoneyAndKaktusID(a))this.sReason='No "M.K." ID mark found in module (or "M&K!", "GLUE", "X:-K", "FLT4").';else{var c=weasel.Helper.getByte(a,weasel.FormatSpreadpointSoundTracker23.SongLength),d=weasel.Helper.getByte(a,weasel.FormatNoiseTracker11.SongRestartPosition);if(d>=c&&false==b)this.sReason="Song Restart Position ("+d+") is greater that Song Length ("+
c+")";else if(!this.__MKSoundtrackerCheckNumberOfPatterns(a)&&!this.__Spreadpoint23SoundtrackerCheckInstruments(a,weasel.ModuleSniffer.prototype.SupportedModules.NoiseTracker20,131070,true,true,false,weasel.FormatUltimateSoundTracker121.PatternSize)&&!this.__MKSoundtrackerScanPatternEffects(a,this.__Noisetracker20EffectCheck,this.__checkBadNotePeriod,weasel.FormatUltimateSoundTracker121.PatternSize,b)){this.sModuleType=this.SupportedModules.NoiseTracker20;this.sReason="ok"}}};
weasel.ModuleSniffer.prototype.__sniffForProtrackerMK=function(a,b){if(!this.__MichaelKlepsSoundtrackerLengthOfSong(a))if(false==this.__sniffForMichaelKlepsID(a))this.sReason='No "M.K." ID mark found in module.';else{weasel.Helper.getByte(a,weasel.FormatSpreadpointSoundTracker23.SongLength);var c=weasel.Helper.getByte(a,weasel.FormatProTrackerMK.ProtrackerMarker);if(c!=127&&false==b)this.sReason="Protracker marker byte not found, should be 127 but was:"+c;else if(!this.__MKSoundtrackerCheckNumberOfPatterns(a)&&
!this.__Spreadpoint23SoundtrackerCheckInstruments(a,weasel.ModuleSniffer.prototype.SupportedModules.ProTrackerMK,weasel.FormatProTrackerMK.MaxSampleSize,true,b,true,weasel.FormatUltimateSoundTracker121.PatternSize)&&!this.__MKSoundtrackerScanPatternEffects(a,this.__ProtrackerEffectCheck,this.__checkBadNotePeriod,weasel.FormatUltimateSoundTracker121.PatternSize,b)){this.sModuleType=this.SupportedModules.ProTrackerMK;this.sReason="ok"}}};
weasel.ModuleSniffer.prototype.__sniffForFSTModule=function(a,b){if(!this.__FSTLengthOfSong(a))if(false==this.__sniffForFSTModuleID(a))this.sReason="No TakeTracker/FastTracker module [xxCH|xCHN] ID mark found in module.";else{var c=this.__FSTGetNumberOfChannels(a);if(!this.__FSTCheckNumberOfPatterns(a)&&!this.__Spreadpoint23SoundtrackerCheckInstruments(a,weasel.ModuleSniffer.prototype.SupportedModules.FSTModule,weasel.FormatProTrackerMK.MaxSampleSize,true,b,true,c*weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern*
weasel.FormatUltimateSoundTracker121.BytesPerRowCell)&&!this.__MKSoundtrackerScanPatternEffects(a,this.__FSTEffectCheck,this.__checkBadNotePeriodFST,c*weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern*weasel.FormatUltimateSoundTracker121.BytesPerRowCell,b)){this.sModuleType=this.SupportedModules.FSTModule;this.sReason="ok"}}};
weasel.ModuleSniffer.prototype.sniff=function(a,b){this.__reset();if(a instanceof Array||window.Uint8Array&&a instanceof Uint8Array){if(this.__sniffForFSTModuleID(a)){this.__sniffForFSTModule(a,false);if("ok"==this.sReason)return}else this.sReason="No TakeTracker/FastTracker module [xxCH|xCHN] ID mark found in module.";this.oSniffReasons.FSTModule=this.sReason;if(this.__sniffForMahoneyAndKaktusID(a)){this.__sniffForSpreadpointSoundtracker23(a,false);if("ok"!=this.sReason){this.oSniffReasons.SpreadpointSoundtracker23=
this.sReason;this.__sniffForNoisetracker11(a,false)}if("ok"!=this.sReason){this.oSniffReasons.Noisetracker11=this.sReason;this.__sniffForNoisetracker20(a,false)}if("ok"!=this.sReason){this.oSniffReasons.Noisetracker20=this.sReason;this.__sniffForSpreadpointSoundtracker25(a,false)}if("ok"!=this.sReason){this.oSniffReasons.SpreadpointSoundtracker25=this.sReason;this.__sniffForProtrackerMK(a,b)}if("ok"!=this.sReason)this.oSniffReasons.ProtrackerMK=this.sReason}else{this.oSniffReasons.MKModules='One of the "M.K." ID markers [M.K.|M&K!|X:-K|GLUE|FLT4] is missing from the file indicating it is not a 31 sample Soundtracker, Noisetracker or Protracker module.';
this.iUniquePatterns=-1;this.__sniffForUltimateSoundtracker121(a,false);if("ok"!=this.sReason){this.oSniffReasons.UltimateSoundtracker121=this.sReason;this.__sniffForUltimateSoundtracker18(a,false)}if("ok"!=this.sReason){this.oSniffReasons.UltimateSoundtracker18=this.sReason;this.__sniffForDOCSoundtracker9(a,false)}if("ok"!=this.sReason){this.oSniffReasons.DOCSoundtracker9=this.sReason;this.bTJCSpecificCommandFound=this.bTJCSlideCommandsLookValid=false;this.__sniffForTJCSoundtracker2(a,false)}if("ok"!=
this.sReason){this.oSniffReasons.TJCSoundtracker2=this.sReason;this.bTJCSpecificCommandFound=this.bTJCSlideCommandsLookValid=false;this.__sniffForDefJamSoundtracker3(a,false)}if("ok"!=this.sReason){this.oSniffReasons.DefJamSoundtracker3=this.sReason;this.__sniffForDOCSoundtracker22(a,b)}if("ok"!=this.sReason)this.oSniffReasons.DOCSoundtracker22=this.sReason}}else this.sReason="Passed Soundtracker module data is not an Array type."};weasel.ModuleSniffer.prototype.getModuleType=function(){return this.sModuleType};
weasel.ModuleSniffer.prototype.getReason=function(){return this.sReason};weasel.ModuleSniffer.prototype.getAllReasons=function(){return this.oSniffReasons};
weasel.ModuleSniffer.prototype.createModule=function(a,b,c){if("ok"==this.sReason)switch(this.sModuleType){case this.SupportedModules.UltimateSoundTracker121:return new weasel.UltimateSoundTracker121(a,b,c);case this.SupportedModules.UltimateSoundTracker18:return new weasel.UltimateSoundTracker18(a,b,c);case this.SupportedModules.DOCSoundTracker9:return new weasel.DOCSoundTracker9(a,b,c);case this.SupportedModules.DOCSoundTracker22:return new weasel.DOCSoundTracker22(a,b,c);case this.SupportedModules.TJCSoundTracker2:return new weasel.TJCSoundTracker2(a,
b,c);case this.SupportedModules.DefJamSoundTracker3:return new weasel.DefJamSoundTracker3(a,b,c);case this.SupportedModules.SpreadpointSoundTracker23:return new weasel.SpreadpointSoundTracker23(a,b,c);case this.SupportedModules.SpreadpointSoundTracker25:return new weasel.SpreadpointSoundTracker25(a,b,c);case this.SupportedModules.NoiseTracker11:return new weasel.NoiseTracker11(a,b,c);case this.SupportedModules.NoiseTracker20:return new weasel.NoiseTracker20(a,b,c);case this.SupportedModules.ProTrackerMK:return new weasel.ProTrackerMK(a,
b,c);case this.SupportedModules.FSTModule:a=new weasel.FSTModule(a,b,c);this.fPanningMean=this.fPanningMean/(this.iPanningEffectTotal==0?1:this.iPanningEffectTotal);b=this.aPanningPositions.length;for(c=0;c<b;c++)this.fPanningVariance=this.fPanningVariance+Math.pow(this.aPanningPositions[c]-this.fPanningMean,2);this.fPanningVariance=this.fPanningVariance/(this.iPanningEffectTotal==0?1:this.iPanningEffectTotal);this.fPanningStandardDeviation=Math.sqrt(this.fPanningVariance);if(this.fPanningStandardDeviation+
this.fPanningMean<128&&this.iMaxPanningPosition!=0){a.setFST7BitPanningMode(true);b=a.getNumberOfChannels();for(c=0;c<b;c++)a.getChannel(c).setPanningPosition(128)}else if(0==this.iMaxPanningPosition&&!this.bCoarsePanningUsed){b=a.getNumberOfChannels();for(c=0;c<b;c++){var d=c&3,d=d==0||d==3?64:192;a.getChannel(c).setPanningPosition(d)}}return a}return null};void 0==window.weasel&&(window.weasel={});
weasel.UltimateSoundTracker121=function(a,b,c){if(a!==void 0&&(a instanceof Array||window.Uint8Array&&a instanceof Uint8Array)){this.sModuleType=weasel.ModuleSniffer.prototype.SupportedModules.UltimateSoundTracker121;this.aModuleData=a;this.aSequenceTable=this.getSequenceTable();this.iSongRestartSequence=this.iMaxPattern=0;this.bUsePALClockConstant=true;this.iPlaybackFrequency=b;this.fMasterVolume=1;this.bFilterOn=false;this.iSongSpeed=0;this.bPatternBreak=false;this.iSequencePositionJump=-1;this.iPatternBreakToRow=
0;this.bNoisetracker20VibratoMode=false;this.iRowDelay=0;this.bProtrackerTremoloSawtoothBug=true;this.bProtrackerRowDelayQuirk=false;this.fWaitForDMAMultiplier=1;this.bProtracker3SampleOffsetMode=false;this.iTimingOverride=this.TimingOverrides.PAL;this.aInstruments=Array(this.FormatInstrumentTotal());this.bSampleLoopOffsetInWords=void 0==this.bSampleLoopOffsetInWords?false:this.bSampleLoopOffsetInWords;this.bNoiseTrackerLoopQuirk=void 0==this.bNoiseTrackerLoopQuirk?false:this.bNoiseTrackerLoopQuirk;
this.bUseFineTuning=void 0==this.bUseFineTuning?false:this.bUseFineTuning;this.bFSTClearSampleOffsetAfterUse=void 0==this.bFSTClearSampleOffsetAfterUse?false:this.bFSTClearSampleOffsetAfterUse;for(var a=0,d=this.aInstruments.length;a<=d;a++)this.aInstruments[a]=new weasel.Instrument(this,a,c,this.bSampleLoopOffsetInWords,this.bNoiseTrackerLoopQuirk,this.bUseFineTuning);this.aPatterns=Array(this.numberOfUniquePatternsInSong());this.extractPatterns();this._extractSongSpeed();this.getNumberOfChannels();
this.aSoundChannels=Array(this.getNumberOfChannels());for(c=this.aSoundChannels.length;--c>=0;)this.aSoundChannels[c]=new weasel.Channel(this,b,1);this.bStartProcessingPatterns=false;this.iCurrentTick=this.iCurrentSequencePosition=0;this.iTickSpeed=weasel.FormatUltimateSoundTracker121.TicksPerRow;this.iSamplesPerTick=this.iCurrentPatternRowPosition=this.iTotalPatternTicks=0;this.setSamplesPerTick();this.iSamplesRemaining=this.iSamplesPerTick;this.b7BitPanning=this.bSongEnded=false;this.aFilterStateChange=
[0,0,0,0];this.aFilterStateForMixer=[false,false,false,false]}};weasel.UltimateSoundTracker121.prototype.TimingOverrides={UseBPM:0,PAL:1,NTSC:2};weasel.UltimateSoundTracker121.prototype.PAL=50;weasel.UltimateSoundTracker121.prototype.NTSC=60/1.001;weasel.UltimateSoundTracker121.prototype.FormatInstrumentTotal=function(){return weasel.FormatUltimateSoundTracker121.NumberOfInstruments};weasel.UltimateSoundTracker121.prototype.FormatModuleHeaderSize=function(){return weasel.FormatUltimateSoundTracker121.ModuleHeaderSize};
weasel.UltimateSoundTracker121.prototype.getNumberOfChannels=function(){return weasel.FormatUltimateSoundTracker121.NumberOfChannels};weasel.UltimateSoundTracker121.prototype.getPatternSizeInBytes=function(){return weasel.FormatUltimateSoundTracker121.PatternSize};weasel.UltimateSoundTracker121.prototype.setMasterVolume=function(a){a<0&&(a=0);a>2&&(a=2);this.fMasterVolume=a;for(var b=this.aSoundChannels.length;--b>=0;)this.aSoundChannels[b].setMasterVolume(a)};
weasel.UltimateSoundTracker121.prototype.getMasterVolume=function(){return this.fMasterVolume};weasel.UltimateSoundTracker121.prototype.setSamplesPerTick=function(){this.iSamplesPerTick=this.iPlaybackFrequency/this.tickPlaybackRateInHz()|0};weasel.UltimateSoundTracker121.prototype.changePlaybackFrequency=function(a){this.iPlaybackFrequency=a;this.setSamplesPerTick();for(var b=this.aSoundChannels.length;--b>=0;)this.aSoundChannels[b].changePlaybackFrequency(a)};
weasel.UltimateSoundTracker121.prototype.getPlaybackFrequency=function(){return this.iPlaybackFrequency};weasel.UltimateSoundTracker121.prototype.getTitle=function(){var a="";try{a=weasel.Helper.getNullTerminatedString(this.aModuleData,weasel.FormatUltimateSoundTracker121.Title,weasel.FormatUltimateSoundTracker121.MaxTitleLength)}catch(b){}return a};weasel.UltimateSoundTracker121.prototype.getSongLengthInPatterns=function(){try{return weasel.Helper.getByte(this.aModuleData,weasel.FormatUltimateSoundTracker121.SongLength)}catch(a){return 0}};
weasel.UltimateSoundTracker121.prototype.getSongSpeed=function(){return this.iSongSpeed};weasel.UltimateSoundTracker121.prototype.setSongSpeed=function(a){this.iSongSpeed=a>220?220:a<0?0:a;this.setSamplesPerTick()};weasel.UltimateSoundTracker121.prototype.findMaximumPatternNumber=function(){if(0!=this.iMaxPattern)return this.iMaxPattern;try{for(var a=0,b=weasel.FormatUltimateSoundTracker121.SequenceTableLength;a<b;a++){var c=this.getPatternNumber(a);if(c>this.iMaxPattern)this.iMaxPattern=c}}catch(d){}return this.iMaxPattern};
weasel.UltimateSoundTracker121.prototype.getSequenceTable=function(){if(null!=this.aSequenceTable)return this.aSequenceTable;for(var a=Array(weasel.FormatUltimateSoundTracker121.SequenceTableLength),b=a.length;--b>=0;)a[b]=0;for(var b=weasel.FormatUltimateSoundTracker121.PatternSequenceTable,c=weasel.FormatUltimateSoundTracker121.SequenceTableLength,d=0;d<c;d++)try{var e=weasel.Helper.getByte(this.aModuleData,b++);a[d]=e}catch(f){}return a};
weasel.UltimateSoundTracker121.prototype.numberOfUniquePatternsInSong=function(){return this.findMaximumPatternNumber()+1};weasel.UltimateSoundTracker121.prototype.getInstrument=function(a){return a>=0&&a<=this.FormatInstrumentTotal()?this.aInstruments[a]:null};weasel.UltimateSoundTracker121.prototype.getModuleData=function(){return this.aModuleData};
weasel.UltimateSoundTracker121.prototype.getNoteFromPeriod=function(a){return a<113||a>856?"???":a in weasel.FormatUltimateSoundTracker121.NoteTable?weasel.FormatUltimateSoundTracker121.NoteTable[a]:"???"};weasel.UltimateSoundTracker121.prototype.getPatternNumber=function(a){if(a<0||a>=weasel.FormatUltimateSoundTracker121.SequenceTableLength)return 0;var b=0;try{b=this.aSequenceTable[a]}catch(c){}return b};
weasel.UltimateSoundTracker121.prototype.extractPatterns=function(){for(var a=0,b=this.numberOfUniquePatternsInSong();a<b;a++)this.aPatterns[a]=new weasel.Pattern(this,a)};weasel.UltimateSoundTracker121.prototype._extractSongSpeed=function(){try{var a=weasel.Helper.getByte(this.aModuleData,weasel.FormatUltimateSoundTracker121.SongSpeed);this.setSongSpeed(a)}catch(b){}};weasel.UltimateSoundTracker121.prototype.getPattern=function(a){return a<0||a>=this.aPatterns.length?null:this.aPatterns[a]};
weasel.UltimateSoundTracker121.prototype.getCIATimerConstant=function(){return this.bUsePALClockConstant==true?weasel.FormatUltimateSoundTracker121.ClockConstantPAL/5:weasel.FormatUltimateSoundTracker121.ClockConstantNTSC/5};weasel.UltimateSoundTracker121.prototype.tickPlaybackRateInHz=function(){var a=this.getCIATimerConstant()/((240-this.getSongSpeed())*122);if(this.iTimingOverride==this.TimingOverrides.PAL)a=this.PAL;else if(this.iTimingOverride==this.TimingOverrides.NTSC)a=this.NTSC;return a};
weasel.UltimateSoundTracker121.prototype.getLengthOfSongInMilliSeconds=function(){return this.getSongLengthInPatterns()*weasel.FormatUltimateSoundTracker121.TicksPerRow*weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern/this.tickPlaybackRateInHz()*1E3};
weasel.UltimateSoundTracker121.prototype.getSongPositionInMilliSeconds=function(){return(this.iCurrentSequencePosition*weasel.FormatUltimateSoundTracker121.TicksPerRow*weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern+this.iCurrentPatternRowPosition*weasel.FormatUltimateSoundTracker121.TicksPerRow+this.iCurrentTick)/this.tickPlaybackRateInHz()*1E3};weasel.UltimateSoundTracker121.prototype._exceptionPreprocessEffects=function(){return false};
weasel.UltimateSoundTracker121.prototype._processChannelEffect=function(a){switch(a.getEffectNumber()){case weasel.FormatUltimateSoundTracker121.Effects.Arpeggio:a.arpeggio(this.iCurrentTick,weasel.Channel.prototype.ArpeggioMode.UltimateSoundtracker);break;case weasel.FormatUltimateSoundTracker121.Effects.Pitchbend:var b=a.getEffectParameter();a.pitchBend(this.iCurrentTick,b>>>4&15,b&15)}};
weasel.UltimateSoundTracker121.prototype.processEffects=function(){if(0!=this.iCurrentTick)for(var a=this.aSoundChannels.length,b=-1;++b<a;)this._processChannelEffect(this.aSoundChannels[b])};weasel.UltimateSoundTracker121.prototype._processChannelTick0Effect=function(){};weasel.UltimateSoundTracker121.prototype.processTick0Effects=function(){};weasel.UltimateSoundTracker121.prototype._fineTune=function(a,b){return b};weasel.UltimateSoundTracker121.prototype._applyVolumeImmediately=function(a){a.setVolume(this.getInstrument(a.getPendingInstrumentNumber()).getVolume())};
weasel.UltimateSoundTracker121.prototype.fetchRow=function(){for(var a=0,b=this.aSoundChannels.length;a<b;a++){var c=this.aSoundChannels[a],d=this.getCurrentPatternCell(a);this._applyPatternCell(c,d);this._processChannelTick0Effect(c)}a=0;for(b=this.aSoundChannels.length;a<b;a++){c=this.aSoundChannels[a];if(true==c.getNoNoteDelayQuirk()){c.setNoNoteDelayQuirk(false);c.delaySampleStart(true,this.WaitForDMAToStop()*this.fWaitForDMAMultiplier)}}};
weasel.UltimateSoundTracker121.prototype._applyPatternCell=function(a,b){a.setEffectNumber(b.getEffectNumber());a.setEffectParameter(b.getEffectParameter());a.setCurrentPatternCell(b);var c=b.getInstrumentNumber();if(c>0){a.setPendingInstrumentNumber(c,null);this._applyVolumeImmediately(a)}c=b.getNotePeriod();if(0!=c&&!this._exceptionPreprocessEffects(a,c)){a.setVibratoTablePosition(0);if(a.getNotePeriod()>=1374){a.setNotePeriod(c);a.setLastSavedNotePeriod(c);a.setShadowNotePeriod(c)}else this.startPendingSample(a,
c,this.WaitForDMAToStop())}};
weasel.UltimateSoundTracker121.prototype.startPendingSample=function(a,b,c){var d=a.getPendingInstrumentNumber();a.setNotePeriod(b);a.setLastSavedNotePeriod(b);a.setShadowNotePeriod(b);a.setInstrumentNumber(d);a.delaySampleStart(true,c);b=this.getInstrument(d);c=b.getSample();c.setLoopedYet(false);a.setSample(c);a.setSamplePosition(0);a.setProtrackerInvertLoopOffset(b);if(0!=a.playFromOffset()){var d=a.playFromOffset(),e=c.getLength(),f=c.getLoopStart()+c.getLoopLength();this.bFSTClearSampleOffsetAfterUse&&
a.setPlayFromOffset(0);!c.isLooped()&&d>e?d=e:c.isLooped()&&(b.isNoisetrackerInstrument()&&d>f)&&(d=f);a.setSamplePosition(d)}c.isLooped()&&!b.isNoisetrackerInstrument()&&a.setSamplePosition(c.getLoopStart());a.setSampleAccumulator()};
weasel.UltimateSoundTracker121.prototype.processPattern=function(){if(this.bStartProcessingPatterns){this.iCurrentTick++;this.iTotalPatternTicks++}else this.bStartProcessingPatterns=true;if(this.iCurrentTick>=this.iTickSpeed){this.iCurrentTick=0;if(--this.iRowDelay<=0){this.iRowDelay=0;this.iCurrentPatternRowPosition=this.iCurrentPatternRowPosition+1;if(this.getCurrentPatternRowPosition()>=weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern||this.bPatternBreak){if(this.bProtrackerRowDelayQuirk&&
this.bPatternBreak){this.iPatternBreakToRow=this.iPatternBreakToRow+1;if(this.iPatternBreakToRow>=weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern){this.iPatternBreakToRow=0;this.iCurrentSequencePosition=this.iCurrentSequencePosition+1}}this.iCurrentPatternRowPosition=this.iPatternBreakToRow;this.iCurrentSequencePosition=this.iCurrentSequencePosition+1;if(-1!=this.iSequencePositionJump&&this.bPatternBreak)this.iCurrentSequencePosition=this.iSequencePositionJump;this.bPatternBreak=false;
this.iPatternBreakToRow=0;this.iSequencePositionJump=-1;if(this.iCurrentSequencePosition>=this.getSongLengthInPatterns()){this.iCurrentSequencePosition=this.iSongRestartSequence;this.bSongEnded=true}this._songSequenceChange()}this.bProtrackerRowDelayQuirk=false}}this.fWaitForDMAMultiplier=1;0==this.iCurrentTick?this.iRowDelay<=0?this.fetchRow():this.processTick0Effects():this.processEffects()};weasel.UltimateSoundTracker121.prototype._songSequenceChange=function(){this.iTotalPatternTicks=0};
weasel.UltimateSoundTracker121.prototype.restartSong=function(){this.iCurrentSequencePosition=this.iCurrentPatternRowPosition=this.iTotalPatternTicks=this.iCurrentTick=0;this.bPatternBreak=this.bSongEnded=false;this.iPatternBreakToRow=0;this.bStartProcessingPatterns=false;this.iSequencePositionJump=-1;this.iRowDelay=0;this.fWaitForDMAMultiplier=1;this.bProtrackerRowDelayQuirk=false;for(var a=this.aSoundChannels.length;--a>=0;)this.aSoundChannels[a].clearChannel()};
weasel.UltimateSoundTracker121.prototype.getTickSpeed=function(){return this.iTickSpeed};weasel.UltimateSoundTracker121.prototype.getChannel=function(a){return a<0||a>=this.aSoundChannels.length?null:this.aSoundChannels[a]};weasel.UltimateSoundTracker121.prototype.getCurrentTick=function(){return this.iCurrentTick};weasel.UltimateSoundTracker121.prototype.getCurrentPatternCell=function(a){return a<0||a>=this.getNumberOfChannels()?null:this.getPattern(this.getPatternNumber(this.getCurrentSequencePosition())).getColumn(a).getCell(this.getCurrentPatternRowPosition())};
weasel.UltimateSoundTracker121.prototype.play=function(a,b,c){var d=a.samplesToFill(),e=this.getChannel(0),f=this.getChannel(1),g=this.getChannel(2),h=this.getChannel(3);void 0!==c&&c<d&&c>=0&&(d=c);for(var i=c=this.bFilterOn,j=0,k=this.aFilterStateChange,l=this.aFilterStateForMixer,m=d,n=e.getCircularBufferPosition();d>0;){var o=this.iSamplesRemaining;o>d&&(o=d);e.make(o);f.make(o);g.make(o);h.make(o);this.iSamplesRemaining=this.iSamplesRemaining-o;d=d-o;if(this.iSamplesRemaining<=0){this.processPattern();
this.iSamplesRemaining=this.iSamplesPerTick;if(i!=this.bFilterOn){i=this.bFilterOn;k[j]=o;l[j]=i;j++}}}if(m>0){d=e.getCircularAudioBuffer();f=f.getCircularAudioBuffer();g=g.getCircularAudioBuffer();h=h.getCircularAudioBuffer();if(0==j||b)a.mix(m,d,f,g,h,n,c&&!b);else{for(b=0;b<j;b++){e=k[b];a.mix(e,d,f,g,h,n,c);c=l[b];n=(n+e)%d.length;m=m-e}m>0&&a.mix(m,d,f,g,h,n,c)}}};weasel.UltimateSoundTracker121.prototype.hasSongEnded=function(){return this.bSongEnded};
weasel.UltimateSoundTracker121.prototype.getCurrentSequencePosition=function(){return this.iCurrentSequencePosition};weasel.UltimateSoundTracker121.prototype.setCurrentSequencePosition=function(a){var b=this.getSongLengthInPatterns();a>=this.getSongLengthInPatterns()&&(a=b-1);a<0&&(a=0);this.iCurrentSequencePosition=a};weasel.UltimateSoundTracker121.prototype.getCurrentPatternRowPosition=function(){return this.iCurrentPatternRowPosition};
weasel.UltimateSoundTracker121.prototype.setClockConstant=function(a){this.bUsePALClockConstant=a==true?true:false;this.setSamplesPerTick();for(a=this.aSoundChannels.length;--a>=0;)this.aSoundChannels[a].setClockConstant(this.bUsePALClockConstant)};
weasel.UltimateSoundTracker121.prototype.timingOverride=function(a){switch(a){case this.TimingOverrides.PAL:this.iTimingOverride=this.TimingOverrides.PAL;this.setClockConstant(true);break;case this.TimingOverrides.NTSC:this.iTimingOverride=this.TimingOverrides.NTSC;this.setClockConstant(false);break;case this.TimingOverrides.UseBPM:this.iTimingOverride=this.TimingOverrides.UseBPM;this.setSamplesPerTick()}};weasel.UltimateSoundTracker121.prototype.getTimingOverride=function(){return this.iTimingOverride};
weasel.UltimateSoundTracker121.prototype.getModuleType=function(){return this.sModuleType};weasel.UltimateSoundTracker121.prototype.getVibratoMode=function(){return this.bNoisetracker20VibratoMode};weasel.UltimateSoundTracker121.prototype.setVibratoMode=function(a){this.bNoisetracker20VibratoMode=a==true?true:false};weasel.UltimateSoundTracker121.prototype.setProtrackerTremoloSawtoothBugMode=function(a){this.bProtrackerTremoloSawtoothBug=a==true?true:false};
weasel.UltimateSoundTracker121.prototype.getProtrackerTremoloSawtoothBugMode=function(){return this.bProtrackerTremoloSawtoothBug};weasel.UltimateSoundTracker121.prototype.WaitForDMAToStop=function(){return weasel.FormatUltimateSoundTracker121.WaitForDMAToStop};weasel.UltimateSoundTracker121.prototype.setProtracker3SampleOffsetMode=function(a){this.bProtracker3SampleOffsetMode=a==true?true:false};weasel.UltimateSoundTracker121.prototype.getProtracker3SampleOffsetMode=function(){return this.bProtracker3SampleOffsetMode};
weasel.UltimateSoundTracker121.prototype.setFST7BitPanningMode=function(a){if(!this.b7BitPanning&&a)for(var b=this.aSoundChannels.length;--b>=0;){var c=this.aSoundChannels[b];c.setPanningPosition(c.getPanningPosition()*2|0)}else if(this.b7BitPanning&&!a)for(b=this.aSoundChannels.length;--b>=0;){c=this.aSoundChannels[b];c.setPanningPosition(c.getPanningPosition()/2|0)}this.b7BitPanning=a==true?true:false};weasel.UltimateSoundTracker121.prototype.getFSTPanningMode=function(){return this.b7BitPanning};
weasel.UltimateSoundTracker121.prototype.getNoiseTrackerLoopQuirkEnabled=function(){return this.bNoiseTrackerLoopQuirk};void 0==window.weasel&&(window.weasel={});weasel.UltimateSoundTracker18=function(a,b,c){this.parent=weasel.UltimateSoundTracker121;if(a!==void 0&&(a instanceof Array||window.Uint8Array&&a instanceof Uint8Array)){this.parent(a,b,c);this.sModuleType=weasel.ModuleSniffer.prototype.SupportedModules.UltimateSoundTracker18;this.timingOverride(this.TimingOverrides.UseBPM)}};
weasel.UltimateSoundTracker18.prototype=new weasel.UltimateSoundTracker121;void 0==window.weasel&&(window.weasel={});weasel.TJCSoundTracker2=function(a,b,c){this.parent=weasel.UltimateSoundTracker121;if(a!==void 0&&(a instanceof Array||window.Uint8Array&&a instanceof Uint8Array)){this.parent(a,b,c);this.sModuleType=weasel.ModuleSniffer.prototype.SupportedModules.TJCSoundTracker2;this.timingOverride(this.TimingOverrides.PAL)}};weasel.TJCSoundTracker2.prototype=new weasel.UltimateSoundTracker121;
weasel.TJCSoundTracker2.prototype._clampNotePeriod=function(a){return a>weasel.FormatTJCSoundTracker2.MinNotePeriod?weasel.FormatTJCSoundTracker2.MinNotePeriod:a<weasel.FormatTJCSoundTracker2.MaxNotePeriod?weasel.FormatTJCSoundTracker2.MaxNotePeriod:a};weasel.TJCSoundTracker2.prototype._applyVolumeImmediately=function(a){var b=this.getInstrument(a.getPendingInstrumentNumber()).getVolume();weasel.FormatTJCSoundTracker2.Effects.Volume==a.getEffectNumber()&&(b=a.getEffectParameter());a.setVolume(b)};
weasel.TJCSoundTracker2.prototype._processChannelEffect=function(a){if(a.getAutoSlide()){var b=a.getShadowVolume()+a.getAutoSlideValue();b>64?b=64:b<0&&(b=0);a.setVolume(b)}switch(a.getEffectNumber()){case weasel.FormatTJCSoundTracker2.Effects.Arpeggio:if(a.getEffectParameter()==0)break;a.arpeggio(this.iCurrentTick,weasel.Channel.prototype.ArpeggioMode.UltimateSoundtracker);break;case weasel.FormatTJCSoundTracker2.Effects.PitchbendUp:a.pitchBend(this.iCurrentTick,0,a.getEffectParameter());a.setShadowNotePeriod(this._clampNotePeriod(a.getShadowNotePeriod()));
a.setNotePeriod(a.getShadowNotePeriod());break;case weasel.FormatTJCSoundTracker2.Effects.PitchbendDown:a.pitchBend(this.iCurrentTick,a.getEffectParameter(),0);a.setShadowNotePeriod(this._clampNotePeriod(a.getShadowNotePeriod()));a.setNotePeriod(a.getShadowNotePeriod());break;case weasel.FormatTJCSoundTracker2.Effects.SlideVolume:a.volumeSlide(this.iCurrentTick)}};
weasel.TJCSoundTracker2.prototype._processChannelTick0Effect=function(a){switch(a.getEffectNumber()){case weasel.FormatTJCSoundTracker2.Effects.Arpeggio:0==a.getEffectParameter()&&a.setAutoSlide(false);break;case weasel.FormatTJCSoundTracker2.Effects.Volume:var b=a.getEffectParameter();b>64&&(b=64);a.setVolume(b);break;case weasel.FormatTJCSoundTracker2.Effects.AutoSlide:b=a.getEffectParameter();b=0==b>>>4&15?0-(b&15):b>>>4&15;a.setAutoSlide(true);a.setAutoSlideValue(b)}};
weasel.TJCSoundTracker2.prototype.processTick0Effects=function(){for(var a=this.aSoundChannels.length,b=-1;++b<a;)this._processChannelTick0Effect(this.aSoundChannels[b])};void 0==window.weasel&&(window.weasel={});
weasel.DefJamSoundTracker3=function(a,b,c){this.parent=weasel.TJCSoundTracker2;if(a!==void 0&&(a instanceof Array||window.Uint8Array&&a instanceof Uint8Array)){this.parent(a,b,c);this.sModuleType=weasel.ModuleSniffer.prototype.SupportedModules.DefJamSoundTracker3;this.timingOverride(this.TimingOverrides.PAL);this.iSongLengthInTicks=0;this.aSequenceTableAccumulatedTicks=Array(this.getSongLengthInPatterns());this._computeSequenceTableTicks()}};weasel.DefJamSoundTracker3.prototype=new weasel.TJCSoundTracker2;
weasel.DefJamSoundTracker3.prototype._computeSequenceTableTicks=function(){for(var a=this.aSequenceTableAccumulatedTicks.length;--a>=0;)this.aSequenceTableAccumulatedTicks[a]=0;for(var b=weasel.FormatUltimateSoundTracker121.TicksPerRow,a=0,c=this.aSequenceTableAccumulatedTicks.length,d=0;d<c;d++){this.aSequenceTableAccumulatedTicks[d]=a;for(var e=this.getPatternNumber(d),e=this.getPattern(e),f=weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern,g=0;g<f;g++){for(var h=this.aSoundChannels.length,
i=-1;++i<h;){var j=e.getColumn(i).getCell(g);if(weasel.FormatDefJamSoundTracker3.Effects.TickSpeed==j.getEffectNumber()){b=j.getEffectParameter()&15;b<1&&(b=1)}}a=a+b}}this.iSongLengthInTicks=a};weasel.DefJamSoundTracker3.prototype.getLengthOfSongInMilliSeconds=function(){return this.iSongLengthInTicks*(1E3/this.tickPlaybackRateInHz())};
weasel.DefJamSoundTracker3.prototype.getSongPositionInMilliSeconds=function(){return(this.aSequenceTableAccumulatedTicks[this.getCurrentSequencePosition()]+this.iTotalPatternTicks)*(1E3/this.tickPlaybackRateInHz())};weasel.DefJamSoundTracker3.prototype.setTickSpeed=function(a){this.iTickSpeed=a<1?1:a>15?15:a};
weasel.DefJamSoundTracker3.prototype._processChannelTick0Effect=function(a){switch(a.getEffectNumber()){case weasel.FormatTJCSoundTracker2.Effects.Arpeggio:0==a.getEffectParameter()&&a.setAutoSlide(false);break;case weasel.FormatTJCSoundTracker2.Effects.Volume:var b=a.getEffectParameter();b>64&&(b=64);a.setVolume(b);break;case weasel.FormatTJCSoundTracker2.Effects.AutoSlide:b=a.getEffectParameter();b=0==b>>>4&15?0-(b&15):b>>>4&15;a.setAutoSlide(true);a.setAutoSlideValue(b);break;case weasel.FormatDefJamSoundTracker3.Effects.TickSpeed:a=
a.getEffectParameter()&15;this.setTickSpeed(a)}};void 0==window.weasel&&(window.weasel={});
weasel.DOCSoundTracker9=function(a,b,c){this.parent=weasel.UltimateSoundTracker18;if(a!==void 0&&(a instanceof Array||window.Uint8Array&&a instanceof Uint8Array)){this.parent(a,b,c);this.sModuleType=weasel.ModuleSniffer.prototype.SupportedModules.DOCSoundTracker9;120==this.getSongSpeed()&&this.timingOverride(this.TimingOverrides.PAL);this.iSongLengthInTicks=0;this.aSequenceTableAccumulatedTicks=Array(this.getSongLengthInPatterns());this._computeSequenceTableTicks()}};
weasel.DOCSoundTracker9.prototype=new weasel.UltimateSoundTracker18;
weasel.DOCSoundTracker9.prototype._computeSequenceTableTicks=function(){for(var a=this.aSequenceTableAccumulatedTicks.length;--a>=0;)this.aSequenceTableAccumulatedTicks[a]=0;for(var b=weasel.FormatUltimateSoundTracker121.TicksPerRow,a=0,c=this.aSequenceTableAccumulatedTicks.length,d=0;d<c;d++){this.aSequenceTableAccumulatedTicks[d]=a;for(var e=this.getPatternNumber(d),e=this.getPattern(e),f=weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern,g=0;g<f;g++){for(var h=this.aSoundChannels.length,
i=-1;++i<h;){var j=e.getColumn(i).getCell(g);if(weasel.FormatDOCSoundTracker9.Effects.TickSpeed==j.getEffectNumber()){b=j.getEffectParameter()&15;b<2&&(b=2)}}a=a+b}}this.iSongLengthInTicks=a};weasel.DOCSoundTracker9.prototype.getLengthOfSongInMilliSeconds=function(){return this.iSongLengthInTicks*(1E3/this.tickPlaybackRateInHz())};
weasel.DOCSoundTracker9.prototype.getSongPositionInMilliSeconds=function(){return(this.aSequenceTableAccumulatedTicks[this.getCurrentSequencePosition()]+this.iTotalPatternTicks)*(1E3/this.tickPlaybackRateInHz())};weasel.DOCSoundTracker9.prototype.setTickSpeed=function(a){this.iTickSpeed=a<2?2:a>15?15:a};
weasel.DOCSoundTracker9.prototype._clampNotePeriod=function(a){return a>weasel.FormatDOCSoundTracker9.MinNotePeriod?weasel.FormatDOCSoundTracker9.MinNotePeriod:a<weasel.FormatDOCSoundTracker9.MaxNotePeriod?weasel.FormatDOCSoundTracker9.MaxNotePeriod:a};weasel.DOCSoundTracker9.prototype._applyVolumeImmediately=function(a){var b=this.getInstrument(a.getPendingInstrumentNumber()).getVolume();weasel.FormatDOCSoundTracker9.Effects.Volume==a.getEffectNumber()&&(b=a.getEffectParameter());a.setVolume(b)};
weasel.DOCSoundTracker9.prototype._processChannelEffect=function(a){switch(a.getEffectNumber()){case weasel.FormatDOCSoundTracker9.Effects.Arpeggio:if(a.getEffectParameter()==0)break;a.arpeggio(this.iCurrentTick,weasel.Channel.prototype.ArpeggioMode.UltimateSoundtracker);break;case weasel.FormatDOCSoundTracker9.Effects.PitchbendUp:a.pitchBend(this.iCurrentTick,0,a.getEffectParameter());a.setShadowNotePeriod(this._clampNotePeriod(a.getShadowNotePeriod()));a.setNotePeriod(a.getShadowNotePeriod());break;
case weasel.FormatDOCSoundTracker9.Effects.PitchbendDown:a.pitchBend(this.iCurrentTick,a.getEffectParameter(),0);a.setShadowNotePeriod(this._clampNotePeriod(a.getShadowNotePeriod()));a.setNotePeriod(a.getShadowNotePeriod())}};
weasel.DOCSoundTracker9.prototype._processChannelTick0Effect=function(a){switch(a.getEffectNumber()){case weasel.FormatDOCSoundTracker9.Effects.Volume:var b=a.getEffectParameter();b>64&&(b=64);a.setVolume(b);break;case weasel.FormatDOCSoundTracker9.Effects.Filter:this.bFilterOn=(a.getEffectParameter()&1)==0;break;case weasel.FormatDOCSoundTracker9.Effects.TickSpeed:a=a.getEffectParameter()&15;a<2&&(a=2);this.setTickSpeed(a)}};
weasel.DOCSoundTracker9.prototype.processTick0Effects=function(){for(var a=this.aSoundChannels.length,b=-1;++b<a;)this._processChannelTick0Effect(this.aSoundChannels[b])};void 0==window.weasel&&(window.weasel={});
weasel.DOCSoundTracker22=function(a,b,c){this.parent=weasel.DOCSoundTracker9;if(a!==void 0&&(a instanceof Array||window.Uint8Array&&a instanceof Uint8Array)){this.parent(a,b,c);this.sModuleType=weasel.ModuleSniffer.prototype.SupportedModules.DOCSoundTracker22;this.timingOverride(this.TimingOverrides.PAL);this.aVisitedSequence=Array(weasel.FormatUltimateSoundTracker121.SequenceTableLength);this.clearVisitedSequenceTable()}};weasel.DOCSoundTracker22.prototype=new weasel.DOCSoundTracker9;
weasel.DOCSoundTracker22.prototype._computeSequenceTableTicks=function(){var a=Array(weasel.FormatUltimateSoundTracker121.SequenceTableLength);this.aSequenceTableAccumulatedTicks=Array(weasel.FormatUltimateSoundTracker121.SequenceTableLength);for(var b=a.length;--b>=0;)a[b]=false;for(b=this.aSequenceTableAccumulatedTicks.length;--b>=0;)this.aSequenceTableAccumulatedTicks[b]=0;for(var b=weasel.FormatUltimateSoundTracker121.TicksPerRow,c=0,d=-1,e=this.getSongLengthInPatterns(),f=0;f<weasel.FormatUltimateSoundTracker121.SequenceTableLength&&
f<e&&!a[f];){this.aSequenceTableAccumulatedTicks[f]=c;a[f]=true;for(var d=-1,g=this.getPatternNumber(f),g=this.getPattern(g),h=weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern,i=0,j=false;i<h&&!j;i++){for(var k=this.aSoundChannels.length,l=-1;++l<k;){var m=g.getColumn(l).getCell(i),n=m.getEffectParameter();switch(m.getEffectNumber()){case weasel.FormatDOCSoundTracker22.Effects.SequencePositionJump:j=true;d=n;break;case weasel.FormatDOCSoundTracker22.Effects.PatternBreak:j=true;break;case weasel.FormatDOCSoundTracker9.Effects.TickSpeed:m=
this._sequenceTableTickSpeedReader(n);0!=m&&(b=m)}}c=c+b}-1==d?f++:f=d}this.iSongLengthInTicks=c};weasel.DOCSoundTracker22.prototype._sequenceTableTickSpeedReader=function(a){return a&15};weasel.DOCSoundTracker22.prototype.setTickSpeed=function(a){if(!(a<=0))this.iTickSpeed=a>15?15:a};
weasel.DOCSoundTracker22.prototype._processChannelTick0Effect=function(a){switch(a.getEffectNumber()){case weasel.FormatDOCSoundTracker22.Effects.SequencePositionJump:a=a.getEffectParameter();this.bPatternBreak=true;this.iPatternBreakToRow=0;this.iSequencePositionJump=a;break;case weasel.FormatDOCSoundTracker9.Effects.Volume:var b=a.getEffectParameter();b>64&&(b=64);a.setVolume(b);break;case weasel.FormatDOCSoundTracker22.Effects.PatternBreak:this.bPatternBreak=true;this.iPatternBreakToRow=0;break;
case weasel.FormatDOCSoundTracker9.Effects.Filter:this.bFilterOn=(a.getEffectParameter()&1)==0;break;case weasel.FormatDOCSoundTracker9.Effects.TickSpeed:a=a.getEffectParameter()&15;this.setTickSpeed(a)}};weasel.DOCSoundTracker22.prototype._songSequenceChange=function(){var a=this.getCurrentSequencePosition();if(true==this.aVisitedSequence[a])this.bSongEnded=true;this.aVisitedSequence[this.getCurrentSequencePosition()]=true;this.iTotalPatternTicks=0};
weasel.DOCSoundTracker22.prototype.clearVisitedSequenceTable=function(){for(var a=this.aVisitedSequence,b=a.length;--b>=0;)a[b]=false};weasel.DOCSoundTracker22.prototype.restartSong=function(){this.clearVisitedSequenceTable();this.parent.prototype.restartSong.call(this)};void 0==window.weasel&&(window.weasel={});
weasel.SpreadpointSoundTracker23=function(a,b,c){this.parent=weasel.DOCSoundTracker22;if(a!==void 0&&(a instanceof Array||window.Uint8Array&&a instanceof Uint8Array)){this.parent(a,b,c);this.sModuleType=weasel.ModuleSniffer.prototype.SupportedModules.SpreadpointSoundTracker23}};weasel.SpreadpointSoundTracker23.prototype=new weasel.DOCSoundTracker22;weasel.SpreadpointSoundTracker23.prototype.FormatInstrumentTotal=function(){return weasel.FormatSpreadpointSoundTracker23.NumberOfInstruments};
weasel.SpreadpointSoundTracker23.prototype.FormatModuleHeaderSize=function(){return weasel.FormatSpreadpointSoundTracker23.ModuleHeaderSize};weasel.SpreadpointSoundTracker23.prototype._extractSongSpeed=function(){try{var a=weasel.Helper.getByte(this.aModuleData,weasel.FormatSpreadpointSoundTracker23.SongSpeed);this.setSongSpeed(a)}catch(b){}};
weasel.SpreadpointSoundTracker23.prototype.getSequenceTable=function(){if(null!=this.aSequenceTable)return this.aSequenceTable;for(var a=Array(weasel.FormatUltimateSoundTracker121.SequenceTableLength),b=a.length;--b>=0;)a[b]=0;for(var b=weasel.FormatSpreadpointSoundTracker23.PatternSequenceTable,c=weasel.FormatUltimateSoundTracker121.SequenceTableLength,d=0;d<c;d++)try{var e=weasel.Helper.getByte(this.aModuleData,b++);a[d]=e}catch(f){}return a};
weasel.SpreadpointSoundTracker23.prototype.getSongLengthInPatterns=function(){try{return weasel.Helper.getByte(this.aModuleData,weasel.FormatSpreadpointSoundTracker23.SongLength)}catch(a){return 0}};
weasel.SpreadpointSoundTracker23.prototype._processChannelEffect=function(a){switch(a.getEffectNumber()){case weasel.FormatDOCSoundTracker9.Effects.Arpeggio:if(a.getEffectParameter()==0)break;a.arpeggio(this.iCurrentTick,weasel.Channel.prototype.ArpeggioMode.UltimateSoundtracker);break;case weasel.FormatDOCSoundTracker9.Effects.PitchbendUp:a.pitchBend(this.iCurrentTick,0,a.getEffectParameter());a.setShadowNotePeriod(this._clampNotePeriod(a.getShadowNotePeriod()));a.setNotePeriod(a.getShadowNotePeriod());
break;case weasel.FormatDOCSoundTracker9.Effects.PitchbendDown:a.pitchBend(this.iCurrentTick,a.getEffectParameter(),0);a.setShadowNotePeriod(this._clampNotePeriod(a.getShadowNotePeriod()));a.setNotePeriod(a.getShadowNotePeriod());break;case weasel.FormatSpreadpointSoundTracker23.Effects.VolumeSlide:a.volumeSlide(this.iCurrentTick)}};void 0==window.weasel&&(window.weasel={});
weasel.NoiseTracker11=function(a,b,c){this.parent=weasel.SpreadpointSoundTracker23;if(a!==void 0&&(a instanceof Array||window.Uint8Array&&a instanceof Uint8Array)){this.bSampleLoopOffsetInWords=true;this.bNoiseTrackerLoopQuirk=void 0==this.bNoiseTrackerLoopQuirk?true:this.bNoiseTrackerLoopQuirk;this.parent(a,b,c);this._extractSongRestartSequencePosition();this.setSongSpeed(120);this.sModuleType=weasel.ModuleSniffer.prototype.SupportedModules.NoiseTracker11}};weasel.NoiseTracker11.prototype=new weasel.SpreadpointSoundTracker23;
weasel.NoiseTracker11.prototype._sequenceTableTickSpeedReader=function(a){return a>31?31:a};weasel.NoiseTracker11.prototype.setTickSpeed=function(a){if(!(a<=0))this.iTickSpeed=a>31?31:a};weasel.NoiseTracker11.prototype._exceptionPreprocessEffects=function(a,b){if(weasel.FormatNoiseTracker11.Effects.TonePortamento==a.getEffectNumber()){a.setNotePortamentoTarget(b);return true}return false};
weasel.NoiseTracker11.prototype._processChannelEffect=function(a){switch(a.getEffectNumber()){case weasel.FormatDOCSoundTracker9.Effects.Arpeggio:if(a.getEffectParameter()==0){a.setNotePeriod(a.getShadowNotePeriod());break}a.arpeggio(this.iCurrentTick,weasel.Channel.prototype.ArpeggioMode.Noisetracker);break;case weasel.FormatDOCSoundTracker9.Effects.PitchbendUp:a.pitchBend(this.iCurrentTick,0,a.getEffectParameter());a.setShadowNotePeriod(this._clampNotePeriod(a.getShadowNotePeriod()));a.setNotePeriod(a.getShadowNotePeriod());
break;case weasel.FormatDOCSoundTracker9.Effects.PitchbendDown:a.pitchBend(this.iCurrentTick,a.getEffectParameter(),0);a.setShadowNotePeriod(this._clampNotePeriod(a.getShadowNotePeriod()));a.setNotePeriod(a.getShadowNotePeriod());break;case weasel.FormatNoiseTracker11.Effects.TonePortamento:a.setNotePortamentoSpeed(a.getEffectParameter());a.notePortamento(this.iCurrentTick);a.setNotePeriod(this._clampNotePeriod(a.getNotePeriod()));break;case weasel.FormatNoiseTracker11.Effects.Vibrato:a.vibrato(this.iCurrentTick,
true,this.getVibratoMode());break;case weasel.FormatSpreadpointSoundTracker23.Effects.VolumeSlide:a.setNotePeriod(a.getShadowNotePeriod());a.volumeSlide(this.iCurrentTick);break;default:a.setNotePeriod(a.getShadowNotePeriod())}};
weasel.NoiseTracker11.prototype._processChannelTick0Effect=function(a){switch(a.getEffectNumber()){case weasel.FormatDOCSoundTracker22.Effects.SequencePositionJump:a=a.getEffectParameter();this.bPatternBreak=true;this.iSequencePositionJump=a;this.iPatternBreakToRow=0;break;case weasel.FormatDOCSoundTracker9.Effects.Volume:var b=a.getEffectParameter();b>64&&(b=64);a.setVolume(b);break;case weasel.FormatDOCSoundTracker22.Effects.PatternBreak:this.bPatternBreak=true;this.iPatternBreakToRow=0;break;case weasel.FormatDOCSoundTracker9.Effects.Filter:this.bFilterOn=
(a.getEffectParameter()&1)==0;break;case weasel.FormatDOCSoundTracker9.Effects.TickSpeed:this.setTickSpeed(a.getEffectParameter())}};
weasel.NoiseTracker11.prototype._applyPatternCell=function(a,b){a.setEffectNumber(b.getEffectNumber());a.setEffectParameter(b.getEffectParameter());a.setCurrentPatternCell(b);var c=b.getInstrumentNumber();if(c>0){a.setPendingInstrumentNumber(c,this.getInstrument(c));this._applyVolumeImmediately(a)}c=b.getNotePeriod();if(0!=c&&!this._exceptionPreprocessEffects(a,c)){a.setVibratoTablePosition(0);if(a.getNotePeriod()>=1374){a.setNotePeriod(c);a.setLastSavedNotePeriod(c);a.setShadowNotePeriod(c)}else this.startPendingSample(a,
c,this.WaitForDMAToStop())}};weasel.NoiseTracker11.prototype.WaitForDMAToStop=function(){return weasel.FormatNoiseTracker11.WaitForDMAToStop};weasel.NoiseTracker11.prototype._extractSongRestartSequencePosition=function(){try{this.iSongRestartSequence=weasel.Helper.getByte(this.aModuleData,weasel.FormatNoiseTracker11.SongRestartPosition)}catch(a){}};void 0==window.weasel&&(window.weasel={});
weasel.SpreadpointSoundTracker25=function(a,b,c){this.parent=weasel.NoiseTracker11;if(a!==void 0&&(a instanceof Array||window.Uint8Array&&a instanceof Uint8Array)){this.parent(a,b,c);this.iSongRestartSequence=0;this._extractSongSpeed();this.timingOverride(this.TimingOverrides.PAL);this.sModuleType=weasel.ModuleSniffer.prototype.SupportedModules.SpreadpointSoundTracker25}};weasel.SpreadpointSoundTracker25.prototype=new weasel.NoiseTracker11;
weasel.SpreadpointSoundTracker25.prototype._sequenceTableTickSpeedReader=function(a){return a&31};weasel.SpreadpointSoundTracker25.prototype.setTickSpeed=function(a){a=a&31;if(!(a<=0))this.iTickSpeed=a};void 0==window.weasel&&(window.weasel={});weasel.NoiseTracker20=function(a,b,c){this.parent=weasel.NoiseTracker11;if(a!==void 0&&(a instanceof Array||window.Uint8Array&&a instanceof Uint8Array)){this.parent(a,b,c);this.setVibratoMode(true);this.sModuleType=weasel.ModuleSniffer.prototype.SupportedModules.NoiseTracker20}};
weasel.NoiseTracker20.prototype=new weasel.NoiseTracker11;weasel.NoiseTracker20.prototype._sequenceTableTickSpeedReader=function(a){return a>31?31:a<=0?1:a};weasel.NoiseTracker20.prototype.setTickSpeed=function(a){this.iTickSpeed=this._sequenceTableTickSpeedReader(a)};
weasel.NoiseTracker20.prototype._exceptionPreprocessEffects=function(a,b){switch(a.getEffectNumber()){case weasel.FormatNoiseTracker11.Effects.TonePortamento:case weasel.FormatNoiseTracker20.Effects.TonePortamentoAndVolumeSlide:a.setNotePortamentoTarget(b);return true}return false};
weasel.NoiseTracker20.prototype._processChannelEffect=function(a){switch(a.getEffectNumber()){case weasel.FormatDOCSoundTracker9.Effects.Arpeggio:if(a.getEffectParameter()==0){a.setNotePeriod(a.getShadowNotePeriod());break}a.arpeggio(this.iCurrentTick,weasel.Channel.prototype.ArpeggioMode.Noisetracker);break;case weasel.FormatDOCSoundTracker9.Effects.PitchbendUp:a.pitchBend(this.iCurrentTick,0,a.getEffectParameter());a.setShadowNotePeriod(this._clampNotePeriod(a.getShadowNotePeriod()));a.setNotePeriod(a.getShadowNotePeriod());
break;case weasel.FormatDOCSoundTracker9.Effects.PitchbendDown:a.pitchBend(this.iCurrentTick,a.getEffectParameter(),0);a.setShadowNotePeriod(this._clampNotePeriod(a.getShadowNotePeriod()));a.setNotePeriod(a.getShadowNotePeriod());break;case weasel.FormatNoiseTracker11.Effects.TonePortamento:a.setNotePortamentoSpeed(a.getEffectParameter());a.notePortamento(this.iCurrentTick);a.setNotePeriod(this._clampNotePeriod(a.getNotePeriod()));break;case weasel.FormatNoiseTracker11.Effects.Vibrato:a.vibrato(this.iCurrentTick,
true,this.getVibratoMode());break;case weasel.FormatNoiseTracker20.Effects.TonePortamentoAndVolumeSlide:a.notePortamento(this.iCurrentTick);a.setNotePeriod(this._clampNotePeriod(a.getNotePeriod()));a.volumeSlide(this.iCurrentTick);break;case weasel.FormatNoiseTracker20.Effects.VibratoAndVolumeSlide:a.vibrato(this.iCurrentTick,false,this.getVibratoMode());a.volumeSlide(this.iCurrentTick);break;case weasel.FormatSpreadpointSoundTracker23.Effects.VolumeSlide:a.setNotePeriod(a.getShadowNotePeriod());
a.volumeSlide(this.iCurrentTick);break;default:a.setNotePeriod(a.getShadowNotePeriod())}};void 0==window.weasel&&(window.weasel={});
weasel.ProTrackerMK=function(a,b,c){this.parent=weasel.NoiseTracker20;if(a!==void 0&&(a instanceof Array||window.Uint8Array&&a instanceof Uint8Array)){this.aBPMChangedTimeTick=[];this.aBPMSpeeds=[];this.bUseFineTuning=this.bIgnorePatternScan=true;this.parent(a,b,c);this.bDontStopDMAQuirk=true;this.setVibratoMode(true);this.iSongRestartSequence=0;this.setSongSpeed(125);this.timingOverride(weasel.UltimateSoundTracker121.prototype.TimingOverrides.UseBPM);this.sModuleType=weasel.ModuleSniffer.prototype.SupportedModules.ProTrackerMK;
a=this.aVisitedSequence=Array(weasel.FormatUltimateSoundTracker121.SequenceTableLength);for(b=a.length;--b>=0;){a[b]=Array(weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern);for(var c=a[b],d=c.length;--d>=0;)c[d]=false}this.bIgnorePatternScan=false;this._computeSequenceTableTicks()}};weasel.ProTrackerMK.prototype=new weasel.NoiseTracker20;
weasel.ProTrackerMK.prototype._computeSequenceTableTicks=function(){if(!this.bIgnorePatternScan){var a=Array(weasel.FormatUltimateSoundTracker121.SequenceTableLength);this.aSequenceTableAccumulatedTicks=Array(weasel.FormatUltimateSoundTracker121.SequenceTableLength);this.aBPMChangedTimeTick=[];this.aBPMSpeeds=[];for(var b=a.length;--b>=0;){a[b]=Array(weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern);for(var c=a[b],d=c.length;--d>=0;)c[d]=false}for(d=this.aSequenceTableAccumulatedTicks.length;--d>=
0;)this.aSequenceTableAccumulatedTicks[d]=0;for(var b=this.getNumberOfChannels(),c=Array(b),e=Array(b),f=weasel.FormatUltimateSoundTracker121.TicksPerRow,g=125,h=125,i=0,j=-1,k=false,l=0,m=-1,n=false,o=this.getSongLengthInPatterns(),q=0;q<weasel.FormatUltimateSoundTracker121.SequenceTableLength&&q<o&&!a[q][l]&&!k;){this.aSequenceTableAccumulatedTicks[q]==0&&(i!=0&&q!=0)&&(this.aSequenceTableAccumulatedTicks[q]=i);j=-1;for(d=this.aSoundChannels.length;--d>=0;){c[d]=0;e[d]=-1}for(var m=-1,d=this.getPatternNumber(q),
u=this.getPattern(d),p=weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern,d=l,r=false,l=0;d<p&&!r&&!k;d++){for(var v=0,w=n=false,s=b;--s>=0;)if(e[s]>=0){w=true;break}if(true==a[q][d]&&!w)k=true;else{a[q][d]=true;w=b;for(s=-1;++s<w;){var x=u.getColumn(s).getCell(d),t=x.getEffectParameter();switch(x.getEffectNumber()){case weasel.FormatDOCSoundTracker22.Effects.SequencePositionJump:r=true;j=t;l=0;break;case weasel.FormatDOCSoundTracker22.Effects.PatternBreak:l=(t>>>4)*10+(t&15);l>63&&(l=0);
r=true;break;case weasel.FormatDOCSoundTracker9.Effects.TickSpeed:if(this.getTimingOverride()==this.TimingOverrides.UseBPM){if(0==t){k=true;f=0;break}t<32?f=t:h!=t&&(h=t)}else t>0&&(f=t);break;case weasel.FormatProTrackerMK.Effects.ExtendedCommands:x=t&240;t=t&15;if(x==weasel.FormatProTrackerMK.Effects.PatternLoop)if(0==t)c[s]=d;else{if(e[s]<=0)e[s]=t;else if(--e[s]<=0)continue;m=c[s]}else if(x==weasel.FormatProTrackerMK.Effects.PatternDelay){n=true;v=t}}}if(h!=g){g=h;this.aBPMSpeeds.push(g);this.aBPMChangedTimeTick.push(i)}if(m>=
0){d=m-1;m=-1}i=i+(f+v*f)}}if(n&&r){l++;if(l>=weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern){l=0;q++}}-1==j?q++:q=j}this.iSongLengthInTicks=i}};weasel.ProTrackerMK.prototype._getSongPositionInMilliSeconds=function(a,b){var c=this.aBPMChangedTimeTick,d=this.aBPMSpeeds;if(d.length==0)return a*(1E3/this.tickPlaybackRateInHz());for(var e=0,f=0,g=125,h=0,i=c.length;h<i&&c[h]<a;h++){e=e+(c[h]-f)*(2500/g);f=c[h];g=d[h]}return e=b?e+(a-f)*(2500/g):e+(a-f)*(1E3/this.tickPlaybackRateInHz())};
weasel.ProTrackerMK.prototype.getSongPositionInMilliSeconds=function(){var a=this.aSequenceTableAccumulatedTicks[this.getCurrentSequencePosition()]+this.iTotalPatternTicks;return this._getSongPositionInMilliSeconds(a,false)};weasel.ProTrackerMK.prototype.getLengthOfSongInMilliSeconds=function(){return this._getSongPositionInMilliSeconds(this.iSongLengthInTicks,true)};weasel.ProTrackerMK.prototype.setSongSpeed=function(a){a<32?a=32:a>255&&(a=255);this.iSongSpeed=a;this.setSamplesPerTick()};
weasel.ProTrackerMK.prototype._extractSongSpeed=function(){this.setSongSpeed(125)};weasel.ProTrackerMK.prototype.tickPlaybackRateInHz=function(){var a=this.getCIATimerConstant()/(this.getCIATimerConstant()/50*(125/this.getSongSpeed()));if(this.iTimingOverride==this.TimingOverrides.PAL)a=this.PAL;else if(this.iTimingOverride==this.TimingOverrides.NTSC)a=this.NTSC;return a};weasel.ProTrackerMK.prototype.setTickSpeed=function(a){a<=0?this.bSongEnded=true:this.iTickSpeed=a>255?255:a};
weasel.ProTrackerMK.prototype._processChannelEffect=function(a){a.updateProtrackerInvertLoop();switch(a.getEffectNumber()){case weasel.FormatDOCSoundTracker9.Effects.Arpeggio:this._arpeggio(a);break;case weasel.FormatDOCSoundTracker9.Effects.PitchbendUp:a.pitchBend(this.iCurrentTick,0,a.getEffectParameter());a.setShadowNotePeriod(this._clampNotePeriod(a.getShadowNotePeriod()));a.setNotePeriod(a.getShadowNotePeriod());break;case weasel.FormatDOCSoundTracker9.Effects.PitchbendDown:a.pitchBend(this.iCurrentTick,
a.getEffectParameter(),0);a.setShadowNotePeriod(this._clampNotePeriod(a.getShadowNotePeriod()));a.setNotePeriod(a.getShadowNotePeriod());break;case weasel.FormatNoiseTracker11.Effects.TonePortamento:a.setNotePortamentoSpeed(a.getEffectParameter());a.notePortamento(this.iCurrentTick);a.setNotePeriod(this._clampNotePeriod(a.getNotePeriod()));break;case weasel.FormatNoiseTracker11.Effects.Vibrato:a.protrackerVibrato(this.iCurrentTick,true,this.getVibratoMode());break;case weasel.FormatNoiseTracker20.Effects.TonePortamentoAndVolumeSlide:a.notePortamento(this.iCurrentTick);
a.setNotePeriod(this._clampNotePeriod(a.getNotePeriod()));a.volumeSlide(this.iCurrentTick);break;case weasel.FormatNoiseTracker20.Effects.VibratoAndVolumeSlide:a.protrackerVibrato(this.iCurrentTick,false,this.getVibratoMode());a.volumeSlide(this.iCurrentTick);break;case weasel.FormatProTrackerMK.Effects.Tremolo:a.setNotePeriod(a.getShadowNotePeriod());a.tremolo(this.iCurrentTick,this.getProtrackerTremoloSawtoothBugMode());break;case weasel.FormatSpreadpointSoundTracker23.Effects.VolumeSlide:a.setNotePeriod(a.getShadowNotePeriod());
a.volumeSlide(this.iCurrentTick);break;case weasel.FormatProTrackerMK.Effects.ExtendedCommands:var b=a.getEffectParameter()&15;switch(a.getEffectParameter()&240){case weasel.FormatProTrackerMK.Effects.RetriggerNote:if(a.retriggerNote(this.getCurrentTick(),b,this.WaitForDMAToStop()*this.fWaitForDMAMultiplier))this.fWaitForDMAMultiplier=this.fWaitForDMAMultiplier+2;break;case weasel.FormatProTrackerMK.Effects.NoteCut:this.getCurrentTick()==b&&a.setVolume(0);break;case weasel.FormatProTrackerMK.Effects.NoteDelay:if(this.getCurrentTick()==
b&&a.getDelayedNotePeriod()!=0){b=a.getCurrentPatternCell();if(b!=null&&0!=b.getNotePeriod()){this.startPendingSample(a,a.getDelayedNotePeriod(),this.WaitForDMAToStop()*this.fWaitForDMAMultiplier);this.fWaitForDMAMultiplier=this.fWaitForDMAMultiplier+2}}}break;default:a.setNotePeriod(a.getShadowNotePeriod())}};weasel.ProTrackerMK.prototype._arpeggio=function(a){a.getEffectParameter()==0?a.setNotePeriod(a.getShadowNotePeriod()):a.arpeggio(this.iCurrentTick,weasel.Channel.prototype.ArpeggioMode.Protracker)};
weasel.ProTrackerMK.prototype._processChannelTick0Effect=function(a){var b=a.getEffectParameter();switch(a.getEffectNumber()){case weasel.FormatProTrackerMK.Effects.SetSampleOffset:if(this.bProtracker3SampleOffsetMode)break;0==b?b=a.getLastSampleOffsetParameter():a.setLastSampleOffsetParameter(b);a.setPlayFromOffset(a.playFromOffset()+(b<<8));break;case weasel.FormatDOCSoundTracker22.Effects.SequencePositionJump:this.bPatternBreak=true;this.iPatternBreakToRow=0;this.iSequencePositionJump=b;break;
case weasel.FormatDOCSoundTracker9.Effects.Volume:b>64&&(b=64);a.setVolume(b);break;case weasel.FormatDOCSoundTracker22.Effects.PatternBreak:a=(b>>>4)*10+(b&15);a>63&&(a=0);this.bPatternBreak=true;this.iPatternBreakToRow=a;break;case weasel.FormatProTrackerMK.Effects.ExtendedCommands:this._processChannelTick0ExtendedEffect(a);break;case weasel.FormatDOCSoundTracker9.Effects.TickSpeed:this.getTimingOverride()==this.TimingOverrides.UseBPM?b<32?this.setTickSpeed(b):this.setSongSpeed(b):b>0&&this.setTickSpeed(b);
break;default:a.setNotePeriod(a.getShadowNotePeriod())}};
weasel.ProTrackerMK.prototype._processChannelTick0ExtendedEffect=function(a){var b=a.getEffectParameter()&15;switch(a.getEffectParameter()&240){case weasel.FormatProTrackerMK.Effects.Filter:this.bFilterOn=(b&1)==0;break;case weasel.FormatProTrackerMK.Effects.FineSlideUp:a.pitchBend(1,0,b);a.setShadowNotePeriod(this._clampNotePeriod(a.getShadowNotePeriod()));a.setNotePeriod(a.getShadowNotePeriod());break;case weasel.FormatProTrackerMK.Effects.FineSlideDown:a.pitchBend(1,b,0);a.setShadowNotePeriod(this._clampNotePeriod(a.getShadowNotePeriod()));
a.setNotePeriod(a.getShadowNotePeriod());break;case weasel.FormatProTrackerMK.Effects.GlissandoControl:a.setGlissando(b!=0);break;case weasel.FormatProTrackerMK.Effects.SetVibratoWaveform:var c=0;switch(b&3){case weasel.Channel.prototype.ProtrackerVibratoWaveform.SineWave:c=weasel.Channel.prototype.ProtrackerVibratoWaveform.SineWave;break;case weasel.Channel.prototype.ProtrackerVibratoWaveform.RampDownSawTooth:c=weasel.Channel.prototype.ProtrackerVibratoWaveform.RampDownSawTooth;break;default:c=weasel.Channel.prototype.ProtrackerVibratoWaveform.Square}a.setProtrackerContinueVibratoWaveform((b&
4)!=0?true:false);a.setProtrackerVibratoWaveformType(c);break;case weasel.FormatProTrackerMK.Effects.PatternLoop:if(0==b)a.setPatternRowLoopStart(this.getCurrentPatternRowPosition());else{if(a.getPatternRowLoopCounter()<=0)a.setPatternRowLoopCounter(b);else{a.decPatternRowLoopCounter();if(a.getPatternRowLoopCounter()<=0)break}this.bPatternBreak=true;this.iPatternBreakToRow=a.getPatternRowLoopStart();this.iSequencePositionJump=this.getCurrentSequencePosition()}break;case weasel.FormatProTrackerMK.Effects.SetTremoloWaveform:c=
0;switch(b&3){case weasel.Channel.prototype.ProtrackerTremoloWaveform.SineWave:c=weasel.Channel.prototype.ProtrackerTremoloWaveform.SineWave;break;case weasel.Channel.prototype.ProtrackerTremoloWaveform.RampDownSawTooth:c=weasel.Channel.prototype.ProtrackerTremoloWaveform.RampDownSawTooth;break;default:c=weasel.Channel.prototype.ProtrackerTremoloWaveform.Square}a.setProtrackerContinueTremoloWaveform((b&4)!=0?true:false);a.setProtrackerTremoloWaveformType(c);break;case weasel.FormatProTrackerMK.Effects.RetriggerNote:if(0==
a.getCurrentPatternCell().getNotePeriod()&&a.retriggerNote(0,b,this.WaitForDMAToStop()*this.fWaitForDMAMultiplier))this.fWaitForDMAMultiplier=this.fWaitForDMAMultiplier+2;break;case weasel.FormatProTrackerMK.Effects.FineVolumeSlideUp:b=a.getShadowVolume()+b;b>64&&(b=64);a.setVolume(b);break;case weasel.FormatProTrackerMK.Effects.FineVolumeSlideDown:b=a.getShadowVolume()-b;b<0&&(b=0);a.setVolume(b);break;case weasel.FormatProTrackerMK.Effects.NoteCut:this.getCurrentTick()==b&&a.setVolume(0);break;
case weasel.FormatProTrackerMK.Effects.PatternDelay:if(this.iRowDelay==0){this.bProtrackerRowDelayQuirk=true;this.iRowDelay=b+1}break;case weasel.FormatProTrackerMK.Effects.InvertLoop:a.setProtrackerInvertLoopSpeed(b);a.updateProtrackerInvertLoop()}};
weasel.ProTrackerMK.prototype._exceptionPreprocessEffects=function(a,b){var c=a.getEffectNumber(),d=a.getEffectParameter();switch(c){case weasel.FormatNoiseTracker11.Effects.TonePortamento:case weasel.FormatNoiseTracker20.Effects.TonePortamentoAndVolumeSlide:a.setNotePortamentoTarget(b);return true;case weasel.FormatProTrackerMK.Effects.SetSampleOffset:c=d;0==c?c=a.getLastSampleOffsetParameter():a.setLastSampleOffsetParameter(c);c=this.bProtracker3SampleOffsetMode?c<<8:a.playFromOffset()+(c<<8);a.setPlayFromOffset(c);
break;case weasel.FormatProTrackerMK.Effects.ExtendedCommands:c=a.getEffectParameter()&15;d=a.getEffectParameter()&240;if(weasel.FormatProTrackerMK.Effects.SetFineTune==d)a.setFineTune(c);else if(weasel.FormatProTrackerMK.Effects.NoteDelay==d){a.setDelayedNotePeriod(b);if(this.getCurrentTick()==c&&b!=0){this.startPendingSample(a,a.getDelayedNotePeriod(),this.WaitForDMAToStop()*this.fWaitForDMAMultiplier);this.fWaitForDMAMultiplier=this.fWaitForDMAMultiplier+2}return true}}return false};
weasel.ProTrackerMK.prototype._fineTune=function(a,b){var c=a.getFineTune();if(0==c)return b;c<0?c=0:c>15&&(c=15);for(var d=weasel.FormatProTrackerMK.FineTunePeriodTables,e=0;e<36;e++)if(b>=d[e])break;return b=d[c*37+e]};
weasel.ProTrackerMK.prototype._applyPatternCell=function(a,b){var c=b.getEffectNumber(),d=b.getEffectParameter(),e=b.getInstrumentNumber();a.setEffectNumber(c);a.setEffectParameter(d);a.setCurrentPatternCell(b);this.aVisitedSequence[this.getCurrentSequencePosition()][this.getCurrentPatternRowPosition()]=true;if(e>0){var f=this.getInstrument(e);a.setPendingInstrumentNumber(e,f);this._applyVolumeImmediately(a);a.setPlayFromOffset(0);a.setFineTune(f.getFineTuning())}e=b.getNotePeriod();if(0!=e){e=this._fineTune(a,
e);if(!this._exceptionPreprocessEffects(a,e)){weasel.FormatProTrackerMK.Effects.ExtendedCommands==c&&weasel.FormatProTrackerMK.Effects.SetFineTune==(d&240)&&(e=this._fineTune(a,b.getNotePeriod()));a.getProtrackerContinueVibratoWaveform()||a.setVibratoTablePosition(0);a.getProtrackerContinueTremoloWaveform()||a.setTremoloTablePosition(0);if(a.getNotePeriod()>=1374&&this.bDontStopDMAQuirk){a.setNotePeriod(e);a.setLastSavedNotePeriod(e);a.setShadowNotePeriod(e)}else{this.startPendingSample(a,e,this.WaitForDMAToStop()*
this.fWaitForDMAMultiplier);a.setNoNoteDelayQuirk(true)}}}};weasel.ProTrackerMK.prototype._songSequenceChange=function(){for(var a=this.aSoundChannels.length;--a>=0;)if(this.aSoundChannels[a].getPatternRowLoopCounter()>0)return;var a=this.getCurrentSequencePosition(),b=this.getCurrentPatternRowPosition();if(true==this.aVisitedSequence[a][b])this.bSongEnded=true;this.aVisitedSequence[a][b]=true;this.iTotalPatternTicks=0};
weasel.ProTrackerMK.prototype.clearVisitedSequenceTable=function(){if(void 0!=this.aVisitedSequence[0])for(var a=this.aVisitedSequence,b=a.length;--b>=0;)for(var c=a[b],d=c.length;--d>=0;)c[d]=false};weasel.ProTrackerMK.prototype.timingOverride=function(a){var b=this.getTimingOverride();this.parent.prototype.timingOverride.call(this,a);a=this.getTimingOverride();b!=a&&(b==this.TimingOverrides.UseBPM||a==this.TimingOverrides.UseBPM)&&this._computeSequenceTableTicks()};
weasel.ProTrackerMK.prototype.WaitForDMAToStop=function(){return this.bProtracker3SampleOffsetMode?0:weasel.FormatNoiseTracker11.WaitForDMAToStop};void 0==window.weasel&&(window.weasel={});
weasel.FSTModule=function(a,b,c){this.parent=weasel.ProTrackerMK;if(a!==void 0&&(a instanceof Array||window.Uint8Array&&a instanceof Uint8Array)){this.iNumberOfChannels=4;this.iNumberOfChannels=-1!=weasel.Helper.searchArrayForString(a,weasel.FormatSpreadpointSoundTracker23.MKFingerPrint+1,weasel.FormatSpreadpointSoundTracker23.MKFingerPrint+4,"CHN")?weasel.Helper.getByte(a,weasel.FormatSpreadpointSoundTracker23.MKFingerPrint)-48:(weasel.Helper.getByte(a,weasel.FormatSpreadpointSoundTracker23.MKFingerPrint)-
48)*10+(weasel.Helper.getByte(a,weasel.FormatSpreadpointSoundTracker23.MKFingerPrint+1)-48);this.bNoiseTrackerLoopQuirk=false;this.bFSTClearSampleOffsetAfterUse=true;this.parent(a,b,c);this.setProtracker3SampleOffsetMode(true);this.setProtrackerTremoloSawtoothBugMode(true);this.bDontStopDMAQuirk=false;this.sModuleType=weasel.ModuleSniffer.prototype.SupportedModules.FSTModule}};weasel.FSTModule.prototype=new weasel.ProTrackerMK;weasel.FSTModule.prototype.getNumberOfChannels=function(){return this.iNumberOfChannels};
weasel.FSTModule.prototype.getPatternSizeInBytes=function(){return this.getNumberOfChannels()*weasel.FormatUltimateSoundTracker121.BytesPerRowCell*weasel.FormatUltimateSoundTracker121.NumberOfRowsPerPattern};weasel.FSTModule.prototype._clampNotePeriod=function(a){return a>4064?4064:a<28?28:a};
weasel.FSTModule.prototype._fineTune=function(a,b){var c=a.getFineTune();if(0==c)return b;if(0==b)return 0;c<0?c=0:c>15&&(c=15);c>7&&(c=-16+c);b=Math.round(b*Math.pow(2,-c/12/8));c=weasel.FormatFSTModule.FSTPeriodTable;b<c[c.length-1]&&(b=c[c.length-1]);b>c[0]&&(b=c[0]);return b};weasel.FSTModule.prototype.calcFineTune=function(a,b){return this._fineTune(a,b)};
weasel.FSTModule.prototype._processChannelTick0Effect=function(a){var b=a.getEffectParameter();switch(a.getEffectNumber()){case weasel.FormatFSTModule.Effects.Panning:this.getFSTPanningMode()&&(b=b*2);a.setPanningPosition(b);break;case weasel.FormatDOCSoundTracker22.Effects.SequencePositionJump:this.bPatternBreak=true;this.iPatternBreakToRow=0;this.iSequencePositionJump=b;break;case weasel.FormatDOCSoundTracker9.Effects.Volume:b>64&&(b=64);a.setVolume(b);break;case weasel.FormatDOCSoundTracker22.Effects.PatternBreak:a=
(b>>>4)*10+(b&15);a>63&&(a=0);this.bPatternBreak=true;this.iPatternBreakToRow=a;break;case weasel.FormatProTrackerMK.Effects.ExtendedCommands:this._processChannelTick0ExtendedEffect(a);break;case weasel.FormatDOCSoundTracker9.Effects.TickSpeed:this.getTimingOverride()==this.TimingOverrides.UseBPM?b<32?this.setTickSpeed(b):this.setSongSpeed(b):b>0&&this.setTickSpeed(b);break;default:a.setNotePeriod(a.getShadowNotePeriod())}};
weasel.FSTModule.prototype._processChannelTick0ExtendedEffect=function(a){var b=a.getEffectParameter()&15;switch(a.getEffectParameter()&240){case weasel.FormatProTrackerMK.Effects.FineSlideUp:if(this.iRowDelay==0){a.pitchBend(1,0,b);a.setShadowNotePeriod(this._clampNotePeriod(a.getShadowNotePeriod()));a.setNotePeriod(a.getShadowNotePeriod())}break;case weasel.FormatProTrackerMK.Effects.FineSlideDown:if(this.iRowDelay==0){a.pitchBend(1,b,0);a.setShadowNotePeriod(this._clampNotePeriod(a.getShadowNotePeriod()));
a.setNotePeriod(a.getShadowNotePeriod())}break;case weasel.FormatProTrackerMK.Effects.GlissandoControl:a.setGlissando(b!=0);break;case weasel.FormatProTrackerMK.Effects.SetVibratoWaveform:var c=0;switch(b&3){case weasel.Channel.prototype.ProtrackerVibratoWaveform.SineWave:c=weasel.Channel.prototype.ProtrackerVibratoWaveform.SineWave;break;case weasel.Channel.prototype.ProtrackerVibratoWaveform.RampDownSawTooth:c=weasel.Channel.prototype.ProtrackerVibratoWaveform.RampDownSawTooth;break;default:c=weasel.Channel.prototype.ProtrackerVibratoWaveform.Square}a.setProtrackerContinueVibratoWaveform((b&
4)!=0?true:false);a.setProtrackerVibratoWaveformType(c);break;case weasel.FormatProTrackerMK.Effects.PatternLoop:if(0==b)a.setPatternRowLoopStart(this.getCurrentPatternRowPosition());else{if(a.getPatternRowLoopCounter()<=0)a.setPatternRowLoopCounter(b);else{a.decPatternRowLoopCounter();if(a.getPatternRowLoopCounter()<=0)break}this.bPatternBreak=true;this.iPatternBreakToRow=a.getPatternRowLoopStart();this.iSequencePositionJump=this.getCurrentSequencePosition()}break;case weasel.FormatProTrackerMK.Effects.SetTremoloWaveform:c=
0;switch(b&3){case weasel.Channel.prototype.ProtrackerTremoloWaveform.SineWave:c=weasel.Channel.prototype.ProtrackerTremoloWaveform.SineWave;break;case weasel.Channel.prototype.ProtrackerTremoloWaveform.RampDownSawTooth:c=weasel.Channel.prototype.ProtrackerTremoloWaveform.RampDownSawTooth;break;default:c=weasel.Channel.prototype.ProtrackerTremoloWaveform.Square}a.setProtrackerContinueTremoloWaveform((b&4)!=0?true:false);a.setProtrackerTremoloWaveformType(c);break;case weasel.FormatFSTModule.Effects.CoarsePanning:a.setPanningPosition(b*
(256/15)|0);break;case weasel.FormatProTrackerMK.Effects.RetriggerNote:0==a.getCurrentPatternCell().getNotePeriod()&&a.retriggerNote(0,b,0);break;case weasel.FormatProTrackerMK.Effects.FineVolumeSlideUp:if(this.iRowDelay==0){b=a.getShadowVolume()+b;b>64&&(b=64);a.setVolume(b)}break;case weasel.FormatProTrackerMK.Effects.FineVolumeSlideDown:if(this.iRowDelay==0){b=a.getShadowVolume()-b;b<0&&(b=0);a.setVolume(b)}break;case weasel.FormatProTrackerMK.Effects.NoteCut:this.getCurrentTick()==b&&a.setVolume(0);
break;case weasel.FormatProTrackerMK.Effects.PatternDelay:if(this.iRowDelay==0){this.bProtrackerRowDelayQuirk=true;this.iRowDelay=b+1}break;case weasel.FormatProTrackerMK.Effects.InvertLoop:a.setProtrackerInvertLoopSpeed(b);a.updateProtrackerInvertLoop()}};weasel.FSTModule.prototype._arpeggio=function(a){a.getEffectParameter()==0?a.setNotePeriod(a.getShadowNotePeriod()):a.arpeggio(this.iCurrentTick,weasel.Channel.prototype.ArpeggioMode.FSTModule)};
weasel.FSTModule.prototype.getNoteFromPeriod=function(a){return a<28||a>6848?"???":a in weasel.FormatFSTModule.NoteTable?weasel.FormatFSTModule.NoteTable[a]:"???"};
weasel.FSTModule.prototype.play=function(a,b,c){var b=a.samplesToFill(),d=this.getNumberOfChannels(),e=this.getChannel(0),f=e.getCircularAudioBuffer().length;void 0!==c&&c<b&&c>=0&&(b=c);for(e.getCircularBufferPosition();b>0;){c=this.iSamplesRemaining;c>b&&(c=b);for(var g=e.getCircularBufferPosition(),h=0;h<d;h++)this.getChannel(h).make(c);var i=(e.getCircularBufferPosition()+f-g)%f;a.clear(i);for(h=0;h<d;h++)a.mixIn(i,this.getChannel(h).getCircularAudioBuffer(),g,this.getChannel(h).getPanningPosition());
a.SupportedMixerTypes.RLM$D_Fat==a.getMixerType()?a.clipRLMDFat(i):a.clip(i);this.iSamplesRemaining=this.iSamplesRemaining-c;b=b-c;if(this.iSamplesRemaining<=0){this.processPattern();this.iSamplesRemaining=this.iSamplesPerTick}}};void 0==window.weasel&&(window.weasel={});
weasel.BrowserAudio=function(a,b){this.iPlaybackFrequency=a;this.iIntervalMsRate=b;this.iSamplesPerInterval=0;this.iSoundChannels=2;this.iAudioType=0;this.bPause=true;this.iAudioSubSystemLag=this.iGlobalOverrideInterpolation=0;this.fPreBufferingInMS=270;this.oAudioBuffer=this.oAudio=null;this.iAudioBufferSizeDivider=5;this.oAudioNode=this.oAudioContext=null;this.iAudioContextBufferSize=4096;this.lProfileInMS=this.lAudioContextUsageMS=this.lOldPlayedSamples=0;this.oModule=null;this.__setSamplesPerInterval();
this.oBase64Stream=null;this.aHTML5AudioObjects=Array(2);this.iNextHTML5AudioObject=0;this.bNastyHackForHTMLAudioInFirefox3=false;this.iSyncHTML5AudioTimeBase=weasel.Helper.getHighRezTimer();this.lHTML5AudioUsageMS=this.iSyncHTML5AudioTimeDelta=0;this.iHTML5AudioPushTimerID=null;this.fHTML5AudioPushTimerInSeconds=2;this.bIgnoreFilter=this.bHTML5LowFidelityMode=true;this.__sniffAudioSupport()};weasel.BrowserAudio.prototype.AudioType={None:0,HTML5Audio:1,Mozilla:2,AudioContext:3};
weasel.BrowserAudio.prototype.getSupportedBrowserAudioTypes=function(){return weasel.BrowserAudio.prototype.AudioType};weasel.BrowserAudio.prototype.__setSamplesPerInterval=function(){this.iSamplesPerInterval=this.iPlaybackFrequency/(1E3/this.iIntervalMsRate)|0};weasel.BrowserAudio.prototype.getAudioType=function(){return this.iAudioType};weasel.BrowserAudio.prototype.getPlaybackFrequency=function(){return this.iPlaybackFrequency};weasel.BrowserAudio.prototype.getNumberOfSoundChannels=function(){return this.iSoundChannels};
weasel.BrowserAudio.prototype.getIntervalRate=function(){return this.iIntervalMsRate};weasel.BrowserAudio.prototype.getSamplesPerInterval=function(){return this.iSamplesPerInterval};weasel.BrowserAudio.prototype.getAudioSubSystemLag=function(){return this.iAudioSubSystemLag};weasel.BrowserAudio.prototype.getPreBufferingInMS=function(){return this.fPreBufferingInMS};
weasel.BrowserAudio.prototype.setPreBufferingInMS=function(a){a>1E3&&(a=1E3);a<0&&(a=0);if(weasel.BrowserAudio.prototype.AudioType.AudioContext==this.iAudioType){for(var a=this.iPlaybackFrequency/1E3*a/2,b=256;a>b&&b<16384;)b=b+b;if(b!=this.iAudioContextBufferSize){this.iAudioContextBufferSize=b;this.__createAudioContextHooks()}a=this.iAudioContextBufferSize*2/this.iPlaybackFrequency*1E3}this.fPreBufferingInMS=a|0};weasel.BrowserAudio.prototype.getAudioBuffer=function(){return this.oAudioBuffer};
weasel.BrowserAudio.prototype.getProfileInMS=function(){var a=this.lProfileInMS;0==a&&a++;var b=this.getAudioType();if(b==weasel.BrowserAudio.prototype.AudioType.AudioContext){a=a+this.lAudioContextUsageMS;this.lAudioContextUsageMS=0}else if(b==weasel.BrowserAudio.prototype.AudioType.HTML5Audio){a=a+this.lHTML5AudioUsageMS;this.lHTML5AudioUsageMS=0}return a};weasel.BrowserAudio.prototype.getModule=function(){return this.oModule};
weasel.BrowserAudio.prototype.setModule=function(a){if(a instanceof weasel.UltimateSoundTracker121||a instanceof weasel.UltimateSoundTracker18||a instanceof weasel.DOCSoundTracker9||a instanceof weasel.DOCSoundTracker22||a instanceof weasel.TJCSoundTracker2||a instanceof weasel.DefJamSoundTracker3||a instanceof weasel.SpreadpointSoundTracker23||a instanceof weasel.NoiseTracker11||a instanceof weasel.NoiseTracker20||a instanceof weasel.ProTrackerMK||a instanceof weasel.FSTModule){var b=this.oModule;
this.oModule=a;this.getAudioBuffer().clearAudioBuffers();this.setInterpolation(this.iGlobalOverrideInterpolation);b&&a.setMasterVolume(b.getMasterVolume());this.iPlaybackFrequency!=a.getPlaybackFrequency()&&a.changePlaybackFrequency(this.iPlaybackFrequency)}else this.oModule=null};weasel.BrowserAudio.prototype.__getUserAgent=function(){return window.navigator.userAgent};
weasel.BrowserAudio.prototype.__sniffAudioSupport=function(){this.iAudioType=weasel.BrowserAudio.prototype.AudioType.None;if(window.webkitAudioContext&&!window.AudioContext)window.AudioContext=window.webkitAudioContext;if(window.AudioContext){if(!window.AudioContext.createScriptProcessor)window.AudioContext.createScriptProcessor=window.AudioContext.createJavaScriptNode;this.iAudioType=weasel.BrowserAudio.prototype.AudioType.AudioContext}else if(window.Audio){var a=new Audio;if(a.mozSetup&&a.mozCurrentSampleOffset&&
a.mozWriteAudio){this.iAudioType=weasel.BrowserAudio.prototype.AudioType.Mozilla;this.oAudio=a}else{this.iAudioType=weasel.BrowserAudio.prototype.AudioType.HTML5Audio;a=this.__getUserAgent();if(-1!=a.search(/(gecko|midori|epiphany)/i)&&(-1==a.search(/(webkit|khtml|opera)+/i)||-1!=a.search(/(midori|epiphany)+/i)))this.bNastyHackForHTMLAudioInFirefox3=true}}};
weasel.BrowserAudio.prototype.init=function(){switch(this.iAudioType){case weasel.BrowserAudio.prototype.AudioType.AudioContext:this.__createAudioContextHooks();break;case weasel.BrowserAudio.prototype.AudioType.Mozilla:this.__createMozillaAudioHooks();break;case weasel.BrowserAudio.prototype.AudioType.HTML5Audio:this.__createHTML5AudioHooks();break;case weasel.BrowserAudio.prototype.AudioType.None:this.__createNoneAudioHooks()}};
weasel.BrowserAudio.prototype.stop=function(){this.bPause=true;switch(this.iAudioType){case weasel.BrowserAudio.prototype.AudioType.AudioContext:this.oAudioNode&&this.oAudioNode.disconnect();break;case weasel.BrowserAudio.prototype.AudioType.HTML5Audio:this.aHTML5AudioObjects[this.iNextHTML5AudioObject+1&1].pause();if(null!=this.iHTML5AudioPushTimerID){clearInterval(this.iHTML5AudioPushTimerID);this.iHTML5AudioPushTimerID=null}}};
weasel.BrowserAudio.prototype.start=function(){this.bPause=false;switch(this.iAudioType){case weasel.BrowserAudio.prototype.AudioType.AudioContext:this.oAudioNode&&this.oAudioNode.connect(this.oAudioContext.destination);break;case weasel.BrowserAudio.prototype.AudioType.HTML5Audio:this.iSyncHTML5AudioTimeBase=weasel.Helper.getHighRezTimer();this.iSyncHTML5AudioTimeDelta=0;this.aHTML5AudioObjects[this.iNextHTML5AudioObject+1&1].play();if(null==this.iHTML5AudioPushTimerID){var a=this;this.iHTML5AudioPushTimerID=
setInterval(function(){a.__pushAudioToHTML5()},this.fHTML5AudioPushTimerInSeconds*1E3)}}};weasel.BrowserAudio.prototype.__createNoneAudioHooks=function(){this.oAudioBuffer=new weasel.AudioBuffer(this.iPlaybackFrequency,this.iSoundChannels,this.iSamplesPerInterval)};
weasel.BrowserAudio.prototype.__createHTML5AudioHooks=function(){this.oAudioBuffer=new weasel.AudioBuffer(this.iPlaybackFrequency,this.iSoundChannels,this.iPlaybackFrequency*this.fHTML5AudioPushTimerInSeconds);var a=16,b=this.iSoundChannels;if(this.bHTML5LowFidelityMode){a=8;b=1}a=this.__createWaveFileHeader(this.iPlaybackFrequency,b,a,this.iPlaybackFrequency*this.fHTML5AudioPushTimerInSeconds);this.aHTML5AudioObjects[0]=new Audio;this.aHTML5AudioObjects[1]=new Audio;this.oBase64Stream=new weasel.Base64Stream;
this.oBase64Stream.prepend("data:audio/wav;base64,");for(var b=a.length,c=0;c<b;c++)this.oBase64Stream.appendByte(a[c]);this.oBase64Stream.save();this.iAudioSubSystemLag=this.iPlaybackFrequency*this.fHTML5AudioPushTimerInSeconds|0};
weasel.BrowserAudio.prototype.__createWaveFileHeader=function(a,b,c,d){var e=a*b*c/8|0,f=b*c/8|0,d=d*b*c/8|0,g=d+36;return[82,73,70,70].concat([g&255,g>>>8&255,g>>>16&255,g>>>24&255],[87,65,86,69],[102,109,116,32],[16,0,0,0],[1,0],[b&255,b>>>8&255],[a&255,a>>>8&255,a>>>16&255,a>>>24&255],[e&255,e>>>8&255,e>>>16&255,e>>>24&255],[f&255,f>>>8&255],[c&255,c>>>8&255],[100,97,116,97],[d&255,d>>>8&255,d>>>16&255,d>>>24&255])};
weasel.BrowserAudio.prototype.__disconnectAudioNode=function(){if(this.oAudioNode){this.oAudioNode.disconnect();this.oAudioNode.onaudioprocess=null}};
weasel.BrowserAudio.prototype.__createAudioContextHooks=function(){if(null==this.oAudioContext)this.oAudioContext=new AudioContext;this.__disconnectAudioNode();this.oAudioNode=null;this.oAudioNode=this.oAudioContext.createScriptProcessor(this.iAudioContextBufferSize,0,2);var a=this;this.oAudioNode.onaudioprocess=function(b){a.__audioContextFeeder(b,a)};this.bPause||this.oAudioNode.connect(this.oAudioContext.destination);this.iPlaybackFrequency=this.oAudioContext.sampleRate;this.__setSamplesPerInterval();
this.fPreBufferingInMS=this.iAudioContextBufferSize*2/this.iPlaybackFrequency*1E3|0;this.iAudioSubSystemLag=this.iPlaybackFrequency/1E3*this.fPreBufferingInMS|0;var b=this.oAudioBuffer;this.oAudioBuffer=new weasel.AudioBuffer(this.iPlaybackFrequency,this.iSoundChannels,this.oAudioNode.bufferSize);if(b){this.oAudioBuffer.setMixerType(b.getMixerType());this.oAudioBuffer.setIgnoreCircularBuffer(b.getIgnoreCircularBuffer())}};
weasel.BrowserAudio.prototype.__audioContextFeeder=function(a,b){var c=weasel.Helper.getHighRezTimer(),d=b.getAudioBuffer(),e=b.getModule(),f=a.outputBuffer.getChannelData(0),g=a.outputBuffer.getChannelData(1),h=d.getBuffer();if(null!=e)e.play(d,this.bIgnoreFilter);else for(e=h.length;--e>=0;)h[e]=0;for(var e=f.length,i=0,j=0;i<e;){f[i]=h[j++];g[i++]=h[j++]}d.removeSamples(d.getBufferLengthInSamples());d=weasel.Helper.getHighRezTimer();b.lAudioContextUsageMS=d-c};
weasel.BrowserAudio.prototype.__createMozillaAudioHooks=function(){this.oAudioBuffer=new weasel.AudioBuffer(this.iPlaybackFrequency,this.iSoundChannels,this.iSamplesPerInterval/this.iAudioBufferSizeDivider|0);this.oAudio.mozSetup(this.iSoundChannels,this.iPlaybackFrequency)};
weasel.BrowserAudio.prototype.changeReplayFrequency=function(a){var b=this.oAudioBuffer.getMixerType(),c=this.oAudioBuffer.getIgnoreCircularBuffer();if(this.iAudioType!=weasel.BrowserAudio.prototype.AudioType.AudioContext){this.iPlaybackFrequency=a;this.__setSamplesPerInterval()}switch(this.iAudioType){case weasel.BrowserAudio.prototype.AudioType.Mozilla:this.__createMozillaAudioHooks();break;case weasel.BrowserAudio.prototype.AudioType.HTML5Audio:this.__createHTML5AudioHooks();break;case weasel.BrowserAudio.prototype.AudioType.None:this.oAudioBuffer=
new weasel.AudioBuffer(this.iPlaybackFrequency,this.iSoundChannels,this.iSamplesPerInterval)}a=this.getModule();null!=a&&this.iAudioType!=weasel.BrowserAudio.prototype.AudioType.AudioContext&&a.changePlaybackFrequency(this.getPlaybackFrequency());this.oAudioBuffer.setMixerType(b);this.oAudioBuffer.setIgnoreCircularBuffer(c)};
weasel.BrowserAudio.prototype.__feedMozillaAudio=function(){var a=this.oAudioBuffer,b=this.oAudio,c=b.mozCurrentSampleOffset()/a.getSoundChannels()&1048575,d=a.getWrittenSamples()&1048575;d<c&&(d=d+1048576);this.iAudioSubSystemLag=d-c&1048575;var e=(this.iPlaybackFrequency/1E3*(this.fPreBufferingInMS+this.iIntervalMsRate)|0)+c-d;this.lOldPlayedSamples==c&&(e=this.iSamplesPerInterval*4);this.lOldPlayedSamples=c;c=e/a.getBufferLengthInSamples()|0;for(c<=0&&(c=this.iSamplesPerInterval*0.8/a.getBufferLengthInSamples()|
0);--c>=0;){var e=1,f=a.getBufferLengthInSamples();try{for(;f>0&&--e>=0;){var g=b.mozWriteAudio(a.getBuffer())/a.getSoundChannels()|0;a.removeSamples(g);this.getModule().play(a,this.bIgnoreFilter);f=f-g}}catch(h){}}return(a.getWrittenSamples()&1048575)+1048576-d&1048575};weasel.BrowserAudio.prototype.__feedAudioContext=function(){var a=this.iSamplesPerInterval,b=this.oAudioBuffer.samplesToFill();this.getModule().play(this.oAudioBuffer,this.bIgnoreFilter,a);return b-this.oAudioBuffer.samplesToFill()};
weasel.BrowserAudio.prototype.__feedNoneAudio=function(){var a=this.iSamplesPerInterval,b=this.oAudioBuffer.samplesToFill();this.getModule().play(this.oAudioBuffer,this.bIgnoreFilter,a);b=b-this.oAudioBuffer.samplesToFill();this.oAudioBuffer.removeSamples(b);return b};
weasel.BrowserAudio.prototype.__convertAudioTo8BitBase64WavFile=function(a,b){for(var c=0,d=0,e=a,f=this.oAudioBuffer.getBuffer(),g=this.oBase64Stream;e<b;){c=c<<8;c=c|(f[e++]+f[e++])*63.5+128&255;if(3==++d){g.appendTriple(c);d=c=0}}2==d?this.oBase64Stream.appendWord(c):1==d&&this.oBase64Stream.appendByte(c)};
weasel.BrowserAudio.prototype.__convertAudioTo16BitBase64WavFile=function(a,b){for(var c=a,d=this.oAudioBuffer.getBuffer(),e=this.oBase64Stream;c<b;){var f=d[c++]*32767|0;e.appendWord((f&255)<<8|f>>>8&255)}};
weasel.BrowserAudio.prototype.__dynamicallyMakeWavFile=function(a){var b=this.oAudioBuffer.getBufferPosition(),c=this.getModule();c&&c.play(this.oAudioBuffer,this.bIgnoreFilter,a);a=this.oAudioBuffer.getBufferPosition();this.bHTML5LowFidelityMode?this.__convertAudioTo8BitBase64WavFile(b,a):this.__convertAudioTo16BitBase64WavFile(b,a)};
weasel.BrowserAudio.prototype.__feedHTML5Audio=function(){var a=weasel.Helper.getHighRezTimer()-(this.iSyncHTML5AudioTimeBase+this.iSyncHTML5AudioTimeDelta),b=this.iSamplesPerInterval,c=this.oAudioBuffer.samplesToFill(),b=b+(b*(a/this.iIntervalMsRate)|0);b>this.iSamplesPerInterval*2&&(b=this.iSamplesPerInterval*2);b<0&&(b=0);this.iSyncHTML5AudioTimeDelta=this.iSyncHTML5AudioTimeDelta+(this.iIntervalMsRate*(b/this.iSamplesPerInterval)|0);this.__dynamicallyMakeWavFile(b);return c=c-this.oAudioBuffer.samplesToFill()};
weasel.BrowserAudio.prototype.__pushAudioToHTML5=function(){var a=weasel.Helper.getHighRezTimer();this.iSyncHTML5AudioTimeBase=a;this.iSyncHTML5AudioTimeDelta=0;this.__dynamicallyMakeWavFile(void 0);this.oAudioBuffer.removeSamples(this.oAudioBuffer.getBufferLengthInSamples());this.oBase64Stream.flush();this.aHTML5AudioObjects[this.iNextHTML5AudioObject].src=this.oBase64Stream.getBase64EncodedString();true==this.bNastyHackForHTMLAudioInFirefox3&&this.aHTML5AudioObjects[this.iNextHTML5AudioObject].load();
this.aHTML5AudioObjects[this.iNextHTML5AudioObject].play();this.iNextHTML5AudioObject=this.iNextHTML5AudioObject+1&1;this.oBase64Stream.load();this.lHTML5AudioUsageMS=weasel.Helper.getHighRezTimer()-a};
weasel.BrowserAudio.prototype.feedAudio=function(){var a=weasel.Helper.getHighRezTimer(),b=0;if(null==this.getModule()||this.bPause){this.lProfileInMS=weasel.Helper.getHighRezTimer()-a;return 0}switch(this.iAudioType){case weasel.BrowserAudio.prototype.AudioType.Mozilla:b=this.__feedMozillaAudio();break;case weasel.BrowserAudio.prototype.AudioType.AudioContext:b=this.__feedAudioContext();break;case weasel.BrowserAudio.prototype.AudioType.HTML5Audio:b=this.__feedHTML5Audio();break;case weasel.BrowserAudio.prototype.AudioType.None:b=
this.__feedNoneAudio()}this.lProfileInMS=weasel.Helper.getHighRezTimer()-a;return b};weasel.BrowserAudio.prototype.tradeLowerLatencyForSpeed=function(a){this.iAudioBufferSizeDivider=true==a?5:1;this.changeReplayFrequency(this.iPlaybackFrequency)};weasel.BrowserAudio.prototype.getTradeLowerLatencyForSpeed=function(){return this.iAudioBufferSizeDivider==1?false:true};
weasel.BrowserAudio.prototype.setHTML5LowFidelityMode=function(a){if(weasel.BrowserAudio.prototype.AudioType.HTML5Audio==this.getAudioType()){this.bHTML5LowFidelityMode=a==true?true:false;this.changeReplayFrequency(this.iPlaybackFrequency)}};weasel.BrowserAudio.prototype.getHTML5LowFidelityMode=function(){return this.bHTML5LowFidelityMode};
weasel.BrowserAudio.prototype.setInterpolation=function(a){var b=this.getModule();if(b)for(var c=b.getNumberOfChannels();--c>=0;)b.getChannel(c).setChannelInterpolation(a);this.iGlobalOverrideInterpolation=a};weasel.BrowserAudio.prototype.setIgnoreFilter=function(a){this.bIgnoreFilter=a==true?true:false};weasel.BrowserAudio.prototype.getIgnoreFilter=function(){return this.bIgnoreFilter};weasel.BrowserAudio.prototype.playing=function(){return!this.bPause};
